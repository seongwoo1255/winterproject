\doxysection{predict.\+Predictor Class Reference}
\hypertarget{classpredict_1_1_predictor}{}\label{classpredict_1_1_predictor}\index{predict.Predictor@{predict.Predictor}}


Inheritance diagram for predict.\+Predictor\+:
% FIG 0


Collaboration diagram for predict.\+Predictor\+:
% FIG 1
\doxysubsubsection*{Public Member Functions}
\begin{DoxyCompactItemize}
\item 
None \mbox{\hyperlink{classpredict_1_1_predictor_a18f2f3059716a784b8013347b88eb06c}{setup}} (self)
\item 
Concatenate\+Iterator\mbox{[}str\mbox{]} \mbox{\hyperlink{classpredict_1_1_predictor_afee23391898a50e155a267ec60d9a2db}{predict}} (self, Path image=Input(description="{}Input image"{}), str prompt=Input(description="{}Prompt to use for text generation"{}), float top\+\_\+p=Input(description="{}When decoding text, samples from the top p percentage of most likely tokens; lower to ignore less likely tokens"{}, ge=0.\+0, le=1.\+0, default=1.\+0), float temperature=Input(description="{}Adjusts randomness of outputs, greater than 1 is random and 0 is deterministic"{}, default=0.\+2, ge=0.\+0), int max\+\_\+tokens=Input(description="{}Maximum number of tokens to generate. A word is generally 2-\/3 tokens"{}, default=1024, ge=0))
\end{DoxyCompactItemize}
\doxysubsubsection*{Public Attributes}
\begin{DoxyCompactItemize}
\item 
\mbox{\hyperlink{classpredict_1_1_predictor_a4b54f002f57ce380993e2ec959468477}{tokenizer}}
\item 
\mbox{\hyperlink{classpredict_1_1_predictor_aac7b71571fe6c6cfcbf20682668c8ea7}{model}}
\item 
\mbox{\hyperlink{classpredict_1_1_predictor_a10184f05ea3e05f5097f0752d9d1a600}{image\+\_\+processor}}
\item 
\mbox{\hyperlink{classpredict_1_1_predictor_a2883fb06d91e1914ccc6e995a63caaac}{context\+\_\+len}} = load\+\_\+pretrained\+\_\+model("{}liuhaotian/llava-\/v1.\+5-\/13b"{}, model\+\_\+name="{}llava-\/v1.\+5-\/13b"{}, model\+\_\+base=None, load\+\_\+8bit=False, load\+\_\+4bit=False)
\end{DoxyCompactItemize}


\doxysubsection{Detailed Description}


Definition at line \mbox{\hyperlink{predict_8py_source_l00078}{78}} of file \mbox{\hyperlink{predict_8py_source}{predict.\+py}}.



\doxysubsection{Member Function Documentation}
\Hypertarget{classpredict_1_1_predictor_afee23391898a50e155a267ec60d9a2db}\index{predict.Predictor@{predict.Predictor}!predict@{predict}}
\index{predict@{predict}!predict.Predictor@{predict.Predictor}}
\doxysubsubsection{\texorpdfstring{predict()}{predict()}}
{\footnotesize\ttfamily \label{classpredict_1_1_predictor_afee23391898a50e155a267ec60d9a2db} 
 Concatenate\+Iterator\mbox{[}str\mbox{]} predict.\+Predictor.\+predict (\begin{DoxyParamCaption}\item[{}]{self}{, }\item[{Path }]{image}{ = {\ttfamily Input(description="{}Input~image"{})}, }\item[{str }]{prompt}{ = {\ttfamily Input(description="{}Prompt~to~use~for~text~generation"{})}, }\item[{float }]{top\+\_\+p}{ = {\ttfamily Input(description="{}When~decoding~text,~samples~from~the~top~p~percentage~of~most~likely~tokens;~lower~to~ignore~less~likely~tokens"{},~ge=0.0,~le=1.0,~default=1.0)}, }\item[{float }]{temperature}{ = {\ttfamily Input(description="{}Adjusts~randomness~of~outputs,~greater~than~1~is~random~and~0~is~deterministic"{},~default=0.2,~ge=0.0)}, }\item[{int }]{max\+\_\+tokens}{ = {\ttfamily Input(description="{}Maximum~number~of~tokens~to~generate.~A~word~is~generally~2-\/3~tokens"{},~default=1024,~ge=0)}}\end{DoxyParamCaption})}

\begin{DoxyVerb}Run a single prediction on the model\end{DoxyVerb}
 

Definition at line \mbox{\hyperlink{predict_8py_source_l00087}{87}} of file \mbox{\hyperlink{predict_8py_source}{predict.\+py}}.


\begin{DoxyCode}{0}
\DoxyCodeLine{00094\ \ \ \ \ )\ -\/>\ ConcatenateIterator[str]:}
\DoxyCodeLine{00095\ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}"{}"{}Run\ a\ single\ prediction\ on\ the\ model"{}"{}"{}}}
\DoxyCodeLine{00096\ \ \ \ \ }
\DoxyCodeLine{00097\ \ \ \ \ \ \ \ \ conv\_mode\ =\ \textcolor{stringliteral}{"{}llava\_v1"{}}}
\DoxyCodeLine{00098\ \ \ \ \ \ \ \ \ conv\ =\ conv\_templates[conv\_mode].copy()}
\DoxyCodeLine{00099\ \ \ \ \ }
\DoxyCodeLine{00100\ \ \ \ \ \ \ \ \ image\_data\ =\ load\_image(str(image))}
\DoxyCodeLine{00101\ \ \ \ \ \ \ \ \ image\_tensor\ =\ self.image\_processor.preprocess(image\_data,\ return\_tensors=\textcolor{stringliteral}{'pt'})[\textcolor{stringliteral}{'pixel\_values'}].half().cuda()}
\DoxyCodeLine{00102\ \ \ \ \ }
\DoxyCodeLine{00103\ \ \ \ \ \ \ \ \ \textcolor{comment}{\#\ loop\ start}}
\DoxyCodeLine{00104\ \ \ \ \ }
\DoxyCodeLine{00105\ \ \ \ \ \ \ \ \ \textcolor{comment}{\#\ just\ one\ turn,\ always\ prepend\ image\ token}}
\DoxyCodeLine{00106\ \ \ \ \ \ \ \ \ inp\ =\ DEFAULT\_IMAGE\_TOKEN\ +\ \textcolor{stringliteral}{'\(\backslash\)n'}\ +\ prompt}
\DoxyCodeLine{00107\ \ \ \ \ \ \ \ \ conv.append\_message(conv.roles[0],\ inp)}
\DoxyCodeLine{00108\ }
\DoxyCodeLine{00109\ \ \ \ \ \ \ \ \ conv.append\_message(conv.roles[1],\ \textcolor{keywordtype}{None})}
\DoxyCodeLine{00110\ \ \ \ \ \ \ \ \ prompt\ =\ conv.get\_prompt()}
\DoxyCodeLine{00111\ \ \ \ \ }
\DoxyCodeLine{00112\ \ \ \ \ \ \ \ \ input\_ids\ =\ tokenizer\_image\_token(prompt,\ self.tokenizer,\ IMAGE\_TOKEN\_INDEX,\ return\_tensors=\textcolor{stringliteral}{'pt'}).unsqueeze(0).cuda()}
\DoxyCodeLine{00113\ \ \ \ \ \ \ \ \ stop\_str\ =\ conv.sep\ \textcolor{keywordflow}{if}\ conv.sep\_style\ !=\ SeparatorStyle.TWO\ \textcolor{keywordflow}{else}\ conv.sep2}
\DoxyCodeLine{00114\ \ \ \ \ \ \ \ \ keywords\ =\ [stop\_str]}
\DoxyCodeLine{00115\ \ \ \ \ \ \ \ \ streamer\ =\ TextIteratorStreamer(self.tokenizer,\ skip\_prompt=\textcolor{keyword}{True},\ timeout=20.0)}
\DoxyCodeLine{00116\ \ \ \ \ }
\DoxyCodeLine{00117\ \ \ \ \ \ \ \ \ \textcolor{keyword}{with}\ torch.inference\_mode():}
\DoxyCodeLine{00118\ \ \ \ \ \ \ \ \ \ \ \ \ thread\ =\ Thread(target=self.model.generate,\ kwargs=dict(}
\DoxyCodeLine{00119\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ inputs=input\_ids,}
\DoxyCodeLine{00120\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ images=image\_tensor,}
\DoxyCodeLine{00121\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ do\_sample=\textcolor{keyword}{True},}
\DoxyCodeLine{00122\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ temperature=temperature,}
\DoxyCodeLine{00123\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ top\_p=top\_p,}
\DoxyCodeLine{00124\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ max\_new\_tokens=max\_tokens,}
\DoxyCodeLine{00125\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ streamer=streamer,}
\DoxyCodeLine{00126\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ use\_cache=\textcolor{keyword}{True}))}
\DoxyCodeLine{00127\ \ \ \ \ \ \ \ \ \ \ \ \ thread.start()}
\DoxyCodeLine{00128\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{\#\ workaround:\ second-\/to-\/last\ token\ is\ always\ "{}\ "{}}}
\DoxyCodeLine{00129\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{\#\ but\ we\ want\ to\ keep\ it\ if\ it's\ not\ the\ second-\/to-\/last\ token}}
\DoxyCodeLine{00130\ \ \ \ \ \ \ \ \ \ \ \ \ prepend\_space\ =\ \textcolor{keyword}{False}}
\DoxyCodeLine{00131\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ new\_text\ \textcolor{keywordflow}{in}\ streamer:}
\DoxyCodeLine{00132\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ new\_text\ ==\ \textcolor{stringliteral}{"{}\ "{}}:}
\DoxyCodeLine{00133\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ prepend\_space\ =\ \textcolor{keyword}{True}}
\DoxyCodeLine{00134\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{continue}}
\DoxyCodeLine{00135\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ new\_text.endswith(stop\_str):}
\DoxyCodeLine{00136\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ new\_text\ =\ new\_text[:-\/len(stop\_str)].strip()}
\DoxyCodeLine{00137\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ prepend\_space\ =\ \textcolor{keyword}{False}}
\DoxyCodeLine{00138\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{elif}\ prepend\_space:}
\DoxyCodeLine{00139\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ new\_text\ =\ \textcolor{stringliteral}{"{}\ "{}}\ +\ new\_text}
\DoxyCodeLine{00140\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ prepend\_space\ =\ \textcolor{keyword}{False}}
\DoxyCodeLine{00141\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ len(new\_text):}
\DoxyCodeLine{00142\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{yield}\ new\_text}
\DoxyCodeLine{00143\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ prepend\_space:}
\DoxyCodeLine{00144\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{yield}\ \textcolor{stringliteral}{"{}\ "{}}}
\DoxyCodeLine{00145\ \ \ \ \ \ \ \ \ \ \ \ \ thread.join()}
\DoxyCodeLine{00146\ \ \ \ \ }
\DoxyCodeLine{00147\ }

\end{DoxyCode}
Here is the call graph for this function\+:
% FIG 2
\Hypertarget{classpredict_1_1_predictor_a18f2f3059716a784b8013347b88eb06c}\index{predict.Predictor@{predict.Predictor}!setup@{setup}}
\index{setup@{setup}!predict.Predictor@{predict.Predictor}}
\doxysubsubsection{\texorpdfstring{setup()}{setup()}}
{\footnotesize\ttfamily \label{classpredict_1_1_predictor_a18f2f3059716a784b8013347b88eb06c} 
 None predict.\+Predictor.\+setup (\begin{DoxyParamCaption}\item[{}]{self}{}\end{DoxyParamCaption})}

\begin{DoxyVerb}Load the model into memory to make running multiple predictions efficient\end{DoxyVerb}
 

Definition at line \mbox{\hyperlink{predict_8py_source_l00079}{79}} of file \mbox{\hyperlink{predict_8py_source}{predict.\+py}}.


\begin{DoxyCode}{0}
\DoxyCodeLine{00079\ \ \ \ \ \textcolor{keyword}{def\ }setup(self)\ -\/>\ None:}
\DoxyCodeLine{00080\ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}"{}"{}Load\ the\ model\ into\ memory\ to\ make\ running\ multiple\ predictions\ efficient"{}"{}"{}}}
\DoxyCodeLine{00081\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ weight\ \textcolor{keywordflow}{in}\ weights:}
\DoxyCodeLine{00082\ \ \ \ \ \ \ \ \ \ \ \ \ download\_weights(weight[\textcolor{stringliteral}{"{}src"{}}],\ weight[\textcolor{stringliteral}{"{}dest"{}}],\ weight[\textcolor{stringliteral}{"{}files"{}}])}
\DoxyCodeLine{00083\ \ \ \ \ \ \ \ \ disable\_torch\_init()}
\DoxyCodeLine{00084\ \ \ \ \ }
\DoxyCodeLine{00085\ \ \ \ \ \ \ \ \ self.tokenizer,\ self.model,\ self.image\_processor,\ self.context\_len\ =\ load\_pretrained\_model(\textcolor{stringliteral}{"{}liuhaotian/llava-\/v1.5-\/13b"{}},\ model\_name=\textcolor{stringliteral}{"{}llava-\/v1.5-\/13b"{}},\ model\_base=\textcolor{keywordtype}{None},\ load\_8bit=\textcolor{keyword}{False},\ load\_4bit=\textcolor{keyword}{False})}
\DoxyCodeLine{00086\ }

\end{DoxyCode}
Here is the call graph for this function\+:
% FIG 3


\doxysubsection{Member Data Documentation}
\Hypertarget{classpredict_1_1_predictor_a2883fb06d91e1914ccc6e995a63caaac}\index{predict.Predictor@{predict.Predictor}!context\_len@{context\_len}}
\index{context\_len@{context\_len}!predict.Predictor@{predict.Predictor}}
\doxysubsubsection{\texorpdfstring{context\_len}{context\_len}}
{\footnotesize\ttfamily \label{classpredict_1_1_predictor_a2883fb06d91e1914ccc6e995a63caaac} 
predict.\+Predictor.\+context\+\_\+len = load\+\_\+pretrained\+\_\+model("{}liuhaotian/llava-\/v1.\+5-\/13b"{}, model\+\_\+name="{}llava-\/v1.\+5-\/13b"{}, model\+\_\+base=None, load\+\_\+8bit=False, load\+\_\+4bit=False)}



Definition at line \mbox{\hyperlink{predict_8py_source_l00085}{85}} of file \mbox{\hyperlink{predict_8py_source}{predict.\+py}}.

\Hypertarget{classpredict_1_1_predictor_a10184f05ea3e05f5097f0752d9d1a600}\index{predict.Predictor@{predict.Predictor}!image\_processor@{image\_processor}}
\index{image\_processor@{image\_processor}!predict.Predictor@{predict.Predictor}}
\doxysubsubsection{\texorpdfstring{image\_processor}{image\_processor}}
{\footnotesize\ttfamily \label{classpredict_1_1_predictor_a10184f05ea3e05f5097f0752d9d1a600} 
predict.\+Predictor.\+image\+\_\+processor}



Definition at line \mbox{\hyperlink{predict_8py_source_l00085}{85}} of file \mbox{\hyperlink{predict_8py_source}{predict.\+py}}.

\Hypertarget{classpredict_1_1_predictor_aac7b71571fe6c6cfcbf20682668c8ea7}\index{predict.Predictor@{predict.Predictor}!model@{model}}
\index{model@{model}!predict.Predictor@{predict.Predictor}}
\doxysubsubsection{\texorpdfstring{model}{model}}
{\footnotesize\ttfamily \label{classpredict_1_1_predictor_aac7b71571fe6c6cfcbf20682668c8ea7} 
predict.\+Predictor.\+model}



Definition at line \mbox{\hyperlink{predict_8py_source_l00085}{85}} of file \mbox{\hyperlink{predict_8py_source}{predict.\+py}}.

\Hypertarget{classpredict_1_1_predictor_a4b54f002f57ce380993e2ec959468477}\index{predict.Predictor@{predict.Predictor}!tokenizer@{tokenizer}}
\index{tokenizer@{tokenizer}!predict.Predictor@{predict.Predictor}}
\doxysubsubsection{\texorpdfstring{tokenizer}{tokenizer}}
{\footnotesize\ttfamily \label{classpredict_1_1_predictor_a4b54f002f57ce380993e2ec959468477} 
predict.\+Predictor.\+tokenizer}



Definition at line \mbox{\hyperlink{predict_8py_source_l00085}{85}} of file \mbox{\hyperlink{predict_8py_source}{predict.\+py}}.



The documentation for this class was generated from the following file\+:\begin{DoxyCompactItemize}
\item 
\mbox{\hyperlink{predict_8py}{predict.\+py}}\end{DoxyCompactItemize}
