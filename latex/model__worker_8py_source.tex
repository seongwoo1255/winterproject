\doxysection{model\+\_\+worker.\+py}
\hypertarget{model__worker_8py_source}{}\label{model__worker_8py_source}\index{llava/serve/model\_worker.py@{llava/serve/model\_worker.py}}
\mbox{\hyperlink{model__worker_8py}{Go to the documentation of this file.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00001}\mbox{\hyperlink{namespacellava_1_1serve_1_1model__worker}{00001}}\ \textcolor{stringliteral}{"{}"{}"{}}}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00002}00002\ \textcolor{stringliteral}{A\ model\ worker\ executes\ the\ model.}}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00003}00003\ \textcolor{stringliteral}{"{}"{}"{}}}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00004}00004\ \textcolor{keyword}{import}\ argparse}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00005}00005\ \textcolor{keyword}{import}\ asyncio}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00006}00006\ \textcolor{keyword}{import}\ json}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00007}00007\ \textcolor{keyword}{import}\ time}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00008}00008\ \textcolor{keyword}{import}\ threading}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00009}00009\ \textcolor{keyword}{import}\ uuid}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00010}00010\ }
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00011}00011\ \textcolor{keyword}{from}\ fastapi\ \textcolor{keyword}{import}\ FastAPI,\ Request,\ BackgroundTasks}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00012}00012\ \textcolor{keyword}{from}\ fastapi.responses\ \textcolor{keyword}{import}\ StreamingResponse}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00013}00013\ \textcolor{keyword}{import}\ requests}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00014}00014\ \textcolor{keyword}{import}\ torch}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00015}00015\ \textcolor{keyword}{import}\ uvicorn}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00016}00016\ \textcolor{keyword}{from}\ functools\ \textcolor{keyword}{import}\ partial}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00017}00017\ }
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00018}00018\ \textcolor{keyword}{from}\ \mbox{\hyperlink{namespacellava_1_1constants}{llava.constants}}\ \textcolor{keyword}{import}\ WORKER\_HEART\_BEAT\_INTERVAL}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00019}00019\ \textcolor{keyword}{from}\ \mbox{\hyperlink{namespacellava_1_1utils}{llava.utils}}\ \textcolor{keyword}{import}\ (build\_logger,\ server\_error\_msg,}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00020}00020\ \ \ \ \ pretty\_print\_semaphore)}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00021}00021\ \textcolor{keyword}{from}\ \mbox{\hyperlink{namespacellava_1_1model_1_1builder}{llava.model.builder}}\ \textcolor{keyword}{import}\ load\_pretrained\_model}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00022}00022\ \textcolor{keyword}{from}\ \mbox{\hyperlink{namespacellava_1_1mm__utils}{llava.mm\_utils}}\ \textcolor{keyword}{import}\ process\_images,\ load\_image\_from\_base64,\ tokenizer\_image\_token}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00023}00023\ \textcolor{keyword}{from}\ \mbox{\hyperlink{namespacellava_1_1constants}{llava.constants}}\ \textcolor{keyword}{import}\ IMAGE\_TOKEN\_INDEX,\ DEFAULT\_IMAGE\_TOKEN,\ DEFAULT\_IM\_START\_TOKEN,\ DEFAULT\_IM\_END\_TOKEN}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00024}00024\ \textcolor{keyword}{from}\ transformers\ \textcolor{keyword}{import}\ TextIteratorStreamer}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00025}00025\ \textcolor{keyword}{from}\ threading\ \textcolor{keyword}{import}\ Thread}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00026}00026\ }
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00027}00027\ }
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00028}\mbox{\hyperlink{namespacellava_1_1serve_1_1model__worker_a07bb32c28a3eb325c073daf91cbb0852}{00028}}\ GB\ =\ 1\ <<\ 30}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00029}00029\ }
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00030}\mbox{\hyperlink{namespacellava_1_1serve_1_1model__worker_a259c0d86a77a2febc208afe34d0fc0b3}{00030}}\ worker\_id\ =\ \mbox{\hyperlink{namespacellava_1_1serve_1_1model__worker_a62b2e12bff13cdced20851b3e836f8d9}{str}}(uuid.uuid4())[:6]}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00031}\mbox{\hyperlink{namespacellava_1_1serve_1_1model__worker_aea6f8ffba3a07cfd8542887c1270348e}{00031}}\ logger\ =\ build\_logger(\textcolor{stringliteral}{"{}model\_worker"{}},\ f\textcolor{stringliteral}{"{}model\_worker\_\{worker\_id\}.log"{}})}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00032}\mbox{\hyperlink{namespacellava_1_1serve_1_1model__worker_a981fc0487417908ec6eb16a5248ec3f7}{00032}}\ global\_counter\ =\ 0}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00033}00033\ }
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00034}\mbox{\hyperlink{namespacellava_1_1serve_1_1model__worker_a33070c88b88062a56ed42a04e5e5fceb}{00034}}\ model\_semaphore\ =\ \textcolor{keywordtype}{None}}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00035}00035\ }
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00036}00036\ }
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00037}\mbox{\hyperlink{namespacellava_1_1serve_1_1model__worker_a1de6e80d65a33b6421b20fa8ef8cdfcd}{00037}}\ \textcolor{keyword}{def\ }\mbox{\hyperlink{namespacellava_1_1serve_1_1model__worker_a1de6e80d65a33b6421b20fa8ef8cdfcd}{heart\_beat\_worker}}(controller):}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00038}00038\ }
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00039}00039\ \ \ \ \ \textcolor{keywordflow}{while}\ \textcolor{keyword}{True}:}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00040}00040\ \ \ \ \ \ \ \ \ time.sleep(WORKER\_HEART\_BEAT\_INTERVAL)}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00041}00041\ \ \ \ \ \ \ \ \ controller.send\_heart\_beat()}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00042}00042\ }
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00043}00043\ }
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00044}\mbox{\hyperlink{classllava_1_1serve_1_1model__worker_1_1_model_worker}{00044}}\ \textcolor{keyword}{class\ }\mbox{\hyperlink{classllava_1_1serve_1_1model__worker_1_1_model_worker}{ModelWorker}}:}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00045}\mbox{\hyperlink{classllava_1_1serve_1_1model__worker_1_1_model_worker_a1b115fdfad03fc92ce0c95d4c6bc4bfc}{00045}}\ \ \ \ \ \textcolor{keyword}{def\ }\mbox{\hyperlink{classllava_1_1serve_1_1model__worker_1_1_model_worker_a1b115fdfad03fc92ce0c95d4c6bc4bfc}{\_\_init\_\_}}(self,\ controller\_addr,\ worker\_addr,}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00046}00046\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ worker\_id,\ no\_register,}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00047}00047\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ model\_path,\ model\_base,\ model\_name,}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00048}00048\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ load\_8bit,\ load\_4bit,\ device,\ use\_flash\_attn=False):}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00049}\mbox{\hyperlink{classllava_1_1serve_1_1model__worker_1_1_model_worker_aa2f72a48d78f37cf2c200da08aad32ce}{00049}}\ \ \ \ \ \ \ \ \ self.\mbox{\hyperlink{classllava_1_1serve_1_1model__worker_1_1_model_worker_aa2f72a48d78f37cf2c200da08aad32ce}{controller\_addr}}\ =\ controller\_addr}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00050}\mbox{\hyperlink{classllava_1_1serve_1_1model__worker_1_1_model_worker_ae85abe4b7272751cc2c07e7c66b4063c}{00050}}\ \ \ \ \ \ \ \ \ self.\mbox{\hyperlink{classllava_1_1serve_1_1model__worker_1_1_model_worker_ae85abe4b7272751cc2c07e7c66b4063c}{worker\_addr}}\ =\ worker\_addr}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00051}\mbox{\hyperlink{classllava_1_1serve_1_1model__worker_1_1_model_worker_acc0784b50a741dc17ef89a328a785730}{00051}}\ \ \ \ \ \ \ \ \ self.\mbox{\hyperlink{classllava_1_1serve_1_1model__worker_1_1_model_worker_acc0784b50a741dc17ef89a328a785730}{worker\_id}}\ =\ worker\_id}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00052}00052\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ model\_path.endswith(\textcolor{stringliteral}{"{}/"{}}):}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00053}00053\ \ \ \ \ \ \ \ \ \ \ \ \ model\_path\ =\ model\_path[:-\/1]}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00054}00054\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ model\_name\ \textcolor{keywordflow}{is}\ \textcolor{keywordtype}{None}:}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00055}00055\ \ \ \ \ \ \ \ \ \ \ \ \ model\_paths\ =\ model\_path.split(\textcolor{stringliteral}{"{}/"{}})}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00056}00056\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ model\_paths[-\/1].startswith(\textcolor{stringliteral}{'checkpoint-\/'}):}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00057}\mbox{\hyperlink{classllava_1_1serve_1_1model__worker_1_1_model_worker_a14cf65be402fe9cba636a14a2f144a61}{00057}}\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ self.\mbox{\hyperlink{classllava_1_1serve_1_1model__worker_1_1_model_worker_a14cf65be402fe9cba636a14a2f144a61}{model\_name}}\ =\ model\_paths[-\/2]\ +\ \textcolor{stringliteral}{"{}\_"{}}\ +\ model\_paths[-\/1]}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00058}00058\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{else}:}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00059}00059\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ self.\mbox{\hyperlink{classllava_1_1serve_1_1model__worker_1_1_model_worker_a14cf65be402fe9cba636a14a2f144a61}{model\_name}}\ =\ model\_paths[-\/1]}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00060}00060\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{else}:}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00061}00061\ \ \ \ \ \ \ \ \ \ \ \ \ self.\mbox{\hyperlink{classllava_1_1serve_1_1model__worker_1_1_model_worker_a14cf65be402fe9cba636a14a2f144a61}{model\_name}}\ =\ model\_name}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00062}00062\ }
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00063}\mbox{\hyperlink{classllava_1_1serve_1_1model__worker_1_1_model_worker_a1a7d3897360dc03dba60875e606ce8f4}{00063}}\ \ \ \ \ \ \ \ \ self.\mbox{\hyperlink{classllava_1_1serve_1_1model__worker_1_1_model_worker_a1a7d3897360dc03dba60875e606ce8f4}{device}}\ =\ device}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00064}00064\ \ \ \ \ \ \ \ \ logger.info(f\textcolor{stringliteral}{"{}Loading\ the\ model\ \{self.model\_name\}\ on\ worker\ \{worker\_id\}\ ..."{}})}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00065}\mbox{\hyperlink{classllava_1_1serve_1_1model__worker_1_1_model_worker_a7045ace0aab5f447d6a9377b21a2c636}{00065}}\ \ \ \ \ \ \ \ \ self.\mbox{\hyperlink{classllava_1_1serve_1_1model__worker_1_1_model_worker_a9b2d638e8fe9fd6e7f0c458430e19f6b}{tokenizer}},\ self.\mbox{\hyperlink{classllava_1_1serve_1_1model__worker_1_1_model_worker_a24f81df5d8ba7c41720a38f1e4fa9931}{model}},\ self.\mbox{\hyperlink{classllava_1_1serve_1_1model__worker_1_1_model_worker_a93a659c6246cac881f0fe51f5f4e656c}{image\_processor}},\ self.\mbox{\hyperlink{classllava_1_1serve_1_1model__worker_1_1_model_worker_a7045ace0aab5f447d6a9377b21a2c636}{context\_len}}\ =\ load\_pretrained\_model(}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00066}00066\ \ \ \ \ \ \ \ \ \ \ \ \ model\_path,\ model\_base,\ self.\mbox{\hyperlink{classllava_1_1serve_1_1model__worker_1_1_model_worker_a14cf65be402fe9cba636a14a2f144a61}{model\_name}},\ load\_8bit,\ load\_4bit,\ device=self.\mbox{\hyperlink{classllava_1_1serve_1_1model__worker_1_1_model_worker_a1a7d3897360dc03dba60875e606ce8f4}{device}},\ use\_flash\_attn=use\_flash\_attn)}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00067}\mbox{\hyperlink{classllava_1_1serve_1_1model__worker_1_1_model_worker_abc938054b4069abafc3835b489138964}{00067}}\ \ \ \ \ \ \ \ \ self.\mbox{\hyperlink{classllava_1_1serve_1_1model__worker_1_1_model_worker_abc938054b4069abafc3835b489138964}{is\_multimodal}}\ =\ \textcolor{stringliteral}{'llava'}\ \textcolor{keywordflow}{in}\ self.\mbox{\hyperlink{classllava_1_1serve_1_1model__worker_1_1_model_worker_a14cf65be402fe9cba636a14a2f144a61}{model\_name}}.lower()}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00068}00068\ }
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00069}00069\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ \textcolor{keywordflow}{not}\ no\_register:}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00070}00070\ \ \ \ \ \ \ \ \ \ \ \ \ self.\mbox{\hyperlink{classllava_1_1serve_1_1model__worker_1_1_model_worker_a936cd43aacce1d84b0a42f01aff23b02}{register\_to\_controller}}()}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00071}\mbox{\hyperlink{classllava_1_1serve_1_1model__worker_1_1_model_worker_a37f9baf2e94fc98ba7b8c44a9920fb9f}{00071}}\ \ \ \ \ \ \ \ \ \ \ \ \ self.\mbox{\hyperlink{classllava_1_1serve_1_1model__worker_1_1_model_worker_a37f9baf2e94fc98ba7b8c44a9920fb9f}{heart\_beat\_thread}}\ =\ threading.Thread(}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00072}00072\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ target=heart\_beat\_worker,\ args=(self,),\ daemon=\textcolor{keyword}{True})}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00073}00073\ \ \ \ \ \ \ \ \ \ \ \ \ self.\mbox{\hyperlink{classllava_1_1serve_1_1model__worker_1_1_model_worker_a37f9baf2e94fc98ba7b8c44a9920fb9f}{heart\_beat\_thread}}.start()}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00074}00074\ }
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00075}\mbox{\hyperlink{classllava_1_1serve_1_1model__worker_1_1_model_worker_a936cd43aacce1d84b0a42f01aff23b02}{00075}}\ \ \ \ \ \textcolor{keyword}{def\ }\mbox{\hyperlink{classllava_1_1serve_1_1model__worker_1_1_model_worker_a936cd43aacce1d84b0a42f01aff23b02}{register\_to\_controller}}(self):}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00076}00076\ \ \ \ \ \ \ \ \ logger.info(\textcolor{stringliteral}{"{}Register\ to\ controller"{}})}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00077}00077\ }
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00078}00078\ \ \ \ \ \ \ \ \ url\ =\ self.\mbox{\hyperlink{classllava_1_1serve_1_1model__worker_1_1_model_worker_aa2f72a48d78f37cf2c200da08aad32ce}{controller\_addr}}\ +\ \textcolor{stringliteral}{"{}/register\_worker"{}}}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00079}00079\ \ \ \ \ \ \ \ \ data\ =\ \{}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00080}00080\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}worker\_name"{}}:\ self.\mbox{\hyperlink{classllava_1_1serve_1_1model__worker_1_1_model_worker_ae85abe4b7272751cc2c07e7c66b4063c}{worker\_addr}},}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00081}00081\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}check\_heart\_beat"{}}:\ \textcolor{keyword}{True},}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00082}00082\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}worker\_status"{}}:\ self.\mbox{\hyperlink{classllava_1_1serve_1_1model__worker_1_1_model_worker_aec73328af30b9ffe05e2ee9aa5030d8f}{get\_status}}()}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00083}00083\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00084}00084\ \ \ \ \ \ \ \ \ r\ =\ requests.post(url,\ json=data)}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00085}00085\ \ \ \ \ \ \ \ \ \textcolor{keyword}{assert}\ r.status\_code\ ==\ 200}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00086}00086\ }
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00087}\mbox{\hyperlink{classllava_1_1serve_1_1model__worker_1_1_model_worker_ad5a095555d4c9bb8d5f4db7db559e69e}{00087}}\ \ \ \ \ \textcolor{keyword}{def\ }\mbox{\hyperlink{classllava_1_1serve_1_1model__worker_1_1_model_worker_ad5a095555d4c9bb8d5f4db7db559e69e}{send\_heart\_beat}}(self):}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00088}00088\ \ \ \ \ \ \ \ \ logger.info(f\textcolor{stringliteral}{"{}Send\ heart\ beat.\ Models:\ \{[self.model\_name]\}.\ "{}}}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00089}00089\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ f\textcolor{stringliteral}{"{}Semaphore:\ \{pretty\_print\_semaphore(model\_semaphore)\}.\ "{}}}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00090}00090\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ f\textcolor{stringliteral}{"{}global\_counter:\ \{global\_counter\}"{}})}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00091}00091\ }
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00092}00092\ \ \ \ \ \ \ \ \ url\ =\ self.\mbox{\hyperlink{classllava_1_1serve_1_1model__worker_1_1_model_worker_aa2f72a48d78f37cf2c200da08aad32ce}{controller\_addr}}\ +\ \textcolor{stringliteral}{"{}/receive\_heart\_beat"{}}}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00093}00093\ }
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00094}00094\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{while}\ \textcolor{keyword}{True}:}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00095}00095\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{try}:}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00096}00096\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ ret\ =\ requests.post(url,\ json=\{}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00097}00097\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}worker\_name"{}}:\ self.\mbox{\hyperlink{classllava_1_1serve_1_1model__worker_1_1_model_worker_ae85abe4b7272751cc2c07e7c66b4063c}{worker\_addr}},}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00098}00098\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}queue\_length"{}}:\ self.\mbox{\hyperlink{classllava_1_1serve_1_1model__worker_1_1_model_worker_aa6ffa9e99a5f24c78f0ffc9afb8b05d9}{get\_queue\_length}}()\},\ timeout=5)}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00099}00099\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ exist\ =\ ret.json()[\textcolor{stringliteral}{"{}exist"{}}]}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00100}00100\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{break}}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00101}00101\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{except}\ requests.exceptions.RequestException\ \textcolor{keyword}{as}\ e:}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00102}00102\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ logger.error(f\textcolor{stringliteral}{"{}heart\ beat\ error:\ \{e\}"{}})}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00103}00103\ \ \ \ \ \ \ \ \ \ \ \ \ time.sleep(5)}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00104}00104\ }
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00105}00105\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ \textcolor{keywordflow}{not}\ exist:}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00106}00106\ \ \ \ \ \ \ \ \ \ \ \ \ self.\mbox{\hyperlink{classllava_1_1serve_1_1model__worker_1_1_model_worker_a936cd43aacce1d84b0a42f01aff23b02}{register\_to\_controller}}()}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00107}00107\ }
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00108}\mbox{\hyperlink{classllava_1_1serve_1_1model__worker_1_1_model_worker_aa6ffa9e99a5f24c78f0ffc9afb8b05d9}{00108}}\ \ \ \ \ \textcolor{keyword}{def\ }\mbox{\hyperlink{classllava_1_1serve_1_1model__worker_1_1_model_worker_aa6ffa9e99a5f24c78f0ffc9afb8b05d9}{get\_queue\_length}}(self):}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00109}00109\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ model\_semaphore\ \textcolor{keywordflow}{is}\ \textcolor{keywordtype}{None}:}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00110}00110\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ 0}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00111}00111\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{else}:}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00112}00112\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ args.limit\_model\_concurrency\ -\/\ model\_semaphore.\_value\ +\ (len(}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00113}00113\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ model\_semaphore.\_waiters)\ \textcolor{keywordflow}{if}\ model\_semaphore.\_waiters\ \textcolor{keywordflow}{is}\ \textcolor{keywordflow}{not}\ \textcolor{keywordtype}{None}\ \textcolor{keywordflow}{else}\ 0)}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00114}00114\ }
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00115}\mbox{\hyperlink{classllava_1_1serve_1_1model__worker_1_1_model_worker_aec73328af30b9ffe05e2ee9aa5030d8f}{00115}}\ \ \ \ \ \textcolor{keyword}{def\ }\mbox{\hyperlink{classllava_1_1serve_1_1model__worker_1_1_model_worker_aec73328af30b9ffe05e2ee9aa5030d8f}{get\_status}}(self):}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00116}00116\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \{}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00117}00117\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}model\_names"{}}:\ [self.\mbox{\hyperlink{classllava_1_1serve_1_1model__worker_1_1_model_worker_a14cf65be402fe9cba636a14a2f144a61}{model\_name}}],}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00118}00118\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}speed"{}}:\ 1,}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00119}00119\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}queue\_length"{}}:\ self.\mbox{\hyperlink{classllava_1_1serve_1_1model__worker_1_1_model_worker_aa6ffa9e99a5f24c78f0ffc9afb8b05d9}{get\_queue\_length}}(),}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00120}00120\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00121}00121\ }
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00122}00122\ \ \ \ \ \textcolor{preprocessor}{@torch.inference\_mode()}}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00123}\mbox{\hyperlink{classllava_1_1serve_1_1model__worker_1_1_model_worker_aba14476dd32acd43fc05aaa5b324de7b}{00123}}\ \ \ \ \ \textcolor{keyword}{def\ }\mbox{\hyperlink{classllava_1_1serve_1_1model__worker_1_1_model_worker_aba14476dd32acd43fc05aaa5b324de7b}{generate\_stream}}(self,\ params):}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00124}00124\ \ \ \ \ \ \ \ \ tokenizer,\ model,\ image\_processor\ =\ self.\mbox{\hyperlink{classllava_1_1serve_1_1model__worker_1_1_model_worker_a9b2d638e8fe9fd6e7f0c458430e19f6b}{tokenizer}},\ self.\mbox{\hyperlink{classllava_1_1serve_1_1model__worker_1_1_model_worker_a24f81df5d8ba7c41720a38f1e4fa9931}{model}},\ self.\mbox{\hyperlink{classllava_1_1serve_1_1model__worker_1_1_model_worker_a93a659c6246cac881f0fe51f5f4e656c}{image\_processor}}}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00125}00125\ }
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00126}00126\ \ \ \ \ \ \ \ \ prompt\ =\ params[\textcolor{stringliteral}{"{}prompt"{}}]}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00127}00127\ \ \ \ \ \ \ \ \ ori\_prompt\ =\ prompt}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00128}00128\ \ \ \ \ \ \ \ \ images\ =\ params.get(\textcolor{stringliteral}{"{}images"{}},\ \textcolor{keywordtype}{None})}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00129}00129\ \ \ \ \ \ \ \ \ num\_image\_tokens\ =\ 0}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00130}00130\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ images\ \textcolor{keywordflow}{is}\ \textcolor{keywordflow}{not}\ \textcolor{keywordtype}{None}\ \textcolor{keywordflow}{and}\ len(images)\ >\ 0\ \textcolor{keywordflow}{and}\ self.\mbox{\hyperlink{classllava_1_1serve_1_1model__worker_1_1_model_worker_abc938054b4069abafc3835b489138964}{is\_multimodal}}:}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00131}00131\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ len(images)\ >\ 0:}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00132}00132\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ len(images)\ !=\ prompt.count(DEFAULT\_IMAGE\_TOKEN):}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00133}00133\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{raise}\ ValueError(\textcolor{stringliteral}{"{}Number\ of\ images\ does\ not\ match\ number\ of\ <image>\ tokens\ in\ prompt"{}})}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00134}00134\ }
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00135}00135\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ images\ =\ [load\_image\_from\_base64(image)\ \textcolor{keywordflow}{for}\ image\ \textcolor{keywordflow}{in}\ images]}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00136}00136\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ image\_sizes\ =\ [image.size\ \textcolor{keywordflow}{for}\ image\ \textcolor{keywordflow}{in}\ images]}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00137}00137\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ images\ =\ process\_images(images,\ image\_processor,\ model.config)}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00138}00138\ }
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00139}00139\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ \mbox{\hyperlink{namespacellava_1_1serve_1_1model__worker_ae56921c702c5b28d0e0824d644749841}{type}}(images)\ \textcolor{keywordflow}{is}\ list:}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00140}00140\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ images\ =\ [image.to(self.\mbox{\hyperlink{classllava_1_1serve_1_1model__worker_1_1_model_worker_a24f81df5d8ba7c41720a38f1e4fa9931}{model}}.device,\ dtype=torch.float16)\ \textcolor{keywordflow}{for}\ image\ \textcolor{keywordflow}{in}\ images]}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00141}00141\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{else}:}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00142}00142\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ images\ =\ images.to(self.\mbox{\hyperlink{classllava_1_1serve_1_1model__worker_1_1_model_worker_a24f81df5d8ba7c41720a38f1e4fa9931}{model}}.device,\ dtype=torch.float16)}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00143}00143\ }
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00144}00144\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ replace\_token\ =\ DEFAULT\_IMAGE\_TOKEN}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00145}00145\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ getattr(self.\mbox{\hyperlink{classllava_1_1serve_1_1model__worker_1_1_model_worker_a24f81df5d8ba7c41720a38f1e4fa9931}{model}}.config,\ \textcolor{stringliteral}{'mm\_use\_im\_start\_end'},\ \textcolor{keyword}{False}):}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00146}00146\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ replace\_token\ =\ DEFAULT\_IM\_START\_TOKEN\ +\ replace\_token\ +\ DEFAULT\_IM\_END\_TOKEN}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00147}00147\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ prompt\ =\ prompt.replace(DEFAULT\_IMAGE\_TOKEN,\ replace\_token)}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00148}00148\ }
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00149}00149\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ num\_image\_tokens\ =\ prompt.count(replace\_token)\ *\ model.get\_vision\_tower().num\_patches}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00150}00150\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{else}:}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00151}00151\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ images\ =\ \textcolor{keywordtype}{None}}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00152}00152\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ image\_sizes\ =\ \textcolor{keywordtype}{None}}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00153}00153\ \ \ \ \ \ \ \ \ \ \ \ \ image\_args\ =\ \{\textcolor{stringliteral}{"{}images"{}}:\ images,\ \textcolor{stringliteral}{"{}image\_sizes"{}}:\ image\_sizes\}}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00154}00154\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{else}:}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00155}00155\ \ \ \ \ \ \ \ \ \ \ \ \ images\ =\ \textcolor{keywordtype}{None}}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00156}00156\ \ \ \ \ \ \ \ \ \ \ \ \ image\_args\ =\ \{\}}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00157}00157\ }
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00158}00158\ \ \ \ \ \ \ \ \ temperature\ =\ float(params.get(\textcolor{stringliteral}{"{}temperature"{}},\ 1.0))}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00159}00159\ \ \ \ \ \ \ \ \ top\_p\ =\ float(params.get(\textcolor{stringliteral}{"{}top\_p"{}},\ 1.0))}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00160}00160\ \ \ \ \ \ \ \ \ max\_context\_length\ =\ getattr(model.config,\ \textcolor{stringliteral}{'max\_position\_embeddings'},\ 2048)}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00161}00161\ \ \ \ \ \ \ \ \ max\_new\_tokens\ =\ min(\mbox{\hyperlink{namespacellava_1_1serve_1_1model__worker_ad6fbdbffe80136c4ae6bb3c519b4306a}{int}}(params.get(\textcolor{stringliteral}{"{}max\_new\_tokens"{}},\ 256)),\ 1024)}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00162}00162\ \ \ \ \ \ \ \ \ stop\_str\ =\ params.get(\textcolor{stringliteral}{"{}stop"{}},\ \textcolor{keywordtype}{None})}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00163}00163\ \ \ \ \ \ \ \ \ do\_sample\ =\ \textcolor{keyword}{True}\ \textcolor{keywordflow}{if}\ temperature\ >\ 0.001\ \textcolor{keywordflow}{else}\ \textcolor{keyword}{False}}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00164}00164\ }
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00165}00165\ \ \ \ \ \ \ \ \ input\_ids\ =\ tokenizer\_image\_token(prompt,\ tokenizer,\ IMAGE\_TOKEN\_INDEX,\ return\_tensors=\textcolor{stringliteral}{'pt'}).unsqueeze(0).to(self.\mbox{\hyperlink{classllava_1_1serve_1_1model__worker_1_1_model_worker_a1a7d3897360dc03dba60875e606ce8f4}{device}})}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00166}00166\ \ \ \ \ \ \ \ \ keywords\ =\ [stop\_str]}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00167}00167\ \ \ \ \ \ \ \ \ \textcolor{comment}{\#\ stopping\_criteria\ =\ KeywordsStoppingCriteria(keywords,\ tokenizer,\ input\_ids)}}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00168}00168\ \ \ \ \ \ \ \ \ streamer\ =\ TextIteratorStreamer(tokenizer,\ skip\_prompt=\textcolor{keyword}{True},\ skip\_special\_tokens=\textcolor{keyword}{True},\ timeout=15)}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00169}00169\ }
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00170}00170\ \ \ \ \ \ \ \ \ max\_new\_tokens\ =\ min(max\_new\_tokens,\ max\_context\_length\ -\/\ input\_ids.shape[-\/1]\ -\/\ num\_image\_tokens)}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00171}00171\ }
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00172}00172\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ max\_new\_tokens\ <\ 1:}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00173}00173\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{yield}\ json.dumps(\{\textcolor{stringliteral}{"{}text"{}}:\ ori\_prompt\ +\ \textcolor{stringliteral}{"{}Exceeds\ max\ token\ length.\ Please\ start\ a\ new\ conversation,\ thanks."{}},\ \textcolor{stringliteral}{"{}error\_code"{}}:\ 0\}).encode()\ +\ b\textcolor{stringliteral}{"{}\(\backslash\)0"{}}}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00174}00174\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00175}00175\ }
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00176}00176\ \ \ \ \ \ \ \ \ thread\ =\ Thread(target=model.generate,\ kwargs=dict(}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00177}00177\ \ \ \ \ \ \ \ \ \ \ \ \ inputs=input\_ids,}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00178}00178\ \ \ \ \ \ \ \ \ \ \ \ \ do\_sample=do\_sample,}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00179}00179\ \ \ \ \ \ \ \ \ \ \ \ \ temperature=temperature,}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00180}00180\ \ \ \ \ \ \ \ \ \ \ \ \ top\_p=top\_p,}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00181}00181\ \ \ \ \ \ \ \ \ \ \ \ \ max\_new\_tokens=max\_new\_tokens,}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00182}00182\ \ \ \ \ \ \ \ \ \ \ \ \ streamer=streamer,}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00183}00183\ \ \ \ \ \ \ \ \ \ \ \ \ use\_cache=\textcolor{keyword}{True},}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00184}00184\ \ \ \ \ \ \ \ \ \ \ \ \ **image\_args}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00185}00185\ \ \ \ \ \ \ \ \ ))}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00186}00186\ \ \ \ \ \ \ \ \ thread.start()}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00187}00187\ }
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00188}00188\ \ \ \ \ \ \ \ \ generated\_text\ =\ ori\_prompt}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00189}00189\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ new\_text\ \textcolor{keywordflow}{in}\ streamer:}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00190}00190\ \ \ \ \ \ \ \ \ \ \ \ \ generated\_text\ +=\ new\_text}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00191}00191\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ generated\_text.endswith(stop\_str):}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00192}00192\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ generated\_text\ =\ generated\_text[:-\/len(stop\_str)]}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00193}00193\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{yield}\ json.dumps(\{\textcolor{stringliteral}{"{}text"{}}:\ generated\_text,\ \textcolor{stringliteral}{"{}error\_code"{}}:\ 0\}).encode()\ +\ b\textcolor{stringliteral}{"{}\(\backslash\)0"{}}}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00194}00194\ }
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00195}\mbox{\hyperlink{classllava_1_1serve_1_1model__worker_1_1_model_worker_adbda944f81e561a551d096b882d98940}{00195}}\ \ \ \ \ \textcolor{keyword}{def\ }\mbox{\hyperlink{classllava_1_1serve_1_1model__worker_1_1_model_worker_adbda944f81e561a551d096b882d98940}{generate\_stream\_gate}}(self,\ params):}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00196}00196\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{try}:}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00197}00197\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ x\ \textcolor{keywordflow}{in}\ self.\mbox{\hyperlink{classllava_1_1serve_1_1model__worker_1_1_model_worker_aba14476dd32acd43fc05aaa5b324de7b}{generate\_stream}}(params):}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00198}00198\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{yield}\ x}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00199}00199\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{except}\ ValueError\ \textcolor{keyword}{as}\ e:}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00200}00200\ \ \ \ \ \ \ \ \ \ \ \ \ print(\textcolor{stringliteral}{"{}Caught\ ValueError:"{}},\ e)}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00201}00201\ \ \ \ \ \ \ \ \ \ \ \ \ ret\ =\ \{}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00202}00202\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}text"{}}:\ server\_error\_msg,}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00203}00203\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}error\_code"{}}:\ 1,}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00204}00204\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00205}00205\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{yield}\ json.dumps(ret).encode()\ +\ b\textcolor{stringliteral}{"{}\(\backslash\)0"{}}}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00206}00206\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{except}\ torch.cuda.CudaError\ \textcolor{keyword}{as}\ e:}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00207}00207\ \ \ \ \ \ \ \ \ \ \ \ \ print(\textcolor{stringliteral}{"{}Caught\ torch.cuda.CudaError:"{}},\ e)}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00208}00208\ \ \ \ \ \ \ \ \ \ \ \ \ ret\ =\ \{}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00209}00209\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}text"{}}:\ server\_error\_msg,}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00210}00210\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}error\_code"{}}:\ 1,}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00211}00211\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00212}00212\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{yield}\ json.dumps(ret).encode()\ +\ b\textcolor{stringliteral}{"{}\(\backslash\)0"{}}}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00213}00213\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{except}\ Exception\ \textcolor{keyword}{as}\ e:}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00214}00214\ \ \ \ \ \ \ \ \ \ \ \ \ print(\textcolor{stringliteral}{"{}Caught\ Unknown\ Error"{}},\ e)}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00215}00215\ \ \ \ \ \ \ \ \ \ \ \ \ ret\ =\ \{}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00216}00216\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}text"{}}:\ server\_error\_msg,}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00217}00217\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}error\_code"{}}:\ 1,}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00218}00218\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00219}00219\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{yield}\ json.dumps(ret).encode()\ +\ b\textcolor{stringliteral}{"{}\(\backslash\)0"{}}}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00220}00220\ }
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00221}00221\ }
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00222}\mbox{\hyperlink{namespacellava_1_1serve_1_1model__worker_a00e5d91d9c215d8047d484c21cb135ad}{00222}}\ app\ =\ FastAPI()}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00223}00223\ }
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00224}00224\ }
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00225}\mbox{\hyperlink{namespacellava_1_1serve_1_1model__worker_ace5747c565490cd68e8687505f45cf7a}{00225}}\ \textcolor{keyword}{def\ }\mbox{\hyperlink{namespacellava_1_1serve_1_1model__worker_ace5747c565490cd68e8687505f45cf7a}{release\_model\_semaphore}}(fn=None):}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00226}00226\ \ \ \ \ model\_semaphore.release()}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00227}00227\ \ \ \ \ \textcolor{keywordflow}{if}\ fn\ \textcolor{keywordflow}{is}\ \textcolor{keywordflow}{not}\ \textcolor{keywordtype}{None}:}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00228}00228\ \ \ \ \ \ \ \ \ fn()}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00229}00229\ }
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00230}00230\ }
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00231}00231\ \textcolor{preprocessor}{@app.post("{}/worker\_generate\_stream"{})}}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00232}\mbox{\hyperlink{namespacellava_1_1serve_1_1model__worker_a4e33a63f15639b3b2cb2cdc13099d03b}{00232}}\ \textcolor{keyword}{async\ def\ }\mbox{\hyperlink{namespacellava_1_1serve_1_1model__worker_a4e33a63f15639b3b2cb2cdc13099d03b}{generate\_stream}}(request:\ Request):}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00233}00233\ \ \ \ \ \textcolor{keyword}{global}\ model\_semaphore,\ global\_counter}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00234}00234\ \ \ \ \ global\_counter\ +=\ 1}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00235}00235\ \ \ \ \ params\ =\ await\ request.json()}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00236}00236\ }
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00237}00237\ \ \ \ \ \textcolor{keywordflow}{if}\ model\_semaphore\ \textcolor{keywordflow}{is}\ \textcolor{keywordtype}{None}:}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00238}00238\ \ \ \ \ \ \ \ \ model\_semaphore\ =\ asyncio.Semaphore(args.limit\_model\_concurrency)}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00239}00239\ \ \ \ \ await\ model\_semaphore.acquire()}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00240}00240\ \ \ \ \ worker.send\_heart\_beat()}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00241}00241\ \ \ \ \ generator\ =\ worker.generate\_stream\_gate(params)}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00242}00242\ \ \ \ \ background\_tasks\ =\ BackgroundTasks()}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00243}00243\ \ \ \ \ background\_tasks.add\_task(partial(release\_model\_semaphore,\ fn=worker.send\_heart\_beat))}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00244}00244\ \ \ \ \ \textcolor{keywordflow}{return}\ StreamingResponse(generator,\ background=background\_tasks)}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00245}00245\ }
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00246}00246\ }
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00247}00247\ \textcolor{preprocessor}{@app.post("{}/worker\_get\_status"{})}}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00248}\mbox{\hyperlink{namespacellava_1_1serve_1_1model__worker_a27aa3289f3c75c7853caabe8351d53a6}{00248}}\ \textcolor{keyword}{async\ def\ }\mbox{\hyperlink{namespacellava_1_1serve_1_1model__worker_a27aa3289f3c75c7853caabe8351d53a6}{get\_status}}(request:\ Request):}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00249}00249\ \ \ \ \ \textcolor{keywordflow}{return}\ worker.get\_status()}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00250}00250\ }
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00251}00251\ }
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00252}00252\ \textcolor{keywordflow}{if}\ \_\_name\_\_\ ==\ \textcolor{stringliteral}{"{}\_\_main\_\_"{}}:}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00253}\mbox{\hyperlink{namespacellava_1_1serve_1_1model__worker_ad5b617a0e03037bad54be4b7002382b3}{00253}}\ \ \ \ \ parser\ =\ argparse.ArgumentParser()}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00254}\mbox{\hyperlink{namespacellava_1_1serve_1_1model__worker_ad16deb3fd4accc94f8a97e5bd725ce06}{00254}}\ \ \ \ \ parser.add\_argument(\textcolor{stringliteral}{"{}-\/-\/host"{}},\ type=str,\ default=\textcolor{stringliteral}{"{}localhost"{}})}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00255}\mbox{\hyperlink{namespacellava_1_1serve_1_1model__worker_ad6fbdbffe80136c4ae6bb3c519b4306a}{00255}}\ \ \ \ \ parser.add\_argument(\textcolor{stringliteral}{"{}-\/-\/port"{}},\ type=int,\ default=21002)}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00256}00256\ \ \ \ \ parser.add\_argument(\textcolor{stringliteral}{"{}-\/-\/worker-\/address"{}},\ type=str,}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00257}00257\ \ \ \ \ \ \ \ \ default=\textcolor{stringliteral}{"{}http://localhost:21002"{}})}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00258}00258\ \ \ \ \ parser.add\_argument(\textcolor{stringliteral}{"{}-\/-\/controller-\/address"{}},\ type=str,}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00259}00259\ \ \ \ \ \ \ \ \ default=\textcolor{stringliteral}{"{}http://localhost:21001"{}})}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00260}00260\ \ \ \ \ parser.add\_argument(\textcolor{stringliteral}{"{}-\/-\/model-\/path"{}},\ type=str,\ default=\textcolor{stringliteral}{"{}facebook/opt-\/350m"{}})}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00261}00261\ \ \ \ \ parser.add\_argument(\textcolor{stringliteral}{"{}-\/-\/model-\/base"{}},\ type=str,\ default=\textcolor{keywordtype}{None})}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00262}00262\ \ \ \ \ parser.add\_argument(\textcolor{stringliteral}{"{}-\/-\/model-\/name"{}},\ type=str)}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00263}00263\ \ \ \ \ parser.add\_argument(\textcolor{stringliteral}{"{}-\/-\/device"{}},\ type=str,\ default=\textcolor{stringliteral}{"{}cuda"{}})}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00264}\mbox{\hyperlink{namespacellava_1_1serve_1_1model__worker_afd9f6f3a86a3fbd98bf28603e3944ebe}{00264}}\ \ \ \ \ parser.add\_argument(\textcolor{stringliteral}{"{}-\/-\/multi-\/modal"{}},\ action=\textcolor{stringliteral}{"{}store\_true"{}},\ help=\textcolor{stringliteral}{"{}Multimodal\ mode\ is\ automatically\ detected\ with\ model\ name,\ please\ make\ sure\ \`{}llava`\ is\ included\ in\ the\ model\ path."{}})}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00265}00265\ \ \ \ \ parser.add\_argument(\textcolor{stringliteral}{"{}-\/-\/limit-\/model-\/concurrency"{}},\ type=int,\ default=5)}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00266}00266\ \ \ \ \ parser.add\_argument(\textcolor{stringliteral}{"{}-\/-\/stream-\/interval"{}},\ type=int,\ default=1)}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00267}00267\ \ \ \ \ parser.add\_argument(\textcolor{stringliteral}{"{}-\/-\/no-\/register"{}},\ action=\textcolor{stringliteral}{"{}store\_true"{}})}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00268}00268\ \ \ \ \ parser.add\_argument(\textcolor{stringliteral}{"{}-\/-\/load-\/8bit"{}},\ action=\textcolor{stringliteral}{"{}store\_true"{}})}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00269}00269\ \ \ \ \ parser.add\_argument(\textcolor{stringliteral}{"{}-\/-\/load-\/4bit"{}},\ action=\textcolor{stringliteral}{"{}store\_true"{}})}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00270}00270\ \ \ \ \ parser.add\_argument(\textcolor{stringliteral}{"{}-\/-\/use-\/flash-\/attn"{}},\ action=\textcolor{stringliteral}{"{}store\_true"{}})}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00271}\mbox{\hyperlink{namespacellava_1_1serve_1_1model__worker_ad5ce0240327160b16b522c7d4169fb44}{00271}}\ \ \ \ \ args\ =\ parser.parse\_args()}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00272}00272\ \ \ \ \ logger.info(f\textcolor{stringliteral}{"{}args:\ \{args\}"{}})}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00273}00273\ }
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00274}00274\ \ \ \ \ \textcolor{keywordflow}{if}\ args.multi\_modal:}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00275}00275\ \ \ \ \ \ \ \ \ logger.warning(\textcolor{stringliteral}{"{}Multimodal\ mode\ is\ automatically\ detected\ with\ model\ name,\ please\ make\ sure\ \`{}llava`\ is\ included\ in\ the\ model\ path."{}})}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00276}00276\ }
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00277}\mbox{\hyperlink{namespacellava_1_1serve_1_1model__worker_aa2ecc5722c409bc92a107b7015bff1e7}{00277}}\ \ \ \ \ worker\ =\ \mbox{\hyperlink{classllava_1_1serve_1_1model__worker_1_1_model_worker}{ModelWorker}}(args.controller\_address,}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00278}00278\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ args.worker\_address,}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00279}00279\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ worker\_id,}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00280}00280\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ args.no\_register,}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00281}00281\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ args.model\_path,}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00282}00282\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ args.model\_base,}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00283}00283\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ args.model\_name,}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00284}00284\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ args.load\_8bit,}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00285}00285\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ args.load\_4bit,}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00286}00286\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ args.device,}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00287}00287\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ use\_flash\_attn=args.use\_flash\_attn)}
\DoxyCodeLine{\Hypertarget{model__worker_8py_source_l00288}\mbox{\hyperlink{namespacellava_1_1serve_1_1model__worker_ae7e09478f0ad5ec33a43d6ca14b7ddbe}{00288}}\ \ \ \ \ uvicorn.run(app,\ host=args.host,\ port=args.port,\ log\_level=\textcolor{stringliteral}{"{}info"{}})}

\end{DoxyCode}
