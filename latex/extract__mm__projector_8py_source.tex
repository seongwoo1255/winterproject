\doxysection{extract\+\_\+mm\+\_\+projector.\+py}
\hypertarget{extract__mm__projector_8py_source}{}\label{extract__mm__projector_8py_source}\index{scripts/extract\_mm\_projector.py@{scripts/extract\_mm\_projector.py}}
\mbox{\hyperlink{extract__mm__projector_8py}{Go to the documentation of this file.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{\Hypertarget{extract__mm__projector_8py_source_l00001}\mbox{\hyperlink{namespaceextract__mm__projector}{00001}}\ \textcolor{stringliteral}{"{}"{}"{}}}
\DoxyCodeLine{\Hypertarget{extract__mm__projector_8py_source_l00002}00002\ \textcolor{stringliteral}{This\ is\ just\ a\ utility\ that\ I\ use\ to\ extract\ the\ projector\ for\ quantized\ models.}}
\DoxyCodeLine{\Hypertarget{extract__mm__projector_8py_source_l00003}00003\ \textcolor{stringliteral}{It\ is\ NOT\ necessary\ at\ all\ to\ train,\ or\ run\ inference/serve\ demos.}}
\DoxyCodeLine{\Hypertarget{extract__mm__projector_8py_source_l00004}00004\ \textcolor{stringliteral}{Use\ this\ script\ ONLY\ if\ you\ fully\ understand\ its\ implications.}}
\DoxyCodeLine{\Hypertarget{extract__mm__projector_8py_source_l00005}00005\ \textcolor{stringliteral}{"{}"{}"{}}}
\DoxyCodeLine{\Hypertarget{extract__mm__projector_8py_source_l00006}00006\ }
\DoxyCodeLine{\Hypertarget{extract__mm__projector_8py_source_l00007}00007\ }
\DoxyCodeLine{\Hypertarget{extract__mm__projector_8py_source_l00008}00008\ \textcolor{keyword}{import}\ os}
\DoxyCodeLine{\Hypertarget{extract__mm__projector_8py_source_l00009}00009\ \textcolor{keyword}{import}\ argparse}
\DoxyCodeLine{\Hypertarget{extract__mm__projector_8py_source_l00010}00010\ \textcolor{keyword}{import}\ torch}
\DoxyCodeLine{\Hypertarget{extract__mm__projector_8py_source_l00011}00011\ \textcolor{keyword}{import}\ json}
\DoxyCodeLine{\Hypertarget{extract__mm__projector_8py_source_l00012}00012\ \textcolor{keyword}{from}\ collections\ \textcolor{keyword}{import}\ defaultdict}
\DoxyCodeLine{\Hypertarget{extract__mm__projector_8py_source_l00013}00013\ }
\DoxyCodeLine{\Hypertarget{extract__mm__projector_8py_source_l00014}00014\ }
\DoxyCodeLine{\Hypertarget{extract__mm__projector_8py_source_l00015}\mbox{\hyperlink{namespaceextract__mm__projector_a215dd54aa1ae8d25012b6c9410f28cc4}{00015}}\ \textcolor{keyword}{def\ }\mbox{\hyperlink{namespaceextract__mm__projector_a215dd54aa1ae8d25012b6c9410f28cc4}{parse\_args}}():}
\DoxyCodeLine{\Hypertarget{extract__mm__projector_8py_source_l00016}00016\ \ \ \ \ parser\ =\ argparse.ArgumentParser(description=\textcolor{stringliteral}{'Extract\ MMProjector\ weights'})}
\DoxyCodeLine{\Hypertarget{extract__mm__projector_8py_source_l00017}00017\ \ \ \ \ parser.add\_argument(\textcolor{stringliteral}{'-\/-\/model-\/path'},\ type=str,\ help=\textcolor{stringliteral}{'model\ folder'})}
\DoxyCodeLine{\Hypertarget{extract__mm__projector_8py_source_l00018}00018\ \ \ \ \ parser.add\_argument(\textcolor{stringliteral}{'-\/-\/output'},\ type=str,\ help=\textcolor{stringliteral}{'output\ file'})}
\DoxyCodeLine{\Hypertarget{extract__mm__projector_8py_source_l00019}00019\ \ \ \ \ args\ =\ parser.parse\_args()}
\DoxyCodeLine{\Hypertarget{extract__mm__projector_8py_source_l00020}00020\ \ \ \ \ \textcolor{keywordflow}{return}\ args}
\DoxyCodeLine{\Hypertarget{extract__mm__projector_8py_source_l00021}00021\ }
\DoxyCodeLine{\Hypertarget{extract__mm__projector_8py_source_l00022}00022\ }
\DoxyCodeLine{\Hypertarget{extract__mm__projector_8py_source_l00023}00023\ \textcolor{keywordflow}{if}\ \_\_name\_\_\ ==\ \textcolor{stringliteral}{'\_\_main\_\_'}:}
\DoxyCodeLine{\Hypertarget{extract__mm__projector_8py_source_l00024}\mbox{\hyperlink{namespaceextract__mm__projector_a266fac3974378dbcb7a064531d1d5faa}{00024}}\ \ \ \ \ args\ =\ \mbox{\hyperlink{namespaceextract__mm__projector_a215dd54aa1ae8d25012b6c9410f28cc4}{parse\_args}}()}
\DoxyCodeLine{\Hypertarget{extract__mm__projector_8py_source_l00025}00025\ }
\DoxyCodeLine{\Hypertarget{extract__mm__projector_8py_source_l00026}\mbox{\hyperlink{namespaceextract__mm__projector_a03fd68062ff9f1c13f5f0a5d045b7f40}{00026}}\ \ \ \ \ keys\_to\_match\ =\ [\textcolor{stringliteral}{'mm\_projector'}]}
\DoxyCodeLine{\Hypertarget{extract__mm__projector_8py_source_l00027}\mbox{\hyperlink{namespaceextract__mm__projector_ad57b43c48fdf88565945a7c6db51147b}{00027}}\ \ \ \ \ ckpt\_to\_key\ =\ defaultdict(list)}
\DoxyCodeLine{\Hypertarget{extract__mm__projector_8py_source_l00028}00028\ \ \ \ \ \textcolor{keywordflow}{try}:}
\DoxyCodeLine{\Hypertarget{extract__mm__projector_8py_source_l00029}\mbox{\hyperlink{namespaceextract__mm__projector_a26ae4911a9eb45ceccb04093981bf7a0}{00029}}\ \ \ \ \ \ \ \ \ model\_indices\ =\ json.load(open(os.path.join(args.model\_path,\ \textcolor{stringliteral}{'pytorch\_model.bin.index.json'})))}
\DoxyCodeLine{\Hypertarget{extract__mm__projector_8py_source_l00030}00030\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ k,\ v\ \textcolor{keywordflow}{in}\ model\_indices[\textcolor{stringliteral}{'weight\_map'}].items():}
\DoxyCodeLine{\Hypertarget{extract__mm__projector_8py_source_l00031}00031\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ any(key\_match\ \textcolor{keywordflow}{in}\ k\ \textcolor{keywordflow}{for}\ key\_match\ \textcolor{keywordflow}{in}\ keys\_to\_match):}
\DoxyCodeLine{\Hypertarget{extract__mm__projector_8py_source_l00032}00032\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ ckpt\_to\_key[v].append(k)}
\DoxyCodeLine{\Hypertarget{extract__mm__projector_8py_source_l00033}00033\ \ \ \ \ \textcolor{keywordflow}{except}\ FileNotFoundError:}
\DoxyCodeLine{\Hypertarget{extract__mm__projector_8py_source_l00034}00034\ \ \ \ \ \ \ \ \ \textcolor{comment}{\#\ Smaller\ models\ or\ model\ checkpoints\ saved\ by\ DeepSpeed.}}
\DoxyCodeLine{\Hypertarget{extract__mm__projector_8py_source_l00035}\mbox{\hyperlink{namespaceextract__mm__projector_a2e30138c44c9868642e07ea1aca087f1}{00035}}\ \ \ \ \ \ \ \ \ v\ =\ \textcolor{stringliteral}{'pytorch\_model.bin'}}
\DoxyCodeLine{\Hypertarget{extract__mm__projector_8py_source_l00036}\mbox{\hyperlink{namespaceextract__mm__projector_ac70624ace4b94fba7d1b30821616a240}{00036}}\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ k\ \textcolor{keywordflow}{in}\ torch.load(os.path.join(args.model\_path,\ v),\ map\_location=\textcolor{stringliteral}{'cpu'}).keys():}
\DoxyCodeLine{\Hypertarget{extract__mm__projector_8py_source_l00037}00037\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ any(key\_match\ \textcolor{keywordflow}{in}\ k\ \textcolor{keywordflow}{for}\ key\_match\ \textcolor{keywordflow}{in}\ keys\_to\_match):}
\DoxyCodeLine{\Hypertarget{extract__mm__projector_8py_source_l00038}00038\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ ckpt\_to\_key[v].append(k)}
\DoxyCodeLine{\Hypertarget{extract__mm__projector_8py_source_l00039}00039\ }
\DoxyCodeLine{\Hypertarget{extract__mm__projector_8py_source_l00040}\mbox{\hyperlink{namespaceextract__mm__projector_a25dd7a2db299b71b3211523925afafe1}{00040}}\ \ \ \ \ loaded\_weights\ =\ \{\}}
\DoxyCodeLine{\Hypertarget{extract__mm__projector_8py_source_l00041}00041\ }
\DoxyCodeLine{\Hypertarget{extract__mm__projector_8py_source_l00042}00042\ \ \ \ \ \textcolor{keywordflow}{for}\ ckpt\_name,\ weight\_keys\ \textcolor{keywordflow}{in}\ ckpt\_to\_key.items():}
\DoxyCodeLine{\Hypertarget{extract__mm__projector_8py_source_l00043}\mbox{\hyperlink{namespaceextract__mm__projector_a54452b844058e75df00c04f9fb08f5ab}{00043}}\ \ \ \ \ \ \ \ \ ckpt\ =\ torch.load(os.path.join(args.model\_path,\ ckpt\_name),\ map\_location=\textcolor{stringliteral}{'cpu'})}
\DoxyCodeLine{\Hypertarget{extract__mm__projector_8py_source_l00044}00044\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ k\ \textcolor{keywordflow}{in}\ weight\_keys:}
\DoxyCodeLine{\Hypertarget{extract__mm__projector_8py_source_l00045}00045\ \ \ \ \ \ \ \ \ \ \ \ \ loaded\_weights[k]\ =\ ckpt[k]}
\DoxyCodeLine{\Hypertarget{extract__mm__projector_8py_source_l00046}00046\ }
\DoxyCodeLine{\Hypertarget{extract__mm__projector_8py_source_l00047}00047\ \ \ \ \ torch.save(loaded\_weights,\ args.output)}

\end{DoxyCode}
