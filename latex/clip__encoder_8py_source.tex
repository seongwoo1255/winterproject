\doxysection{clip\+\_\+encoder.\+py}
\hypertarget{clip__encoder_8py_source}{}\label{clip__encoder_8py_source}\index{multimodal\_encoder/clip\_encoder.py@{multimodal\_encoder/clip\_encoder.py}}
\mbox{\hyperlink{clip__encoder_8py}{Go to the documentation of this file.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{\Hypertarget{clip__encoder_8py_source_l00001}\mbox{\hyperlink{namespaceclip__encoder}{00001}}\ }
\DoxyCodeLine{\Hypertarget{clip__encoder_8py_source_l00007}00007\ \textcolor{keyword}{import}\ torch}
\DoxyCodeLine{\Hypertarget{clip__encoder_8py_source_l00008}00008\ \textcolor{keyword}{import}\ torch.nn\ \textcolor{keyword}{as}\ nn}
\DoxyCodeLine{\Hypertarget{clip__encoder_8py_source_l00009}00009\ \textcolor{keyword}{from}\ transformers\ \textcolor{keyword}{import}\ CLIPVisionModel,\ CLIPImageProcessor,\ CLIPVisionConfig}
\DoxyCodeLine{\Hypertarget{clip__encoder_8py_source_l00010}00010\ }
\DoxyCodeLine{\Hypertarget{clip__encoder_8py_source_l00011}00011\ }
\DoxyCodeLine{\Hypertarget{clip__encoder_8py_source_l00016}\mbox{\hyperlink{classclip__encoder_1_1_c_l_i_p_vision_tower}{00016}}\ \textcolor{keyword}{class\ }\mbox{\hyperlink{classclip__encoder_1_1_c_l_i_p_vision_tower}{CLIPVisionTower}}(nn.Module):}
\DoxyCodeLine{\Hypertarget{clip__encoder_8py_source_l00017}00017\ \ \ \ \ }
\DoxyCodeLine{\Hypertarget{clip__encoder_8py_source_l00024}\mbox{\hyperlink{classclip__encoder_1_1_c_l_i_p_vision_tower_ab417172fe5f55c98266ef38e2e129813}{00024}}\ \ \ \ \ \textcolor{keyword}{def\ }\mbox{\hyperlink{classclip__encoder_1_1_c_l_i_p_vision_tower_ab417172fe5f55c98266ef38e2e129813}{\_\_init\_\_}}(self,\ vision\_tower,\ args,\ delay\_load=False):}
\DoxyCodeLine{\Hypertarget{clip__encoder_8py_source_l00025}00025\ \ \ \ \ \ \ \ \ super().\mbox{\hyperlink{classclip__encoder_1_1_c_l_i_p_vision_tower_ab417172fe5f55c98266ef38e2e129813}{\_\_init\_\_}}()}
\DoxyCodeLine{\Hypertarget{clip__encoder_8py_source_l00026}\mbox{\hyperlink{classclip__encoder_1_1_c_l_i_p_vision_tower_a552d4feb8810234513afe88accf44ae6}{00026}}\ \ \ \ \ \ \ \ \ self.\mbox{\hyperlink{classclip__encoder_1_1_c_l_i_p_vision_tower_a552d4feb8810234513afe88accf44ae6}{is\_loaded}}\ =\ \textcolor{keyword}{False}}
\DoxyCodeLine{\Hypertarget{clip__encoder_8py_source_l00027}\mbox{\hyperlink{classclip__encoder_1_1_c_l_i_p_vision_tower_a3562cdd2057289eb65db9ae09da0cdf4}{00027}}\ \ \ \ \ \ \ \ \ self.\mbox{\hyperlink{classclip__encoder_1_1_c_l_i_p_vision_tower_a3562cdd2057289eb65db9ae09da0cdf4}{vision\_tower\_name}}\ =\ vision\_tower}
\DoxyCodeLine{\Hypertarget{clip__encoder_8py_source_l00028}\mbox{\hyperlink{classclip__encoder_1_1_c_l_i_p_vision_tower_adacaade876d2fdee8347d37d566f59d8}{00028}}\ \ \ \ \ \ \ \ \ self.\mbox{\hyperlink{classclip__encoder_1_1_c_l_i_p_vision_tower_adacaade876d2fdee8347d37d566f59d8}{select\_layer}}\ =\ args.mm\_vision\_select\_layer}
\DoxyCodeLine{\Hypertarget{clip__encoder_8py_source_l00029}\mbox{\hyperlink{classclip__encoder_1_1_c_l_i_p_vision_tower_a074db3e083df3ae421a3d5451cd99122}{00029}}\ \ \ \ \ \ \ \ \ self.\mbox{\hyperlink{classclip__encoder_1_1_c_l_i_p_vision_tower_a074db3e083df3ae421a3d5451cd99122}{select\_feature}}\ =\ getattr(args,\ \textcolor{stringliteral}{'mm\_vision\_select\_feature'},\ \textcolor{stringliteral}{'patch'})}
\DoxyCodeLine{\Hypertarget{clip__encoder_8py_source_l00030}00030\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ \textcolor{keywordflow}{not}\ delay\_load:}
\DoxyCodeLine{\Hypertarget{clip__encoder_8py_source_l00031}00031\ \ \ \ \ \ \ \ \ \ \ \ \ self.\mbox{\hyperlink{classclip__encoder_1_1_c_l_i_p_vision_tower_a2502311ae705712e6ef9e5e65e2807d2}{load\_model}}()}
\DoxyCodeLine{\Hypertarget{clip__encoder_8py_source_l00032}00032\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{elif}\ getattr(args,\ \textcolor{stringliteral}{'unfreeze\_mm\_vision\_tower'},\ \textcolor{keyword}{False}):}
\DoxyCodeLine{\Hypertarget{clip__encoder_8py_source_l00033}00033\ \ \ \ \ \ \ \ \ \ \ \ \ self.\mbox{\hyperlink{classclip__encoder_1_1_c_l_i_p_vision_tower_a2502311ae705712e6ef9e5e65e2807d2}{load\_model}}()}
\DoxyCodeLine{\Hypertarget{clip__encoder_8py_source_l00034}00034\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{else}:}
\DoxyCodeLine{\Hypertarget{clip__encoder_8py_source_l00035}\mbox{\hyperlink{classclip__encoder_1_1_c_l_i_p_vision_tower_a650801f1129e77946e5ed4141c0dd9b9}{00035}}\ \ \ \ \ \ \ \ \ \ \ \ \ self.\mbox{\hyperlink{classclip__encoder_1_1_c_l_i_p_vision_tower_a650801f1129e77946e5ed4141c0dd9b9}{cfg\_only}}\ =\ CLIPVisionConfig.from\_pretrained(self.\mbox{\hyperlink{classclip__encoder_1_1_c_l_i_p_vision_tower_a3562cdd2057289eb65db9ae09da0cdf4}{vision\_tower\_name}})}
\DoxyCodeLine{\Hypertarget{clip__encoder_8py_source_l00036}00036\ }
\DoxyCodeLine{\Hypertarget{clip__encoder_8py_source_l00037}00037\ \ \ \ \ }
\DoxyCodeLine{\Hypertarget{clip__encoder_8py_source_l00042}\mbox{\hyperlink{classclip__encoder_1_1_c_l_i_p_vision_tower_a2502311ae705712e6ef9e5e65e2807d2}{00042}}\ \ \ \ \ \textcolor{keyword}{def\ }\mbox{\hyperlink{classclip__encoder_1_1_c_l_i_p_vision_tower_a2502311ae705712e6ef9e5e65e2807d2}{load\_model}}(self,\ device\_map=None):}
\DoxyCodeLine{\Hypertarget{clip__encoder_8py_source_l00043}00043\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ self.\mbox{\hyperlink{classclip__encoder_1_1_c_l_i_p_vision_tower_a552d4feb8810234513afe88accf44ae6}{is\_loaded}}:}
\DoxyCodeLine{\Hypertarget{clip__encoder_8py_source_l00044}00044\ \ \ \ \ \ \ \ \ \ \ \ \ print(\textcolor{stringliteral}{'\{\}\ is\ already\ loaded,\ \`{}load\_model`\ called\ again,\ skipping.'}.format(self.\mbox{\hyperlink{classclip__encoder_1_1_c_l_i_p_vision_tower_a3562cdd2057289eb65db9ae09da0cdf4}{vision\_tower\_name}}))}
\DoxyCodeLine{\Hypertarget{clip__encoder_8py_source_l00045}00045\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}}
\DoxyCodeLine{\Hypertarget{clip__encoder_8py_source_l00046}\mbox{\hyperlink{classclip__encoder_1_1_c_l_i_p_vision_tower_a6df8fbee4825155dff2ceeaeb32234c0}{00046}}\ \ \ \ \ \ \ \ \ self.\mbox{\hyperlink{classclip__encoder_1_1_c_l_i_p_vision_tower_a6df8fbee4825155dff2ceeaeb32234c0}{image\_processor}}\ =\ CLIPImageProcessor.from\_pretrained(self.\mbox{\hyperlink{classclip__encoder_1_1_c_l_i_p_vision_tower_a3562cdd2057289eb65db9ae09da0cdf4}{vision\_tower\_name}})}
\DoxyCodeLine{\Hypertarget{clip__encoder_8py_source_l00047}\mbox{\hyperlink{classclip__encoder_1_1_c_l_i_p_vision_tower_a8e0a71756050c45971d046aff2583058}{00047}}\ \ \ \ \ \ \ \ \ self.\mbox{\hyperlink{classclip__encoder_1_1_c_l_i_p_vision_tower_a8e0a71756050c45971d046aff2583058}{vision\_tower}}\ =\ CLIPVisionModel.from\_pretrained(self.\mbox{\hyperlink{classclip__encoder_1_1_c_l_i_p_vision_tower_a3562cdd2057289eb65db9ae09da0cdf4}{vision\_tower\_name}},\ device\_map=device\_map)}
\DoxyCodeLine{\Hypertarget{clip__encoder_8py_source_l00048}00048\ \ \ \ \ \ \ \ \ self.\mbox{\hyperlink{classclip__encoder_1_1_c_l_i_p_vision_tower_a8e0a71756050c45971d046aff2583058}{vision\_tower}}.requires\_grad\_(\textcolor{keyword}{False})}
\DoxyCodeLine{\Hypertarget{clip__encoder_8py_source_l00049}00049\ \ \ \ \ \ \ \ \ self.\mbox{\hyperlink{classclip__encoder_1_1_c_l_i_p_vision_tower_a552d4feb8810234513afe88accf44ae6}{is\_loaded}}\ =\ \textcolor{keyword}{True}}
\DoxyCodeLine{\Hypertarget{clip__encoder_8py_source_l00050}00050\ }
\DoxyCodeLine{\Hypertarget{clip__encoder_8py_source_l00051}00051\ \ \ \ \ }
\DoxyCodeLine{\Hypertarget{clip__encoder_8py_source_l00057}\mbox{\hyperlink{classclip__encoder_1_1_c_l_i_p_vision_tower_a3672100ff3fd44b7af9b637303e76fda}{00057}}\ \ \ \ \ \textcolor{keyword}{def\ }\mbox{\hyperlink{classclip__encoder_1_1_c_l_i_p_vision_tower_a3672100ff3fd44b7af9b637303e76fda}{feature\_select}}(self,\ image\_forward\_outs):}
\DoxyCodeLine{\Hypertarget{clip__encoder_8py_source_l00058}00058\ \ \ \ \ \ \ \ \ image\_features\ =\ image\_forward\_outs.hidden\_states[self.\mbox{\hyperlink{classclip__encoder_1_1_c_l_i_p_vision_tower_adacaade876d2fdee8347d37d566f59d8}{select\_layer}}]}
\DoxyCodeLine{\Hypertarget{clip__encoder_8py_source_l00059}00059\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ self.\mbox{\hyperlink{classclip__encoder_1_1_c_l_i_p_vision_tower_a074db3e083df3ae421a3d5451cd99122}{select\_feature}}\ ==\ \textcolor{stringliteral}{'patch'}:}
\DoxyCodeLine{\Hypertarget{clip__encoder_8py_source_l00060}00060\ \ \ \ \ \ \ \ \ \ \ \ \ image\_features\ =\ image\_features[:,\ 1:]}
\DoxyCodeLine{\Hypertarget{clip__encoder_8py_source_l00061}00061\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{elif}\ self.\mbox{\hyperlink{classclip__encoder_1_1_c_l_i_p_vision_tower_a074db3e083df3ae421a3d5451cd99122}{select\_feature}}\ ==\ \textcolor{stringliteral}{'cls\_patch'}:}
\DoxyCodeLine{\Hypertarget{clip__encoder_8py_source_l00062}00062\ \ \ \ \ \ \ \ \ \ \ \ \ image\_features\ =\ image\_features}
\DoxyCodeLine{\Hypertarget{clip__encoder_8py_source_l00063}00063\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{else}:}
\DoxyCodeLine{\Hypertarget{clip__encoder_8py_source_l00064}00064\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{raise}\ ValueError(f\textcolor{stringliteral}{'Unexpected\ select\ feature:\ \{self.select\_feature\}'})}
\DoxyCodeLine{\Hypertarget{clip__encoder_8py_source_l00065}00065\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ image\_features}
\DoxyCodeLine{\Hypertarget{clip__encoder_8py_source_l00066}00066\ }
\DoxyCodeLine{\Hypertarget{clip__encoder_8py_source_l00067}00067\ \ \ \ \ }
\DoxyCodeLine{\Hypertarget{clip__encoder_8py_source_l00073}00073\ \ \ \ \ \textcolor{preprocessor}{@torch.no\_grad()}}
\DoxyCodeLine{\Hypertarget{clip__encoder_8py_source_l00074}\mbox{\hyperlink{classclip__encoder_1_1_c_l_i_p_vision_tower_aa0f75e890e0d55b944ef3ebbdca0c38f}{00074}}\ \ \ \ \ \textcolor{keyword}{def\ }\mbox{\hyperlink{classclip__encoder_1_1_c_l_i_p_vision_tower_aa0f75e890e0d55b944ef3ebbdca0c38f}{forward}}(self,\ images):}
\DoxyCodeLine{\Hypertarget{clip__encoder_8py_source_l00075}00075\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ type(images)\ \textcolor{keywordflow}{is}\ list:}
\DoxyCodeLine{\Hypertarget{clip__encoder_8py_source_l00076}00076\ \ \ \ \ \ \ \ \ \ \ \ \ image\_features\ =\ []}
\DoxyCodeLine{\Hypertarget{clip__encoder_8py_source_l00077}00077\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ image\ \textcolor{keywordflow}{in}\ images:}
\DoxyCodeLine{\Hypertarget{clip__encoder_8py_source_l00078}00078\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ image\_forward\_out\ =\ self.\mbox{\hyperlink{classclip__encoder_1_1_c_l_i_p_vision_tower_a8e0a71756050c45971d046aff2583058}{vision\_tower}}(image.to(device=self.\mbox{\hyperlink{classclip__encoder_1_1_c_l_i_p_vision_tower_aefaf4fcc31ecfd8506965a211863592e}{device}},\ dtype=self.\mbox{\hyperlink{classclip__encoder_1_1_c_l_i_p_vision_tower_ad3388b41fc866537e34a9ce0e1af7ff6}{dtype}}).unsqueeze(0),\ output\_hidden\_states=\textcolor{keyword}{True})}
\DoxyCodeLine{\Hypertarget{clip__encoder_8py_source_l00079}00079\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ image\_feature\ =\ self.\mbox{\hyperlink{classclip__encoder_1_1_c_l_i_p_vision_tower_a3672100ff3fd44b7af9b637303e76fda}{feature\_select}}(image\_forward\_out).to(image.dtype)}
\DoxyCodeLine{\Hypertarget{clip__encoder_8py_source_l00080}00080\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ image\_features.append(image\_feature)}
\DoxyCodeLine{\Hypertarget{clip__encoder_8py_source_l00081}00081\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{else}:}
\DoxyCodeLine{\Hypertarget{clip__encoder_8py_source_l00082}00082\ \ \ \ \ \ \ \ \ \ \ \ \ image\_forward\_outs\ =\ self.\mbox{\hyperlink{classclip__encoder_1_1_c_l_i_p_vision_tower_a8e0a71756050c45971d046aff2583058}{vision\_tower}}(images.to(device=self.\mbox{\hyperlink{classclip__encoder_1_1_c_l_i_p_vision_tower_aefaf4fcc31ecfd8506965a211863592e}{device}},\ dtype=self.\mbox{\hyperlink{classclip__encoder_1_1_c_l_i_p_vision_tower_ad3388b41fc866537e34a9ce0e1af7ff6}{dtype}}),\ output\_hidden\_states=\textcolor{keyword}{True})}
\DoxyCodeLine{\Hypertarget{clip__encoder_8py_source_l00083}00083\ \ \ \ \ \ \ \ \ \ \ \ \ image\_features\ =\ self.\mbox{\hyperlink{classclip__encoder_1_1_c_l_i_p_vision_tower_a3672100ff3fd44b7af9b637303e76fda}{feature\_select}}(image\_forward\_outs).to(images.dtype)}
\DoxyCodeLine{\Hypertarget{clip__encoder_8py_source_l00084}00084\ }
\DoxyCodeLine{\Hypertarget{clip__encoder_8py_source_l00085}00085\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ image\_features}
\DoxyCodeLine{\Hypertarget{clip__encoder_8py_source_l00086}00086\ }
\DoxyCodeLine{\Hypertarget{clip__encoder_8py_source_l00087}00087\ \ \ \ \ }
\DoxyCodeLine{\Hypertarget{clip__encoder_8py_source_l00093}00093\ \ \ \ \ \textcolor{preprocessor}{@property}}
\DoxyCodeLine{\Hypertarget{clip__encoder_8py_source_l00094}\mbox{\hyperlink{classclip__encoder_1_1_c_l_i_p_vision_tower_ad6c762fb7b2ffaa2e6704149cad6a1c8}{00094}}\ \ \ \ \ \textcolor{keyword}{def\ }\mbox{\hyperlink{classclip__encoder_1_1_c_l_i_p_vision_tower_ad6c762fb7b2ffaa2e6704149cad6a1c8}{dummy\_feature}}(self):}
\DoxyCodeLine{\Hypertarget{clip__encoder_8py_source_l00095}\mbox{\hyperlink{classclip__encoder_1_1_c_l_i_p_vision_tower_a5be645d60211eb595c126d5069fdba14}{00095}}\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ torch.zeros(1,\ self.\mbox{\hyperlink{classclip__encoder_1_1_c_l_i_p_vision_tower_a5be645d60211eb595c126d5069fdba14}{hidden\_size}},\ device=self.\mbox{\hyperlink{classclip__encoder_1_1_c_l_i_p_vision_tower_aefaf4fcc31ecfd8506965a211863592e}{device}},\ dtype=self.\mbox{\hyperlink{classclip__encoder_1_1_c_l_i_p_vision_tower_ad3388b41fc866537e34a9ce0e1af7ff6}{dtype}})}
\DoxyCodeLine{\Hypertarget{clip__encoder_8py_source_l00096}00096\ }
\DoxyCodeLine{\Hypertarget{clip__encoder_8py_source_l00097}00097\ \ \ \ \ }
\DoxyCodeLine{\Hypertarget{clip__encoder_8py_source_l00103}00103\ \ \ \ \ \textcolor{preprocessor}{@property}}
\DoxyCodeLine{\Hypertarget{clip__encoder_8py_source_l00104}\mbox{\hyperlink{classclip__encoder_1_1_c_l_i_p_vision_tower_ad3388b41fc866537e34a9ce0e1af7ff6}{00104}}\ \ \ \ \ \textcolor{keyword}{def\ }\mbox{\hyperlink{classclip__encoder_1_1_c_l_i_p_vision_tower_ad3388b41fc866537e34a9ce0e1af7ff6}{dtype}}(self):}
\DoxyCodeLine{\Hypertarget{clip__encoder_8py_source_l00105}00105\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ self.\mbox{\hyperlink{classclip__encoder_1_1_c_l_i_p_vision_tower_a8e0a71756050c45971d046aff2583058}{vision\_tower}}.dtype}
\DoxyCodeLine{\Hypertarget{clip__encoder_8py_source_l00106}00106\ }
\DoxyCodeLine{\Hypertarget{clip__encoder_8py_source_l00107}00107\ \ \ \ \ }
\DoxyCodeLine{\Hypertarget{clip__encoder_8py_source_l00113}00113\ \ \ \ \ \textcolor{preprocessor}{@property}}
\DoxyCodeLine{\Hypertarget{clip__encoder_8py_source_l00114}\mbox{\hyperlink{classclip__encoder_1_1_c_l_i_p_vision_tower_aefaf4fcc31ecfd8506965a211863592e}{00114}}\ \ \ \ \ \textcolor{keyword}{def\ }\mbox{\hyperlink{classclip__encoder_1_1_c_l_i_p_vision_tower_aefaf4fcc31ecfd8506965a211863592e}{device}}(self):}
\DoxyCodeLine{\Hypertarget{clip__encoder_8py_source_l00115}00115\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ self.\mbox{\hyperlink{classclip__encoder_1_1_c_l_i_p_vision_tower_a8e0a71756050c45971d046aff2583058}{vision\_tower}}.device}
\DoxyCodeLine{\Hypertarget{clip__encoder_8py_source_l00116}00116\ }
\DoxyCodeLine{\Hypertarget{clip__encoder_8py_source_l00117}00117\ \ \ \ \ }
\DoxyCodeLine{\Hypertarget{clip__encoder_8py_source_l00123}00123\ \ \ \ \ \textcolor{preprocessor}{@property}}
\DoxyCodeLine{\Hypertarget{clip__encoder_8py_source_l00124}\mbox{\hyperlink{classclip__encoder_1_1_c_l_i_p_vision_tower_a401fce0c87d7c7afbb159f20fe143a99}{00124}}\ \ \ \ \ \textcolor{keyword}{def\ }\mbox{\hyperlink{classclip__encoder_1_1_c_l_i_p_vision_tower_a401fce0c87d7c7afbb159f20fe143a99}{config}}(self):}
\DoxyCodeLine{\Hypertarget{clip__encoder_8py_source_l00125}00125\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ self.\mbox{\hyperlink{classclip__encoder_1_1_c_l_i_p_vision_tower_a552d4feb8810234513afe88accf44ae6}{is\_loaded}}:}
\DoxyCodeLine{\Hypertarget{clip__encoder_8py_source_l00126}00126\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ self.\mbox{\hyperlink{classclip__encoder_1_1_c_l_i_p_vision_tower_a8e0a71756050c45971d046aff2583058}{vision\_tower}}.config}
\DoxyCodeLine{\Hypertarget{clip__encoder_8py_source_l00127}00127\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{else}:}
\DoxyCodeLine{\Hypertarget{clip__encoder_8py_source_l00128}00128\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ self.\mbox{\hyperlink{classclip__encoder_1_1_c_l_i_p_vision_tower_a650801f1129e77946e5ed4141c0dd9b9}{cfg\_only}}}
\DoxyCodeLine{\Hypertarget{clip__encoder_8py_source_l00129}00129\ }
\DoxyCodeLine{\Hypertarget{clip__encoder_8py_source_l00130}00130\ \ \ \ \ }
\DoxyCodeLine{\Hypertarget{clip__encoder_8py_source_l00136}00136\ \ \ \ \ \textcolor{preprocessor}{@property}}
\DoxyCodeLine{\Hypertarget{clip__encoder_8py_source_l00137}\mbox{\hyperlink{classclip__encoder_1_1_c_l_i_p_vision_tower_a8dfc65569f9763a83d404bf7facd7bad}{00137}}\ \ \ \ \ \textcolor{keyword}{def\ }\mbox{\hyperlink{classclip__encoder_1_1_c_l_i_p_vision_tower_a5be645d60211eb595c126d5069fdba14}{hidden\_size}}(self):}
\DoxyCodeLine{\Hypertarget{clip__encoder_8py_source_l00138}00138\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ self.\mbox{\hyperlink{classclip__encoder_1_1_c_l_i_p_vision_tower_a401fce0c87d7c7afbb159f20fe143a99}{config}}.hidden\_size}
\DoxyCodeLine{\Hypertarget{clip__encoder_8py_source_l00139}00139\ }
\DoxyCodeLine{\Hypertarget{clip__encoder_8py_source_l00140}00140\ \ \ \ \ }
\DoxyCodeLine{\Hypertarget{clip__encoder_8py_source_l00146}00146\ \ \ \ \ \textcolor{preprocessor}{@property}}
\DoxyCodeLine{\Hypertarget{clip__encoder_8py_source_l00147}\mbox{\hyperlink{classclip__encoder_1_1_c_l_i_p_vision_tower_a402bf44cae8f7b4e1684400721360ad9}{00147}}\ \ \ \ \ \textcolor{keyword}{def\ }\mbox{\hyperlink{classclip__encoder_1_1_c_l_i_p_vision_tower_a402bf44cae8f7b4e1684400721360ad9}{num\_patches\_per\_side}}(self):}
\DoxyCodeLine{\Hypertarget{clip__encoder_8py_source_l00148}00148\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ self.\mbox{\hyperlink{classclip__encoder_1_1_c_l_i_p_vision_tower_a401fce0c87d7c7afbb159f20fe143a99}{config}}.image\_size\ //\ self.\mbox{\hyperlink{classclip__encoder_1_1_c_l_i_p_vision_tower_a401fce0c87d7c7afbb159f20fe143a99}{config}}.patch\_size}
\DoxyCodeLine{\Hypertarget{clip__encoder_8py_source_l00149}00149\ }
\DoxyCodeLine{\Hypertarget{clip__encoder_8py_source_l00150}00150\ \ \ \ \ }
\DoxyCodeLine{\Hypertarget{clip__encoder_8py_source_l00156}00156\ \ \ \ \ \textcolor{preprocessor}{@property}}
\DoxyCodeLine{\Hypertarget{clip__encoder_8py_source_l00157}\mbox{\hyperlink{classclip__encoder_1_1_c_l_i_p_vision_tower_a898624ea5895559a8fe5a17b160a680d}{00157}}\ \ \ \ \ \textcolor{keyword}{def\ }\mbox{\hyperlink{classclip__encoder_1_1_c_l_i_p_vision_tower_a898624ea5895559a8fe5a17b160a680d}{num\_patches}}(self):}
\DoxyCodeLine{\Hypertarget{clip__encoder_8py_source_l00158}00158\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ (self.\mbox{\hyperlink{classclip__encoder_1_1_c_l_i_p_vision_tower_a401fce0c87d7c7afbb159f20fe143a99}{config}}.image\_size\ //\ self.\mbox{\hyperlink{classclip__encoder_1_1_c_l_i_p_vision_tower_a401fce0c87d7c7afbb159f20fe143a99}{config}}.patch\_size)\ **\ 2}
\DoxyCodeLine{\Hypertarget{clip__encoder_8py_source_l00159}00159\ }
\DoxyCodeLine{\Hypertarget{clip__encoder_8py_source_l00160}00160\ }
\DoxyCodeLine{\Hypertarget{clip__encoder_8py_source_l00165}\mbox{\hyperlink{classclip__encoder_1_1_c_l_i_p_vision_tower_s2}{00165}}\ \textcolor{keyword}{class\ }\mbox{\hyperlink{classclip__encoder_1_1_c_l_i_p_vision_tower_s2}{CLIPVisionTowerS2}}(\mbox{\hyperlink{classclip__encoder_1_1_c_l_i_p_vision_tower}{CLIPVisionTower}}):}
\DoxyCodeLine{\Hypertarget{clip__encoder_8py_source_l00166}00166\ \ \ \ \ }
\DoxyCodeLine{\Hypertarget{clip__encoder_8py_source_l00173}\mbox{\hyperlink{classclip__encoder_1_1_c_l_i_p_vision_tower_s2_a7c65241d4e15fc399c4060dee87f705e}{00173}}\ \ \ \ \ \textcolor{keyword}{def\ }\mbox{\hyperlink{classclip__encoder_1_1_c_l_i_p_vision_tower_s2_a7c65241d4e15fc399c4060dee87f705e}{\_\_init\_\_}}(self,\ vision\_tower,\ args,\ delay\_load=False):}
\DoxyCodeLine{\Hypertarget{clip__encoder_8py_source_l00174}00174\ \ \ \ \ \ \ \ \ super().\mbox{\hyperlink{classclip__encoder_1_1_c_l_i_p_vision_tower_s2_a7c65241d4e15fc399c4060dee87f705e}{\_\_init\_\_}}(vision\_tower,\ args,\ delay\_load)}
\DoxyCodeLine{\Hypertarget{clip__encoder_8py_source_l00175}\mbox{\hyperlink{classclip__encoder_1_1_c_l_i_p_vision_tower_s2_a7e805051fa6e53a3baef2f1c8549bd09}{00175}}\ \ \ \ \ \ \ \ \ self.\mbox{\hyperlink{classclip__encoder_1_1_c_l_i_p_vision_tower_s2_a7e805051fa6e53a3baef2f1c8549bd09}{s2\_scales}}\ =\ getattr(args,\ \textcolor{stringliteral}{'s2\_scales'},\ \textcolor{stringliteral}{'336,672,1008'})}
\DoxyCodeLine{\Hypertarget{clip__encoder_8py_source_l00176}00176\ \ \ \ \ \ \ \ \ self.\mbox{\hyperlink{classclip__encoder_1_1_c_l_i_p_vision_tower_s2_a7e805051fa6e53a3baef2f1c8549bd09}{s2\_scales}}\ =\ list(map(int,\ self.\mbox{\hyperlink{classclip__encoder_1_1_c_l_i_p_vision_tower_s2_a7e805051fa6e53a3baef2f1c8549bd09}{s2\_scales}}.split(\textcolor{stringliteral}{','})))}
\DoxyCodeLine{\Hypertarget{clip__encoder_8py_source_l00177}00177\ \ \ \ \ \ \ \ \ self.\mbox{\hyperlink{classclip__encoder_1_1_c_l_i_p_vision_tower_s2_a7e805051fa6e53a3baef2f1c8549bd09}{s2\_scales}}.sort()}
\DoxyCodeLine{\Hypertarget{clip__encoder_8py_source_l00178}\mbox{\hyperlink{classclip__encoder_1_1_c_l_i_p_vision_tower_s2_a1a7a53764b4e3534a39037c27ddac687}{00178}}\ \ \ \ \ \ \ \ \ self.\mbox{\hyperlink{classclip__encoder_1_1_c_l_i_p_vision_tower_s2_a1a7a53764b4e3534a39037c27ddac687}{s2\_split\_size}}\ =\ self.\mbox{\hyperlink{classclip__encoder_1_1_c_l_i_p_vision_tower_s2_a7e805051fa6e53a3baef2f1c8549bd09}{s2\_scales}}[0]}
\DoxyCodeLine{\Hypertarget{clip__encoder_8py_source_l00179}\mbox{\hyperlink{classclip__encoder_1_1_c_l_i_p_vision_tower_s2_a8c880b1e3efa1d523239ab87063c49f2}{00179}}\ \ \ \ \ \ \ \ \ self.\mbox{\hyperlink{classclip__encoder_1_1_c_l_i_p_vision_tower_s2_a8c880b1e3efa1d523239ab87063c49f2}{s2\_image\_size}}\ =\ self.\mbox{\hyperlink{classclip__encoder_1_1_c_l_i_p_vision_tower_s2_a7e805051fa6e53a3baef2f1c8549bd09}{s2\_scales}}[-\/1]}
\DoxyCodeLine{\Hypertarget{clip__encoder_8py_source_l00180}00180\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{try}:}
\DoxyCodeLine{\Hypertarget{clip__encoder_8py_source_l00181}00181\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{from}\ s2wrapper\ \textcolor{keyword}{import}\ forward\ \textcolor{keyword}{as}\ multiscale\_forward}
\DoxyCodeLine{\Hypertarget{clip__encoder_8py_source_l00182}00182\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{except}\ ImportError:}
\DoxyCodeLine{\Hypertarget{clip__encoder_8py_source_l00183}00183\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{raise}\ ImportError(\textcolor{stringliteral}{'Package\ s2wrapper\ not\ found!\ Please\ install\ by\ running:\ \(\backslash\)npip\ install\ git+https://github.com/bfshi/scaling\_on\_scales.git'})}
\DoxyCodeLine{\Hypertarget{clip__encoder_8py_source_l00184}\mbox{\hyperlink{classclip__encoder_1_1_c_l_i_p_vision_tower_s2_a3fc72415a0199dc40f334cf98db72456}{00184}}\ \ \ \ \ \ \ \ \ self.\mbox{\hyperlink{classclip__encoder_1_1_c_l_i_p_vision_tower_s2_a3fc72415a0199dc40f334cf98db72456}{multiscale\_forward}}\ =\ multiscale\_forward}
\DoxyCodeLine{\Hypertarget{clip__encoder_8py_source_l00185}00185\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ \textcolor{keywordflow}{not}\ delay\_load\ \textcolor{keywordflow}{or}\ getattr(args,\ \textcolor{stringliteral}{'unfreeze\_mm\_vision\_tower'},\ \textcolor{keyword}{False}):}
\DoxyCodeLine{\Hypertarget{clip__encoder_8py_source_l00186}00186\ \ \ \ \ \ \ \ \ \ \ \ \ self.\mbox{\hyperlink{classclip__encoder_1_1_c_l_i_p_vision_tower_a6df8fbee4825155dff2ceeaeb32234c0}{image\_processor}}.size[\textcolor{stringliteral}{'shortest\_edge'}]\ =\ self.\mbox{\hyperlink{classclip__encoder_1_1_c_l_i_p_vision_tower_s2_a8c880b1e3efa1d523239ab87063c49f2}{s2\_image\_size}}}
\DoxyCodeLine{\Hypertarget{clip__encoder_8py_source_l00187}00187\ \ \ \ \ \ \ \ \ \ \ \ \ self.\mbox{\hyperlink{classclip__encoder_1_1_c_l_i_p_vision_tower_a6df8fbee4825155dff2ceeaeb32234c0}{image\_processor}}.crop\_size[\textcolor{stringliteral}{'height'}]\ =\ self.\mbox{\hyperlink{classclip__encoder_1_1_c_l_i_p_vision_tower_a6df8fbee4825155dff2ceeaeb32234c0}{image\_processor}}.crop\_size[\textcolor{stringliteral}{'width'}]\ =\ self.\mbox{\hyperlink{classclip__encoder_1_1_c_l_i_p_vision_tower_s2_a8c880b1e3efa1d523239ab87063c49f2}{s2\_image\_size}}}
\DoxyCodeLine{\Hypertarget{clip__encoder_8py_source_l00188}00188\ }
\DoxyCodeLine{\Hypertarget{clip__encoder_8py_source_l00189}00189\ \ \ \ \ }
\DoxyCodeLine{\Hypertarget{clip__encoder_8py_source_l00194}\mbox{\hyperlink{classclip__encoder_1_1_c_l_i_p_vision_tower_s2_af1e5272133bb33d214e96a471fd3a9f4}{00194}}\ \ \ \ \ \textcolor{keyword}{def\ }\mbox{\hyperlink{classclip__encoder_1_1_c_l_i_p_vision_tower_s2_af1e5272133bb33d214e96a471fd3a9f4}{load\_model}}(self,\ device\_map=None):}
\DoxyCodeLine{\Hypertarget{clip__encoder_8py_source_l00195}\mbox{\hyperlink{classclip__encoder_1_1_c_l_i_p_vision_tower_s2}{00195}}\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ self.\mbox{\hyperlink{classclip__encoder_1_1_c_l_i_p_vision_tower_a552d4feb8810234513afe88accf44ae6}{is\_loaded}}:}
\DoxyCodeLine{\Hypertarget{clip__encoder_8py_source_l00196}\mbox{\hyperlink{classclip__encoder_1_1_c_l_i_p_vision_tower_s2}{00196}}\ \ \ \ \ \ \ \ \ \ \ \ \ print(\textcolor{stringliteral}{'\{\}\ is\ already\ loaded,\ \`{}load\_model`\ called\ again,\ skipping.'}.format(self.\mbox{\hyperlink{classclip__encoder_1_1_c_l_i_p_vision_tower_a3562cdd2057289eb65db9ae09da0cdf4}{vision\_tower\_name}}))}
\DoxyCodeLine{\Hypertarget{clip__encoder_8py_source_l00197}00197\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}}
\DoxyCodeLine{\Hypertarget{clip__encoder_8py_source_l00198}\mbox{\hyperlink{classclip__encoder_1_1_c_l_i_p_vision_tower_s2}{00198}}\ \ \ \ \ \ \ \ \ self.\mbox{\hyperlink{classclip__encoder_1_1_c_l_i_p_vision_tower_a6df8fbee4825155dff2ceeaeb32234c0}{image\_processor}}\ =\ CLIPImageProcessor.from\_pretrained(self.\mbox{\hyperlink{classclip__encoder_1_1_c_l_i_p_vision_tower_a3562cdd2057289eb65db9ae09da0cdf4}{vision\_tower\_name}})}
\DoxyCodeLine{\Hypertarget{clip__encoder_8py_source_l00199}\mbox{\hyperlink{classclip__encoder_1_1_c_l_i_p_vision_tower_s2}{00199}}\ \ \ \ \ \ \ \ \ self.\mbox{\hyperlink{classclip__encoder_1_1_c_l_i_p_vision_tower_a8e0a71756050c45971d046aff2583058}{vision\_tower}}\ =\ CLIPVisionModel.from\_pretrained(self.\mbox{\hyperlink{classclip__encoder_1_1_c_l_i_p_vision_tower_a3562cdd2057289eb65db9ae09da0cdf4}{vision\_tower\_name}},\ device\_map=device\_map)}
\DoxyCodeLine{\Hypertarget{clip__encoder_8py_source_l00200}00200\ \ \ \ \ \ \ \ \ self.\mbox{\hyperlink{classclip__encoder_1_1_c_l_i_p_vision_tower_a8e0a71756050c45971d046aff2583058}{vision\_tower}}.requires\_grad\_(\textcolor{keyword}{False})}
\DoxyCodeLine{\Hypertarget{clip__encoder_8py_source_l00201}00201\ \ \ \ \ \ \ \ \ self.\mbox{\hyperlink{classclip__encoder_1_1_c_l_i_p_vision_tower_a6df8fbee4825155dff2ceeaeb32234c0}{image\_processor}}.size[\textcolor{stringliteral}{'shortest\_edge'}]\ =\ self.\mbox{\hyperlink{classclip__encoder_1_1_c_l_i_p_vision_tower_s2_a8c880b1e3efa1d523239ab87063c49f2}{s2\_image\_size}}}
\DoxyCodeLine{\Hypertarget{clip__encoder_8py_source_l00202}00202\ \ \ \ \ \ \ \ \ self.\mbox{\hyperlink{classclip__encoder_1_1_c_l_i_p_vision_tower_a6df8fbee4825155dff2ceeaeb32234c0}{image\_processor}}.crop\_size[\textcolor{stringliteral}{'height'}]\ =\ self.\mbox{\hyperlink{classclip__encoder_1_1_c_l_i_p_vision_tower_a6df8fbee4825155dff2ceeaeb32234c0}{image\_processor}}.crop\_size[\textcolor{stringliteral}{'width'}]\ =\ self.\mbox{\hyperlink{classclip__encoder_1_1_c_l_i_p_vision_tower_s2_a8c880b1e3efa1d523239ab87063c49f2}{s2\_image\_size}}}
\DoxyCodeLine{\Hypertarget{clip__encoder_8py_source_l00203}00203\ \ \ \ \ \ \ \ \ self.\mbox{\hyperlink{classclip__encoder_1_1_c_l_i_p_vision_tower_a552d4feb8810234513afe88accf44ae6}{is\_loaded}}\ =\ \textcolor{keyword}{True}}
\DoxyCodeLine{\Hypertarget{clip__encoder_8py_source_l00204}00204\ }
\DoxyCodeLine{\Hypertarget{clip__encoder_8py_source_l00205}00205\ \ \ \ \ }
\DoxyCodeLine{\Hypertarget{clip__encoder_8py_source_l00211}00211\ \ \ \ \ \textcolor{preprocessor}{@torch.no\_grad()}}
\DoxyCodeLine{\Hypertarget{clip__encoder_8py_source_l00212}\mbox{\hyperlink{classclip__encoder_1_1_c_l_i_p_vision_tower_s2_a1ac0eb73f9acce13b53bc617433ca298}{00212}}\ \ \ \ \ \textcolor{keyword}{def\ }\mbox{\hyperlink{classclip__encoder_1_1_c_l_i_p_vision_tower_s2_a1ac0eb73f9acce13b53bc617433ca298}{forward\_feature}}(self,\ images):}
\DoxyCodeLine{\Hypertarget{clip__encoder_8py_source_l00213}00213\ \ \ \ \ \ \ \ \ image\_forward\_outs\ =\ self.\mbox{\hyperlink{classclip__encoder_1_1_c_l_i_p_vision_tower_a8e0a71756050c45971d046aff2583058}{vision\_tower}}(images.to(device=self.\mbox{\hyperlink{classclip__encoder_1_1_c_l_i_p_vision_tower_aefaf4fcc31ecfd8506965a211863592e}{device}},\ dtype=self.\mbox{\hyperlink{classclip__encoder_1_1_c_l_i_p_vision_tower_ad3388b41fc866537e34a9ce0e1af7ff6}{dtype}}),\ output\_hidden\_states=\textcolor{keyword}{True})}
\DoxyCodeLine{\Hypertarget{clip__encoder_8py_source_l00214}00214\ \ \ \ \ \ \ \ \ image\_features\ =\ self.\mbox{\hyperlink{classclip__encoder_1_1_c_l_i_p_vision_tower_a3672100ff3fd44b7af9b637303e76fda}{feature\_select}}(image\_forward\_outs).to(images.dtype)}
\DoxyCodeLine{\Hypertarget{clip__encoder_8py_source_l00215}00215\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ image\_features}
\DoxyCodeLine{\Hypertarget{clip__encoder_8py_source_l00216}00216\ }
\DoxyCodeLine{\Hypertarget{clip__encoder_8py_source_l00217}00217\ \ \ \ \ }
\DoxyCodeLine{\Hypertarget{clip__encoder_8py_source_l00223}00223\ \ \ \ \ \textcolor{preprocessor}{@torch.no\_grad()}}
\DoxyCodeLine{\Hypertarget{clip__encoder_8py_source_l00224}\mbox{\hyperlink{classclip__encoder_1_1_c_l_i_p_vision_tower_s2_aae0bd25ee16d25a6b88e3d2a179d39f9}{00224}}\ \ \ \ \ \textcolor{keyword}{def\ }\mbox{\hyperlink{classclip__encoder_1_1_c_l_i_p_vision_tower_s2_aae0bd25ee16d25a6b88e3d2a179d39f9}{forward}}(self,\ images):}
\DoxyCodeLine{\Hypertarget{clip__encoder_8py_source_l00225}00225\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ type(images)\ \textcolor{keywordflow}{is}\ list:}
\DoxyCodeLine{\Hypertarget{clip__encoder_8py_source_l00226}00226\ \ \ \ \ \ \ \ \ \ \ \ \ image\_features\ =\ []}
\DoxyCodeLine{\Hypertarget{clip__encoder_8py_source_l00227}00227\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ image\ \textcolor{keywordflow}{in}\ images:}
\DoxyCodeLine{\Hypertarget{clip__encoder_8py_source_l00228}00228\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ image\_feature\ =\ self.\mbox{\hyperlink{classclip__encoder_1_1_c_l_i_p_vision_tower_s2_a3fc72415a0199dc40f334cf98db72456}{multiscale\_forward}}(self.\mbox{\hyperlink{classclip__encoder_1_1_c_l_i_p_vision_tower_s2_a1ac0eb73f9acce13b53bc617433ca298}{forward\_feature}},\ image.unsqueeze(0),\ img\_sizes=self.\mbox{\hyperlink{classclip__encoder_1_1_c_l_i_p_vision_tower_s2_a7e805051fa6e53a3baef2f1c8549bd09}{s2\_scales}},\ max\_split\_size=self.\mbox{\hyperlink{classclip__encoder_1_1_c_l_i_p_vision_tower_s2_a1a7a53764b4e3534a39037c27ddac687}{s2\_split\_size}})}
\DoxyCodeLine{\Hypertarget{clip__encoder_8py_source_l00229}00229\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ image\_features.append(image\_feature)}
\DoxyCodeLine{\Hypertarget{clip__encoder_8py_source_l00230}00230\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{else}:}
\DoxyCodeLine{\Hypertarget{clip__encoder_8py_source_l00231}00231\ \ \ \ \ \ \ \ \ \ \ \ \ image\_features\ =\ self.\mbox{\hyperlink{classclip__encoder_1_1_c_l_i_p_vision_tower_s2_a3fc72415a0199dc40f334cf98db72456}{multiscale\_forward}}(self.\mbox{\hyperlink{classclip__encoder_1_1_c_l_i_p_vision_tower_s2_a1ac0eb73f9acce13b53bc617433ca298}{forward\_feature}},\ images,\ img\_sizes=self.\mbox{\hyperlink{classclip__encoder_1_1_c_l_i_p_vision_tower_s2_a7e805051fa6e53a3baef2f1c8549bd09}{s2\_scales}},\ max\_split\_size=self.\mbox{\hyperlink{classclip__encoder_1_1_c_l_i_p_vision_tower_s2_a1a7a53764b4e3534a39037c27ddac687}{s2\_split\_size}})}
\DoxyCodeLine{\Hypertarget{clip__encoder_8py_source_l00232}00232\ }
\DoxyCodeLine{\Hypertarget{clip__encoder_8py_source_l00233}00233\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}}

\end{DoxyCode}
