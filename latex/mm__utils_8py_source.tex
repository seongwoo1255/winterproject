\doxysection{mm\+\_\+utils.\+py}
\hypertarget{mm__utils_8py_source}{}\label{mm__utils_8py_source}\index{llava/mm\_utils.py@{llava/mm\_utils.py}}
\mbox{\hyperlink{mm__utils_8py}{Go to the documentation of this file.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00001}\mbox{\hyperlink{namespacellava_1_1mm__utils}{00001}}\ \textcolor{keyword}{from}\ PIL\ \textcolor{keyword}{import}\ Image}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00002}00002\ \textcolor{keyword}{from}\ io\ \textcolor{keyword}{import}\ BytesIO}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00003}00003\ \textcolor{keyword}{import}\ base64}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00004}00004\ \textcolor{keyword}{import}\ torch}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00005}00005\ \textcolor{keyword}{import}\ math}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00006}00006\ \textcolor{keyword}{import}\ ast}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00007}00007\ }
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00008}00008\ \textcolor{keyword}{from}\ transformers\ \textcolor{keyword}{import}\ StoppingCriteria}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00009}00009\ \textcolor{keyword}{from}\ \mbox{\hyperlink{namespacellava_1_1constants}{llava.constants}}\ \textcolor{keyword}{import}\ IMAGE\_TOKEN\_INDEX}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00010}00010\ }
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00011}00011\ }
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00012}\mbox{\hyperlink{namespacellava_1_1mm__utils_a4ca4286048f7be2f9e5f0b93e30b7672}{00012}}\ \textcolor{keyword}{def\ }\mbox{\hyperlink{namespacellava_1_1mm__utils_a4ca4286048f7be2f9e5f0b93e30b7672}{select\_best\_resolution}}(original\_size,\ possible\_resolutions):}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00013}00013\ \ \ \ \ \textcolor{stringliteral}{"{}"{}"{}}}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00014}00014\ \textcolor{stringliteral}{\ \ \ \ Selects\ the\ best\ resolution\ from\ a\ list\ of\ possible\ resolutions\ based\ on\ the\ original\ size.}}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00015}00015\ \textcolor{stringliteral}{}}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00016}00016\ \textcolor{stringliteral}{\ \ \ \ Args:}}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00017}00017\ \textcolor{stringliteral}{\ \ \ \ \ \ \ \ original\_size\ (tuple):\ The\ original\ size\ of\ the\ image\ in\ the\ format\ (width,\ height).}}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00018}00018\ \textcolor{stringliteral}{\ \ \ \ \ \ \ \ possible\_resolutions\ (list):\ A\ list\ of\ possible\ resolutions\ in\ the\ format\ [(width1,\ height1),\ (width2,\ height2),\ ...].}}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00019}00019\ \textcolor{stringliteral}{}}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00020}00020\ \textcolor{stringliteral}{\ \ \ \ Returns:}}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00021}00021\ \textcolor{stringliteral}{\ \ \ \ \ \ \ \ tuple:\ The\ best\ fit\ resolution\ in\ the\ format\ (width,\ height).}}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00022}00022\ \textcolor{stringliteral}{\ \ \ \ "{}"{}"{}}}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00023}00023\ \ \ \ \ original\_width,\ original\_height\ =\ original\_size}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00024}00024\ \ \ \ \ best\_fit\ =\ \textcolor{keywordtype}{None}}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00025}00025\ \ \ \ \ max\_effective\_resolution\ =\ 0}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00026}00026\ \ \ \ \ min\_wasted\_resolution\ =\ float(\textcolor{stringliteral}{'inf'})}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00027}00027\ }
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00028}00028\ \ \ \ \ \textcolor{keywordflow}{for}\ width,\ height\ \textcolor{keywordflow}{in}\ possible\_resolutions:}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00029}00029\ \ \ \ \ \ \ \ \ scale\ =\ min(width\ /\ original\_width,\ height\ /\ original\_height)}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00030}00030\ \ \ \ \ \ \ \ \ downscaled\_width,\ downscaled\_height\ =\ int(original\_width\ *\ scale),\ int(original\_height\ *\ scale)}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00031}00031\ \ \ \ \ \ \ \ \ effective\_resolution\ =\ min(downscaled\_width\ *\ downscaled\_height,\ original\_width\ *\ original\_height)}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00032}00032\ \ \ \ \ \ \ \ \ wasted\_resolution\ =\ (width\ *\ height)\ -\/\ effective\_resolution}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00033}00033\ }
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00034}00034\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ effective\_resolution\ >\ max\_effective\_resolution\ \textcolor{keywordflow}{or}\ (effective\_resolution\ ==\ max\_effective\_resolution\ \textcolor{keywordflow}{and}\ wasted\_resolution\ <\ min\_wasted\_resolution):}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00035}00035\ \ \ \ \ \ \ \ \ \ \ \ \ max\_effective\_resolution\ =\ effective\_resolution}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00036}00036\ \ \ \ \ \ \ \ \ \ \ \ \ min\_wasted\_resolution\ =\ wasted\_resolution}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00037}00037\ \ \ \ \ \ \ \ \ \ \ \ \ best\_fit\ =\ (width,\ height)}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00038}00038\ }
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00039}00039\ \ \ \ \ \textcolor{keywordflow}{return}\ best\_fit}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00040}00040\ }
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00041}00041\ }
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00042}\mbox{\hyperlink{namespacellava_1_1mm__utils_a40cefe125ab588aa0efee388f7b7108f}{00042}}\ \textcolor{keyword}{def\ }\mbox{\hyperlink{namespacellava_1_1mm__utils_a40cefe125ab588aa0efee388f7b7108f}{resize\_and\_pad\_image}}(image,\ target\_resolution):}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00043}00043\ \ \ \ \ \textcolor{stringliteral}{"{}"{}"{}}}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00044}00044\ \textcolor{stringliteral}{\ \ \ \ Resize\ and\ pad\ an\ image\ to\ a\ target\ resolution\ while\ maintaining\ aspect\ ratio.}}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00045}00045\ \textcolor{stringliteral}{}}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00046}00046\ \textcolor{stringliteral}{\ \ \ \ Args:}}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00047}00047\ \textcolor{stringliteral}{\ \ \ \ \ \ \ \ image\ (PIL.Image.Image):\ The\ input\ image.}}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00048}00048\ \textcolor{stringliteral}{\ \ \ \ \ \ \ \ target\_resolution\ (tuple):\ The\ target\ resolution\ (width,\ height)\ of\ the\ image.}}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00049}00049\ \textcolor{stringliteral}{}}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00050}00050\ \textcolor{stringliteral}{\ \ \ \ Returns:}}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00051}00051\ \textcolor{stringliteral}{\ \ \ \ \ \ \ \ PIL.Image.Image:\ The\ resized\ and\ padded\ image.}}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00052}00052\ \textcolor{stringliteral}{\ \ \ \ "{}"{}"{}}}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00053}00053\ \ \ \ \ original\_width,\ original\_height\ =\ image.size}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00054}00054\ \ \ \ \ target\_width,\ target\_height\ =\ target\_resolution}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00055}00055\ }
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00056}00056\ \ \ \ \ scale\_w\ =\ target\_width\ /\ original\_width}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00057}00057\ \ \ \ \ scale\_h\ =\ target\_height\ /\ original\_height}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00058}00058\ }
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00059}00059\ \ \ \ \ \textcolor{keywordflow}{if}\ scale\_w\ <\ scale\_h:}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00060}00060\ \ \ \ \ \ \ \ \ new\_width\ =\ target\_width}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00061}00061\ \ \ \ \ \ \ \ \ new\_height\ =\ min(math.ceil(original\_height\ *\ scale\_w),\ target\_height)}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00062}00062\ \ \ \ \ \textcolor{keywordflow}{else}:}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00063}00063\ \ \ \ \ \ \ \ \ new\_height\ =\ target\_height}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00064}00064\ \ \ \ \ \ \ \ \ new\_width\ =\ min(math.ceil(original\_width\ *\ scale\_h),\ target\_width)}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00065}00065\ }
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00066}00066\ \ \ \ \ \textcolor{comment}{\#\ Resize\ the\ image}}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00067}00067\ \ \ \ \ resized\_image\ =\ image.resize((new\_width,\ new\_height))}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00068}00068\ }
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00069}00069\ \ \ \ \ new\_image\ =\ Image.new(\textcolor{stringliteral}{'RGB'},\ (target\_width,\ target\_height),\ (0,\ 0,\ 0))}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00070}00070\ \ \ \ \ paste\_x\ =\ (target\_width\ -\/\ new\_width)\ //\ 2}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00071}00071\ \ \ \ \ paste\_y\ =\ (target\_height\ -\/\ new\_height)\ //\ 2}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00072}00072\ \ \ \ \ new\_image.paste(resized\_image,\ (paste\_x,\ paste\_y))}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00073}00073\ }
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00074}00074\ \ \ \ \ \textcolor{keywordflow}{return}\ new\_image}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00075}00075\ }
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00076}00076\ }
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00077}\mbox{\hyperlink{namespacellava_1_1mm__utils_ae4ccc6abdd03caf02e2ac9ca1bb2af04}{00077}}\ \textcolor{keyword}{def\ }\mbox{\hyperlink{namespacellava_1_1mm__utils_ae4ccc6abdd03caf02e2ac9ca1bb2af04}{divide\_to\_patches}}(image,\ patch\_size):}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00078}00078\ \ \ \ \ \textcolor{stringliteral}{"{}"{}"{}}}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00079}00079\ \textcolor{stringliteral}{\ \ \ \ Divides\ an\ image\ into\ patches\ of\ a\ specified\ size.}}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00080}00080\ \textcolor{stringliteral}{}}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00081}00081\ \textcolor{stringliteral}{\ \ \ \ Args:}}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00082}00082\ \textcolor{stringliteral}{\ \ \ \ \ \ \ \ image\ (PIL.Image.Image):\ The\ input\ image.}}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00083}00083\ \textcolor{stringliteral}{\ \ \ \ \ \ \ \ patch\_size\ (int):\ The\ size\ of\ each\ patch.}}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00084}00084\ \textcolor{stringliteral}{}}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00085}00085\ \textcolor{stringliteral}{\ \ \ \ Returns:}}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00086}00086\ \textcolor{stringliteral}{\ \ \ \ \ \ \ \ list:\ A\ list\ of\ PIL.Image.Image\ objects\ representing\ the\ patches.}}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00087}00087\ \textcolor{stringliteral}{\ \ \ \ "{}"{}"{}}}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00088}00088\ \ \ \ \ patches\ =\ []}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00089}00089\ \ \ \ \ width,\ height\ =\ image.size}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00090}00090\ \ \ \ \ \textcolor{keywordflow}{for}\ i\ \textcolor{keywordflow}{in}\ range(0,\ height,\ patch\_size):}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00091}00091\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ j\ \textcolor{keywordflow}{in}\ range(0,\ width,\ patch\_size):}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00092}00092\ \ \ \ \ \ \ \ \ \ \ \ \ box\ =\ (j,\ i,\ j\ +\ patch\_size,\ i\ +\ patch\_size)}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00093}00093\ \ \ \ \ \ \ \ \ \ \ \ \ patch\ =\ image.crop(box)}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00094}00094\ \ \ \ \ \ \ \ \ \ \ \ \ patches.append(patch)}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00095}00095\ }
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00096}00096\ \ \ \ \ \textcolor{keywordflow}{return}\ patches}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00097}00097\ }
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00098}00098\ }
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00099}\mbox{\hyperlink{namespacellava_1_1mm__utils_a60a4bdd48b49a10221d254162944b30c}{00099}}\ \textcolor{keyword}{def\ }\mbox{\hyperlink{namespacellava_1_1mm__utils_a60a4bdd48b49a10221d254162944b30c}{get\_anyres\_image\_grid\_shape}}(image\_size,\ grid\_pinpoints,\ patch\_size):}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00100}00100\ \ \ \ \ \textcolor{stringliteral}{"{}"{}"{}}}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00101}00101\ \textcolor{stringliteral}{\ \ \ \ Calculate\ the\ shape\ of\ the\ image\ patch\ grid\ after\ the\ preprocessing\ for\ images\ of\ any\ resolution.}}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00102}00102\ \textcolor{stringliteral}{}}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00103}00103\ \textcolor{stringliteral}{\ \ \ \ Args:}}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00104}00104\ \textcolor{stringliteral}{\ \ \ \ \ \ \ \ image\_size\ (tuple):\ The\ size\ of\ the\ input\ image\ in\ the\ format\ (width,\ height).}}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00105}00105\ \textcolor{stringliteral}{\ \ \ \ \ \ \ \ grid\_pinpoints\ (str):\ A\ string\ representation\ of\ a\ list\ of\ possible\ resolutions.}}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00106}00106\ \textcolor{stringliteral}{\ \ \ \ \ \ \ \ patch\_size\ (int):\ The\ size\ of\ each\ image\ patch.}}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00107}00107\ \textcolor{stringliteral}{}}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00108}00108\ \textcolor{stringliteral}{\ \ \ \ Returns:}}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00109}00109\ \textcolor{stringliteral}{\ \ \ \ \ \ \ \ tuple:\ The\ shape\ of\ the\ image\ patch\ grid\ in\ the\ format\ (width,\ height).}}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00110}00110\ \textcolor{stringliteral}{\ \ \ \ "{}"{}"{}}}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00111}00111\ \ \ \ \ \textcolor{keywordflow}{if}\ type(grid\_pinpoints)\ \textcolor{keywordflow}{is}\ list:}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00112}00112\ \ \ \ \ \ \ \ \ possible\_resolutions\ =\ grid\_pinpoints}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00113}00113\ \ \ \ \ \textcolor{keywordflow}{else}:}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00114}00114\ \ \ \ \ \ \ \ \ possible\_resolutions\ =\ ast.literal\_eval(grid\_pinpoints)}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00115}00115\ \ \ \ \ width,\ height\ =\ \mbox{\hyperlink{namespacellava_1_1mm__utils_a4ca4286048f7be2f9e5f0b93e30b7672}{select\_best\_resolution}}(image\_size,\ possible\_resolutions)}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00116}00116\ \ \ \ \ \textcolor{keywordflow}{return}\ width\ //\ patch\_size,\ height\ //\ patch\_size}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00117}00117\ }
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00118}00118\ }
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00119}\mbox{\hyperlink{namespacellava_1_1mm__utils_adbf2269511a2260e914ea2b43935166a}{00119}}\ \textcolor{keyword}{def\ }\mbox{\hyperlink{namespacellava_1_1mm__utils_adbf2269511a2260e914ea2b43935166a}{process\_anyres\_image}}(image,\ processor,\ grid\_pinpoints):}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00120}00120\ \ \ \ \ \textcolor{stringliteral}{"{}"{}"{}}}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00121}00121\ \textcolor{stringliteral}{\ \ \ \ Process\ an\ image\ with\ variable\ resolutions.}}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00122}00122\ \textcolor{stringliteral}{}}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00123}00123\ \textcolor{stringliteral}{\ \ \ \ Args:}}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00124}00124\ \textcolor{stringliteral}{\ \ \ \ \ \ \ \ image\ (PIL.Image.Image):\ The\ input\ image\ to\ be\ processed.}}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00125}00125\ \textcolor{stringliteral}{\ \ \ \ \ \ \ \ processor:\ The\ image\ processor\ object.}}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00126}00126\ \textcolor{stringliteral}{\ \ \ \ \ \ \ \ grid\_pinpoints\ (str):\ A\ string\ representation\ of\ a\ list\ of\ possible\ resolutions.}}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00127}00127\ \textcolor{stringliteral}{}}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00128}00128\ \textcolor{stringliteral}{\ \ \ \ Returns:}}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00129}00129\ \textcolor{stringliteral}{\ \ \ \ \ \ \ \ torch.Tensor:\ A\ tensor\ containing\ the\ processed\ image\ patches.}}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00130}00130\ \textcolor{stringliteral}{\ \ \ \ "{}"{}"{}}}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00131}00131\ \ \ \ \ \textcolor{keywordflow}{if}\ type(grid\_pinpoints)\ \textcolor{keywordflow}{is}\ list:}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00132}00132\ \ \ \ \ \ \ \ \ possible\_resolutions\ =\ grid\_pinpoints}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00133}00133\ \ \ \ \ \textcolor{keywordflow}{else}:}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00134}00134\ \ \ \ \ \ \ \ \ possible\_resolutions\ =\ ast.literal\_eval(grid\_pinpoints)}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00135}00135\ \ \ \ \ best\_resolution\ =\ \mbox{\hyperlink{namespacellava_1_1mm__utils_a4ca4286048f7be2f9e5f0b93e30b7672}{select\_best\_resolution}}(image.size,\ possible\_resolutions)}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00136}00136\ \ \ \ \ image\_padded\ =\ \mbox{\hyperlink{namespacellava_1_1mm__utils_a40cefe125ab588aa0efee388f7b7108f}{resize\_and\_pad\_image}}(image,\ best\_resolution)}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00137}00137\ }
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00138}00138\ \ \ \ \ patches\ =\ \mbox{\hyperlink{namespacellava_1_1mm__utils_ae4ccc6abdd03caf02e2ac9ca1bb2af04}{divide\_to\_patches}}(image\_padded,\ processor.crop\_size[\textcolor{stringliteral}{'height'}])}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00139}00139\ }
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00140}00140\ \ \ \ \ image\_original\_resize\ =\ image.resize((processor.size[\textcolor{stringliteral}{'shortest\_edge'}],\ processor.size[\textcolor{stringliteral}{'shortest\_edge'}]))}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00141}00141\ }
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00142}00142\ \ \ \ \ image\_patches\ =\ [image\_original\_resize]\ +\ patches}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00143}00143\ \ \ \ \ image\_patches\ =\ [processor.preprocess(image\_patch,\ return\_tensors=\textcolor{stringliteral}{'pt'})[\textcolor{stringliteral}{'pixel\_values'}][0]}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00144}00144\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ image\_patch\ \textcolor{keywordflow}{in}\ image\_patches]}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00145}00145\ \ \ \ \ \textcolor{keywordflow}{return}\ torch.stack(image\_patches,\ dim=0)}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00146}00146\ }
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00147}00147\ }
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00148}\mbox{\hyperlink{namespacellava_1_1mm__utils_ab8264cd3605f1f3e0c89dd2df43afa98}{00148}}\ \textcolor{keyword}{def\ }\mbox{\hyperlink{namespacellava_1_1mm__utils_ab8264cd3605f1f3e0c89dd2df43afa98}{load\_image\_from\_base64}}(image):}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00149}00149\ \ \ \ \ \textcolor{keywordflow}{return}\ Image.open(BytesIO(base64.b64decode(image)))}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00150}00150\ }
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00151}00151\ }
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00152}\mbox{\hyperlink{namespacellava_1_1mm__utils_a1d0ecbfdc5e6bdbb456d37123264b364}{00152}}\ \textcolor{keyword}{def\ }\mbox{\hyperlink{namespacellava_1_1mm__utils_a1d0ecbfdc5e6bdbb456d37123264b364}{expand2square}}(pil\_img,\ background\_color):}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00153}00153\ \ \ \ \ width,\ height\ =\ pil\_img.size}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00154}00154\ \ \ \ \ \textcolor{keywordflow}{if}\ width\ ==\ height:}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00155}00155\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ pil\_img}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00156}00156\ \ \ \ \ \textcolor{keywordflow}{elif}\ width\ >\ height:}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00157}00157\ \ \ \ \ \ \ \ \ result\ =\ Image.new(pil\_img.mode,\ (width,\ width),\ background\_color)}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00158}00158\ \ \ \ \ \ \ \ \ result.paste(pil\_img,\ (0,\ (width\ -\/\ height)\ //\ 2))}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00159}00159\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ result}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00160}00160\ \ \ \ \ \textcolor{keywordflow}{else}:}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00161}00161\ \ \ \ \ \ \ \ \ result\ =\ Image.new(pil\_img.mode,\ (height,\ height),\ background\_color)}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00162}00162\ \ \ \ \ \ \ \ \ result.paste(pil\_img,\ ((height\ -\/\ width)\ //\ 2,\ 0))}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00163}00163\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ result}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00164}00164\ }
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00165}00165\ }
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00166}\mbox{\hyperlink{namespacellava_1_1mm__utils_aa18f4829bc6b5580349eff790660999c}{00166}}\ \textcolor{keyword}{def\ }\mbox{\hyperlink{namespacellava_1_1mm__utils_aa18f4829bc6b5580349eff790660999c}{process\_images}}(images,\ image\_processor,\ model\_cfg):}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00167}00167\ \ \ \ \ image\_aspect\_ratio\ =\ getattr(model\_cfg,\ \textcolor{stringliteral}{"{}image\_aspect\_ratio"{}},\ \textcolor{keywordtype}{None})}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00168}00168\ \ \ \ \ new\_images\ =\ []}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00169}00169\ \ \ \ \ \textcolor{keywordflow}{if}\ image\_aspect\_ratio\ ==\ \textcolor{stringliteral}{'pad'}:}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00170}00170\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ image\ \textcolor{keywordflow}{in}\ images:}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00171}00171\ \ \ \ \ \ \ \ \ \ \ \ \ image\ =\ \mbox{\hyperlink{namespacellava_1_1mm__utils_a1d0ecbfdc5e6bdbb456d37123264b364}{expand2square}}(image,\ tuple(int(x*255)\ \textcolor{keywordflow}{for}\ x\ \textcolor{keywordflow}{in}\ image\_processor.image\_mean))}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00172}00172\ \ \ \ \ \ \ \ \ \ \ \ \ image\ =\ image\_processor.preprocess(image,\ return\_tensors=\textcolor{stringliteral}{'pt'})[\textcolor{stringliteral}{'pixel\_values'}][0]}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00173}00173\ \ \ \ \ \ \ \ \ \ \ \ \ new\_images.append(image)}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00174}00174\ \ \ \ \ \textcolor{keywordflow}{elif}\ image\_aspect\_ratio\ ==\ \textcolor{stringliteral}{"{}anyres"{}}:}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00175}00175\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ image\ \textcolor{keywordflow}{in}\ images:}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00176}00176\ \ \ \ \ \ \ \ \ \ \ \ \ image\ =\ \mbox{\hyperlink{namespacellava_1_1mm__utils_adbf2269511a2260e914ea2b43935166a}{process\_anyres\_image}}(image,\ image\_processor,\ model\_cfg.image\_grid\_pinpoints)}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00177}00177\ \ \ \ \ \ \ \ \ \ \ \ \ new\_images.append(image)}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00178}00178\ \ \ \ \ \textcolor{keywordflow}{else}:}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00179}00179\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ image\_processor(images,\ return\_tensors=\textcolor{stringliteral}{'pt'})[\textcolor{stringliteral}{'pixel\_values'}]}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00180}00180\ \ \ \ \ \textcolor{keywordflow}{if}\ all(x.shape\ ==\ new\_images[0].shape\ \textcolor{keywordflow}{for}\ x\ \textcolor{keywordflow}{in}\ new\_images):}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00181}00181\ \ \ \ \ \ \ \ \ new\_images\ =\ torch.stack(new\_images,\ dim=0)}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00182}00182\ \ \ \ \ \textcolor{keywordflow}{return}\ new\_images}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00183}00183\ }
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00184}00184\ }
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00185}\mbox{\hyperlink{namespacellava_1_1mm__utils_a26f403c48d039c2e34ca945efcab7437}{00185}}\ \textcolor{keyword}{def\ }\mbox{\hyperlink{namespacellava_1_1mm__utils_a26f403c48d039c2e34ca945efcab7437}{tokenizer\_image\_token}}(prompt,\ tokenizer,\ image\_token\_index=IMAGE\_TOKEN\_INDEX,\ return\_tensors=None):}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00186}00186\ \ \ \ \ prompt\_chunks\ =\ [tokenizer(chunk).input\_ids\ \textcolor{keywordflow}{for}\ chunk\ \textcolor{keywordflow}{in}\ prompt.split(\textcolor{stringliteral}{'<image>'})]}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00187}00187\ }
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00188}00188\ \ \ \ \ \textcolor{keyword}{def\ }insert\_separator(X,\ sep):}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00189}00189\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ [ele\ \textcolor{keywordflow}{for}\ sublist\ \textcolor{keywordflow}{in}\ zip(X,\ [sep]*len(X))\ \textcolor{keywordflow}{for}\ ele\ \textcolor{keywordflow}{in}\ sublist][:-\/1]}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00190}00190\ }
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00191}00191\ \ \ \ \ input\_ids\ =\ []}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00192}00192\ \ \ \ \ offset\ =\ 0}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00193}00193\ \ \ \ \ \textcolor{keywordflow}{if}\ len(prompt\_chunks)\ >\ 0\ \textcolor{keywordflow}{and}\ len(prompt\_chunks[0])\ >\ 0\ \textcolor{keywordflow}{and}\ prompt\_chunks[0][0]\ ==\ tokenizer.bos\_token\_id:}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00194}00194\ \ \ \ \ \ \ \ \ offset\ =\ 1}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00195}00195\ \ \ \ \ \ \ \ \ input\_ids.append(prompt\_chunks[0][0])}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00196}00196\ }
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00197}00197\ \ \ \ \ \textcolor{keywordflow}{for}\ x\ \textcolor{keywordflow}{in}\ insert\_separator(prompt\_chunks,\ [image\_token\_index]\ *\ (offset\ +\ 1)):}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00198}00198\ \ \ \ \ \ \ \ \ input\_ids.extend(x[offset:])}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00199}00199\ }
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00200}00200\ \ \ \ \ \textcolor{keywordflow}{if}\ return\_tensors\ \textcolor{keywordflow}{is}\ \textcolor{keywordflow}{not}\ \textcolor{keywordtype}{None}:}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00201}00201\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ return\_tensors\ ==\ \textcolor{stringliteral}{'pt'}:}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00202}00202\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ torch.tensor(input\_ids,\ dtype=torch.long)}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00203}00203\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{raise}\ ValueError(f\textcolor{stringliteral}{'Unsupported\ tensor\ type:\ \{return\_tensors\}'})}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00204}00204\ \ \ \ \ \textcolor{keywordflow}{return}\ input\_ids}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00205}00205\ }
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00206}00206\ }
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00207}\mbox{\hyperlink{namespacellava_1_1mm__utils_adf5a7956028b072597a587f674f1cf36}{00207}}\ \textcolor{keyword}{def\ }\mbox{\hyperlink{namespacellava_1_1mm__utils_adf5a7956028b072597a587f674f1cf36}{get\_model\_name\_from\_path}}(model\_path):}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00208}00208\ \ \ \ \ model\_path\ =\ model\_path.strip(\textcolor{stringliteral}{"{}/"{}})}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00209}00209\ \ \ \ \ model\_paths\ =\ model\_path.split(\textcolor{stringliteral}{"{}/"{}})}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00210}00210\ \ \ \ \ \textcolor{keywordflow}{if}\ model\_paths[-\/1].startswith(\textcolor{stringliteral}{'checkpoint-\/'}):}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00211}00211\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ model\_paths[-\/2]\ +\ \textcolor{stringliteral}{"{}\_"{}}\ +\ model\_paths[-\/1]}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00212}00212\ \ \ \ \ \textcolor{keywordflow}{else}:}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00213}00213\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ model\_paths[-\/1]}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00214}00214\ }
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00215}\mbox{\hyperlink{classllava_1_1mm__utils_1_1_keywords_stopping_criteria}{00215}}\ \textcolor{keyword}{class\ }\mbox{\hyperlink{classllava_1_1mm__utils_1_1_keywords_stopping_criteria}{KeywordsStoppingCriteria}}(StoppingCriteria):}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00216}\mbox{\hyperlink{classllava_1_1mm__utils_1_1_keywords_stopping_criteria_adfcd9e507e6e3a289aac2a7f15cd30e0}{00216}}\ \ \ \ \ \textcolor{keyword}{def\ }\mbox{\hyperlink{classllava_1_1mm__utils_1_1_keywords_stopping_criteria_adfcd9e507e6e3a289aac2a7f15cd30e0}{\_\_init\_\_}}(self,\ keywords,\ tokenizer,\ input\_ids):}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00217}\mbox{\hyperlink{classllava_1_1mm__utils_1_1_keywords_stopping_criteria_a5ad2b72382047b426b5ec2aaad4bcf24}{00217}}\ \ \ \ \ \ \ \ \ self.\mbox{\hyperlink{classllava_1_1mm__utils_1_1_keywords_stopping_criteria_a5ad2b72382047b426b5ec2aaad4bcf24}{keywords}}\ =\ keywords}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00218}\mbox{\hyperlink{classllava_1_1mm__utils_1_1_keywords_stopping_criteria_a63257121d81b383ae84db4657f433ea5}{00218}}\ \ \ \ \ \ \ \ \ self.\mbox{\hyperlink{classllava_1_1mm__utils_1_1_keywords_stopping_criteria_a63257121d81b383ae84db4657f433ea5}{keyword\_ids}}\ =\ []}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00219}\mbox{\hyperlink{classllava_1_1mm__utils_1_1_keywords_stopping_criteria_a3c328363eb4fbd38a51ab07523f772a4}{00219}}\ \ \ \ \ \ \ \ \ self.\mbox{\hyperlink{classllava_1_1mm__utils_1_1_keywords_stopping_criteria_a3c328363eb4fbd38a51ab07523f772a4}{max\_keyword\_len}}\ =\ 0}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00220}00220\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ keyword\ \textcolor{keywordflow}{in}\ keywords:}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00221}00221\ \ \ \ \ \ \ \ \ \ \ \ \ cur\_keyword\_ids\ =\ \mbox{\hyperlink{classllava_1_1mm__utils_1_1_keywords_stopping_criteria_a77b250cb3ea2dd48bf7c70e713e75a50}{tokenizer}}(keyword).input\_ids}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00222}00222\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ len(cur\_keyword\_ids)\ >\ 1\ \textcolor{keywordflow}{and}\ cur\_keyword\_ids[0]\ ==\ tokenizer.bos\_token\_id:}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00223}00223\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ cur\_keyword\_ids\ =\ cur\_keyword\_ids[1:]}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00224}00224\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ len(cur\_keyword\_ids)\ >\ self.\mbox{\hyperlink{classllava_1_1mm__utils_1_1_keywords_stopping_criteria_a3c328363eb4fbd38a51ab07523f772a4}{max\_keyword\_len}}:}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00225}00225\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ self.\mbox{\hyperlink{classllava_1_1mm__utils_1_1_keywords_stopping_criteria_a3c328363eb4fbd38a51ab07523f772a4}{max\_keyword\_len}}\ =\ len(cur\_keyword\_ids)}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00226}00226\ \ \ \ \ \ \ \ \ \ \ \ \ self.\mbox{\hyperlink{classllava_1_1mm__utils_1_1_keywords_stopping_criteria_a63257121d81b383ae84db4657f433ea5}{keyword\_ids}}.append(torch.tensor(cur\_keyword\_ids))}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00227}\mbox{\hyperlink{classllava_1_1mm__utils_1_1_keywords_stopping_criteria_a77b250cb3ea2dd48bf7c70e713e75a50}{00227}}\ \ \ \ \ \ \ \ \ self.\mbox{\hyperlink{classllava_1_1mm__utils_1_1_keywords_stopping_criteria_a77b250cb3ea2dd48bf7c70e713e75a50}{tokenizer}}\ =\ tokenizer}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00228}\mbox{\hyperlink{classllava_1_1mm__utils_1_1_keywords_stopping_criteria_acf2d62db24cac1f8eed20b8506522610}{00228}}\ \ \ \ \ \ \ \ \ self.\mbox{\hyperlink{classllava_1_1mm__utils_1_1_keywords_stopping_criteria_acf2d62db24cac1f8eed20b8506522610}{start\_len}}\ =\ input\_ids.shape[1]}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00229}00229\ \ \ \ \ }
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00230}\mbox{\hyperlink{classllava_1_1mm__utils_1_1_keywords_stopping_criteria_a0a7272927918a9a84371ddec56661557}{00230}}\ \ \ \ \ \textcolor{keyword}{def\ }\mbox{\hyperlink{classllava_1_1mm__utils_1_1_keywords_stopping_criteria_a0a7272927918a9a84371ddec56661557}{call\_for\_batch}}(self,\ output\_ids:\ torch.LongTensor,\ scores:\ torch.FloatTensor,\ **kwargs)\ -\/>\ bool:}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00231}00231\ \ \ \ \ \ \ \ \ offset\ =\ min(output\_ids.shape[1]\ -\/\ self.\mbox{\hyperlink{classllava_1_1mm__utils_1_1_keywords_stopping_criteria_acf2d62db24cac1f8eed20b8506522610}{start\_len}},\ self.\mbox{\hyperlink{classllava_1_1mm__utils_1_1_keywords_stopping_criteria_a3c328363eb4fbd38a51ab07523f772a4}{max\_keyword\_len}})}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00232}00232\ \ \ \ \ \ \ \ \ self.\mbox{\hyperlink{classllava_1_1mm__utils_1_1_keywords_stopping_criteria_a63257121d81b383ae84db4657f433ea5}{keyword\_ids}}\ =\ [keyword\_id.to(output\_ids.device)\ \textcolor{keywordflow}{for}\ keyword\_id\ \textcolor{keywordflow}{in}\ self.\mbox{\hyperlink{classllava_1_1mm__utils_1_1_keywords_stopping_criteria_a63257121d81b383ae84db4657f433ea5}{keyword\_ids}}]}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00233}00233\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ keyword\_id\ \textcolor{keywordflow}{in}\ self.\mbox{\hyperlink{classllava_1_1mm__utils_1_1_keywords_stopping_criteria_a63257121d81b383ae84db4657f433ea5}{keyword\_ids}}:}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00234}00234\ \ \ \ \ \ \ \ \ \ \ \ \ truncated\_output\_ids\ =\ output\_ids[0,\ -\/keyword\_id.shape[0]:]}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00235}00235\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ torch.equal(truncated\_output\_ids,\ keyword\_id):}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00236}00236\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{True}}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00237}00237\ \ \ \ \ \ \ \ \ outputs\ =\ self.\mbox{\hyperlink{classllava_1_1mm__utils_1_1_keywords_stopping_criteria_a77b250cb3ea2dd48bf7c70e713e75a50}{tokenizer}}.batch\_decode(output\_ids[:,\ -\/offset:],\ skip\_special\_tokens=\textcolor{keyword}{True})[0]}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00238}00238\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ keyword\ \textcolor{keywordflow}{in}\ self.\mbox{\hyperlink{classllava_1_1mm__utils_1_1_keywords_stopping_criteria_a5ad2b72382047b426b5ec2aaad4bcf24}{keywords}}:}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00239}00239\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ keyword\ \textcolor{keywordflow}{in}\ outputs:}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00240}00240\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{True}}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00241}00241\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{False}}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00242}00242\ \ \ \ \ }
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00243}\mbox{\hyperlink{classllava_1_1mm__utils_1_1_keywords_stopping_criteria_a867b9f5c74d8b6ff947cdef1e44c3500}{00243}}\ \ \ \ \ \textcolor{keyword}{def\ }\mbox{\hyperlink{classllava_1_1mm__utils_1_1_keywords_stopping_criteria_a867b9f5c74d8b6ff947cdef1e44c3500}{\_\_call\_\_}}(self,\ output\_ids:\ torch.LongTensor,\ scores:\ torch.FloatTensor,\ **kwargs)\ -\/>\ bool:}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00244}00244\ \ \ \ \ \ \ \ \ outputs\ =\ []}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00245}00245\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ i\ \textcolor{keywordflow}{in}\ range(output\_ids.shape[0]):}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00246}00246\ \ \ \ \ \ \ \ \ \ \ \ \ outputs.append(self.\mbox{\hyperlink{classllava_1_1mm__utils_1_1_keywords_stopping_criteria_a0a7272927918a9a84371ddec56661557}{call\_for\_batch}}(output\_ids[i].unsqueeze(0),\ scores))}
\DoxyCodeLine{\Hypertarget{mm__utils_8py_source_l00247}00247\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ all(outputs)}

\end{DoxyCode}
