\doxysection{llava.\+mm\+\_\+utils Namespace Reference}
\hypertarget{namespacellava_1_1mm__utils}{}\label{namespacellava_1_1mm__utils}\index{llava.mm\_utils@{llava.mm\_utils}}
\doxysubsubsection*{Classes}
\begin{DoxyCompactItemize}
\item 
class \mbox{\hyperlink{classllava_1_1mm__utils_1_1_keywords_stopping_criteria}{Keywords\+Stopping\+Criteria}}
\end{DoxyCompactItemize}
\doxysubsubsection*{Functions}
\begin{DoxyCompactItemize}
\item 
\mbox{\hyperlink{namespacellava_1_1mm__utils_a4ca4286048f7be2f9e5f0b93e30b7672}{select\+\_\+best\+\_\+resolution}} (original\+\_\+size, possible\+\_\+resolutions)
\item 
\mbox{\hyperlink{namespacellava_1_1mm__utils_a40cefe125ab588aa0efee388f7b7108f}{resize\+\_\+and\+\_\+pad\+\_\+image}} (image, target\+\_\+resolution)
\item 
\mbox{\hyperlink{namespacellava_1_1mm__utils_ae4ccc6abdd03caf02e2ac9ca1bb2af04}{divide\+\_\+to\+\_\+patches}} (image, patch\+\_\+size)
\item 
\mbox{\hyperlink{namespacellava_1_1mm__utils_a60a4bdd48b49a10221d254162944b30c}{get\+\_\+anyres\+\_\+image\+\_\+grid\+\_\+shape}} (image\+\_\+size, grid\+\_\+pinpoints, patch\+\_\+size)
\item 
\mbox{\hyperlink{namespacellava_1_1mm__utils_adbf2269511a2260e914ea2b43935166a}{process\+\_\+anyres\+\_\+image}} (image, processor, grid\+\_\+pinpoints)
\item 
\mbox{\hyperlink{namespacellava_1_1mm__utils_ab8264cd3605f1f3e0c89dd2df43afa98}{load\+\_\+image\+\_\+from\+\_\+base64}} (image)
\item 
\mbox{\hyperlink{namespacellava_1_1mm__utils_a1d0ecbfdc5e6bdbb456d37123264b364}{expand2square}} (pil\+\_\+img, background\+\_\+color)
\item 
\mbox{\hyperlink{namespacellava_1_1mm__utils_aa18f4829bc6b5580349eff790660999c}{process\+\_\+images}} (images, image\+\_\+processor, model\+\_\+cfg)
\item 
\mbox{\hyperlink{namespacellava_1_1mm__utils_a26f403c48d039c2e34ca945efcab7437}{tokenizer\+\_\+image\+\_\+token}} (prompt, tokenizer, image\+\_\+token\+\_\+index=IMAGE\+\_\+\+TOKEN\+\_\+\+INDEX, return\+\_\+tensors=None)
\item 
\mbox{\hyperlink{namespacellava_1_1mm__utils_adf5a7956028b072597a587f674f1cf36}{get\+\_\+model\+\_\+name\+\_\+from\+\_\+path}} (model\+\_\+path)
\end{DoxyCompactItemize}


\doxysubsection{Function Documentation}
\Hypertarget{namespacellava_1_1mm__utils_ae4ccc6abdd03caf02e2ac9ca1bb2af04}\index{llava.mm\_utils@{llava.mm\_utils}!divide\_to\_patches@{divide\_to\_patches}}
\index{divide\_to\_patches@{divide\_to\_patches}!llava.mm\_utils@{llava.mm\_utils}}
\doxysubsubsection{\texorpdfstring{divide\_to\_patches()}{divide\_to\_patches()}}
{\footnotesize\ttfamily \label{namespacellava_1_1mm__utils_ae4ccc6abdd03caf02e2ac9ca1bb2af04} 
llava.\+mm\+\_\+utils.\+divide\+\_\+to\+\_\+patches (\begin{DoxyParamCaption}\item[{}]{image}{, }\item[{}]{patch\+\_\+size}{}\end{DoxyParamCaption})}

\begin{DoxyVerb}Divides an image into patches of a specified size.

Args:
    image (PIL.Image.Image): The input image.
    patch_size (int): The size of each patch.

Returns:
    list: A list of PIL.Image.Image objects representing the patches.
\end{DoxyVerb}
 

Definition at line \mbox{\hyperlink{mm__utils_8py_source_l00077}{77}} of file \mbox{\hyperlink{mm__utils_8py_source}{mm\+\_\+utils.\+py}}.


\begin{DoxyCode}{0}
\DoxyCodeLine{00077\ \textcolor{keyword}{def\ }divide\_to\_patches(image,\ patch\_size):}
\DoxyCodeLine{00078\ \ \ \ \ \textcolor{stringliteral}{"{}"{}"{}}}
\DoxyCodeLine{00079\ \textcolor{stringliteral}{\ \ \ \ Divides\ an\ image\ into\ patches\ of\ a\ specified\ size.}}
\DoxyCodeLine{00080\ \textcolor{stringliteral}{}}
\DoxyCodeLine{00081\ \textcolor{stringliteral}{\ \ \ \ Args:}}
\DoxyCodeLine{00082\ \textcolor{stringliteral}{\ \ \ \ \ \ \ \ image\ (PIL.Image.Image):\ The\ input\ image.}}
\DoxyCodeLine{00083\ \textcolor{stringliteral}{\ \ \ \ \ \ \ \ patch\_size\ (int):\ The\ size\ of\ each\ patch.}}
\DoxyCodeLine{00084\ \textcolor{stringliteral}{}}
\DoxyCodeLine{00085\ \textcolor{stringliteral}{\ \ \ \ Returns:}}
\DoxyCodeLine{00086\ \textcolor{stringliteral}{\ \ \ \ \ \ \ \ list:\ A\ list\ of\ PIL.Image.Image\ objects\ representing\ the\ patches.}}
\DoxyCodeLine{00087\ \textcolor{stringliteral}{\ \ \ \ "{}"{}"{}}}
\DoxyCodeLine{00088\ \ \ \ \ patches\ =\ []}
\DoxyCodeLine{00089\ \ \ \ \ width,\ height\ =\ image.size}
\DoxyCodeLine{00090\ \ \ \ \ \textcolor{keywordflow}{for}\ i\ \textcolor{keywordflow}{in}\ range(0,\ height,\ patch\_size):}
\DoxyCodeLine{00091\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ j\ \textcolor{keywordflow}{in}\ range(0,\ width,\ patch\_size):}
\DoxyCodeLine{00092\ \ \ \ \ \ \ \ \ \ \ \ \ box\ =\ (j,\ i,\ j\ +\ patch\_size,\ i\ +\ patch\_size)}
\DoxyCodeLine{00093\ \ \ \ \ \ \ \ \ \ \ \ \ patch\ =\ image.crop(box)}
\DoxyCodeLine{00094\ \ \ \ \ \ \ \ \ \ \ \ \ patches.append(patch)}
\DoxyCodeLine{00095\ }
\DoxyCodeLine{00096\ \ \ \ \ \textcolor{keywordflow}{return}\ patches}
\DoxyCodeLine{00097\ }
\DoxyCodeLine{00098\ }

\end{DoxyCode}
Here is the caller graph for this function\+:
% FIG 0
\Hypertarget{namespacellava_1_1mm__utils_a1d0ecbfdc5e6bdbb456d37123264b364}\index{llava.mm\_utils@{llava.mm\_utils}!expand2square@{expand2square}}
\index{expand2square@{expand2square}!llava.mm\_utils@{llava.mm\_utils}}
\doxysubsubsection{\texorpdfstring{expand2square()}{expand2square()}}
{\footnotesize\ttfamily \label{namespacellava_1_1mm__utils_a1d0ecbfdc5e6bdbb456d37123264b364} 
llava.\+mm\+\_\+utils.\+expand2square (\begin{DoxyParamCaption}\item[{}]{pil\+\_\+img}{, }\item[{}]{background\+\_\+color}{}\end{DoxyParamCaption})}



Definition at line \mbox{\hyperlink{mm__utils_8py_source_l00152}{152}} of file \mbox{\hyperlink{mm__utils_8py_source}{mm\+\_\+utils.\+py}}.


\begin{DoxyCode}{0}
\DoxyCodeLine{00152\ \textcolor{keyword}{def\ }expand2square(pil\_img,\ background\_color):}
\DoxyCodeLine{00153\ \ \ \ \ width,\ height\ =\ pil\_img.size}
\DoxyCodeLine{00154\ \ \ \ \ \textcolor{keywordflow}{if}\ width\ ==\ height:}
\DoxyCodeLine{00155\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ pil\_img}
\DoxyCodeLine{00156\ \ \ \ \ \textcolor{keywordflow}{elif}\ width\ >\ height:}
\DoxyCodeLine{00157\ \ \ \ \ \ \ \ \ result\ =\ Image.new(pil\_img.mode,\ (width,\ width),\ background\_color)}
\DoxyCodeLine{00158\ \ \ \ \ \ \ \ \ result.paste(pil\_img,\ (0,\ (width\ -\/\ height)\ //\ 2))}
\DoxyCodeLine{00159\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ result}
\DoxyCodeLine{00160\ \ \ \ \ \textcolor{keywordflow}{else}:}
\DoxyCodeLine{00161\ \ \ \ \ \ \ \ \ result\ =\ Image.new(pil\_img.mode,\ (height,\ height),\ background\_color)}
\DoxyCodeLine{00162\ \ \ \ \ \ \ \ \ result.paste(pil\_img,\ ((height\ -\/\ width)\ //\ 2,\ 0))}
\DoxyCodeLine{00163\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ result}
\DoxyCodeLine{00164\ }
\DoxyCodeLine{00165\ }

\end{DoxyCode}
Here is the caller graph for this function\+:
% FIG 1
\Hypertarget{namespacellava_1_1mm__utils_a60a4bdd48b49a10221d254162944b30c}\index{llava.mm\_utils@{llava.mm\_utils}!get\_anyres\_image\_grid\_shape@{get\_anyres\_image\_grid\_shape}}
\index{get\_anyres\_image\_grid\_shape@{get\_anyres\_image\_grid\_shape}!llava.mm\_utils@{llava.mm\_utils}}
\doxysubsubsection{\texorpdfstring{get\_anyres\_image\_grid\_shape()}{get\_anyres\_image\_grid\_shape()}}
{\footnotesize\ttfamily \label{namespacellava_1_1mm__utils_a60a4bdd48b49a10221d254162944b30c} 
llava.\+mm\+\_\+utils.\+get\+\_\+anyres\+\_\+image\+\_\+grid\+\_\+shape (\begin{DoxyParamCaption}\item[{}]{image\+\_\+size}{, }\item[{}]{grid\+\_\+pinpoints}{, }\item[{}]{patch\+\_\+size}{}\end{DoxyParamCaption})}

\begin{DoxyVerb}Calculate the shape of the image patch grid after the preprocessing for images of any resolution.

Args:
    image_size (tuple): The size of the input image in the format (width, height).
    grid_pinpoints (str): A string representation of a list of possible resolutions.
    patch_size (int): The size of each image patch.

Returns:
    tuple: The shape of the image patch grid in the format (width, height).
\end{DoxyVerb}
 

Definition at line \mbox{\hyperlink{mm__utils_8py_source_l00099}{99}} of file \mbox{\hyperlink{mm__utils_8py_source}{mm\+\_\+utils.\+py}}.


\begin{DoxyCode}{0}
\DoxyCodeLine{00099\ \textcolor{keyword}{def\ }get\_anyres\_image\_grid\_shape(image\_size,\ grid\_pinpoints,\ patch\_size):}
\DoxyCodeLine{00100\ \ \ \ \ \textcolor{stringliteral}{"{}"{}"{}}}
\DoxyCodeLine{00101\ \textcolor{stringliteral}{\ \ \ \ Calculate\ the\ shape\ of\ the\ image\ patch\ grid\ after\ the\ preprocessing\ for\ images\ of\ any\ resolution.}}
\DoxyCodeLine{00102\ \textcolor{stringliteral}{}}
\DoxyCodeLine{00103\ \textcolor{stringliteral}{\ \ \ \ Args:}}
\DoxyCodeLine{00104\ \textcolor{stringliteral}{\ \ \ \ \ \ \ \ image\_size\ (tuple):\ The\ size\ of\ the\ input\ image\ in\ the\ format\ (width,\ height).}}
\DoxyCodeLine{00105\ \textcolor{stringliteral}{\ \ \ \ \ \ \ \ grid\_pinpoints\ (str):\ A\ string\ representation\ of\ a\ list\ of\ possible\ resolutions.}}
\DoxyCodeLine{00106\ \textcolor{stringliteral}{\ \ \ \ \ \ \ \ patch\_size\ (int):\ The\ size\ of\ each\ image\ patch.}}
\DoxyCodeLine{00107\ \textcolor{stringliteral}{}}
\DoxyCodeLine{00108\ \textcolor{stringliteral}{\ \ \ \ Returns:}}
\DoxyCodeLine{00109\ \textcolor{stringliteral}{\ \ \ \ \ \ \ \ tuple:\ The\ shape\ of\ the\ image\ patch\ grid\ in\ the\ format\ (width,\ height).}}
\DoxyCodeLine{00110\ \textcolor{stringliteral}{\ \ \ \ "{}"{}"{}}}
\DoxyCodeLine{00111\ \ \ \ \ \textcolor{keywordflow}{if}\ type(grid\_pinpoints)\ \textcolor{keywordflow}{is}\ list:}
\DoxyCodeLine{00112\ \ \ \ \ \ \ \ \ possible\_resolutions\ =\ grid\_pinpoints}
\DoxyCodeLine{00113\ \ \ \ \ \textcolor{keywordflow}{else}:}
\DoxyCodeLine{00114\ \ \ \ \ \ \ \ \ possible\_resolutions\ =\ ast.literal\_eval(grid\_pinpoints)}
\DoxyCodeLine{00115\ \ \ \ \ width,\ height\ =\ select\_best\_resolution(image\_size,\ possible\_resolutions)}
\DoxyCodeLine{00116\ \ \ \ \ \textcolor{keywordflow}{return}\ width\ //\ patch\_size,\ height\ //\ patch\_size}
\DoxyCodeLine{00117\ }
\DoxyCodeLine{00118\ }

\end{DoxyCode}
Here is the call graph for this function\+:
% FIG 2
\Hypertarget{namespacellava_1_1mm__utils_adf5a7956028b072597a587f674f1cf36}\index{llava.mm\_utils@{llava.mm\_utils}!get\_model\_name\_from\_path@{get\_model\_name\_from\_path}}
\index{get\_model\_name\_from\_path@{get\_model\_name\_from\_path}!llava.mm\_utils@{llava.mm\_utils}}
\doxysubsubsection{\texorpdfstring{get\_model\_name\_from\_path()}{get\_model\_name\_from\_path()}}
{\footnotesize\ttfamily \label{namespacellava_1_1mm__utils_adf5a7956028b072597a587f674f1cf36} 
llava.\+mm\+\_\+utils.\+get\+\_\+model\+\_\+name\+\_\+from\+\_\+path (\begin{DoxyParamCaption}\item[{}]{model\+\_\+path}{}\end{DoxyParamCaption})}



Definition at line \mbox{\hyperlink{mm__utils_8py_source_l00207}{207}} of file \mbox{\hyperlink{mm__utils_8py_source}{mm\+\_\+utils.\+py}}.


\begin{DoxyCode}{0}
\DoxyCodeLine{00207\ \textcolor{keyword}{def\ }get\_model\_name\_from\_path(model\_path):}
\DoxyCodeLine{00208\ \ \ \ \ model\_path\ =\ model\_path.strip(\textcolor{stringliteral}{"{}/"{}})}
\DoxyCodeLine{00209\ \ \ \ \ model\_paths\ =\ model\_path.split(\textcolor{stringliteral}{"{}/"{}})}
\DoxyCodeLine{00210\ \ \ \ \ \textcolor{keywordflow}{if}\ model\_paths[-\/1].startswith(\textcolor{stringliteral}{'checkpoint-\/'}):}
\DoxyCodeLine{00211\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ model\_paths[-\/2]\ +\ \textcolor{stringliteral}{"{}\_"{}}\ +\ model\_paths[-\/1]}
\DoxyCodeLine{00212\ \ \ \ \ \textcolor{keywordflow}{else}:}
\DoxyCodeLine{00213\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ model\_paths[-\/1]}
\DoxyCodeLine{00214\ }

\end{DoxyCode}
\Hypertarget{namespacellava_1_1mm__utils_ab8264cd3605f1f3e0c89dd2df43afa98}\index{llava.mm\_utils@{llava.mm\_utils}!load\_image\_from\_base64@{load\_image\_from\_base64}}
\index{load\_image\_from\_base64@{load\_image\_from\_base64}!llava.mm\_utils@{llava.mm\_utils}}
\doxysubsubsection{\texorpdfstring{load\_image\_from\_base64()}{load\_image\_from\_base64()}}
{\footnotesize\ttfamily \label{namespacellava_1_1mm__utils_ab8264cd3605f1f3e0c89dd2df43afa98} 
llava.\+mm\+\_\+utils.\+load\+\_\+image\+\_\+from\+\_\+base64 (\begin{DoxyParamCaption}\item[{}]{image}{}\end{DoxyParamCaption})}



Definition at line \mbox{\hyperlink{mm__utils_8py_source_l00148}{148}} of file \mbox{\hyperlink{mm__utils_8py_source}{mm\+\_\+utils.\+py}}.


\begin{DoxyCode}{0}
\DoxyCodeLine{00148\ \textcolor{keyword}{def\ }load\_image\_from\_base64(image):}
\DoxyCodeLine{00149\ \ \ \ \ \textcolor{keywordflow}{return}\ Image.open(BytesIO(base64.b64decode(image)))}
\DoxyCodeLine{00150\ }
\DoxyCodeLine{00151\ }

\end{DoxyCode}
\Hypertarget{namespacellava_1_1mm__utils_adbf2269511a2260e914ea2b43935166a}\index{llava.mm\_utils@{llava.mm\_utils}!process\_anyres\_image@{process\_anyres\_image}}
\index{process\_anyres\_image@{process\_anyres\_image}!llava.mm\_utils@{llava.mm\_utils}}
\doxysubsubsection{\texorpdfstring{process\_anyres\_image()}{process\_anyres\_image()}}
{\footnotesize\ttfamily \label{namespacellava_1_1mm__utils_adbf2269511a2260e914ea2b43935166a} 
llava.\+mm\+\_\+utils.\+process\+\_\+anyres\+\_\+image (\begin{DoxyParamCaption}\item[{}]{image}{, }\item[{}]{processor}{, }\item[{}]{grid\+\_\+pinpoints}{}\end{DoxyParamCaption})}

\begin{DoxyVerb}Process an image with variable resolutions.

Args:
    image (PIL.Image.Image): The input image to be processed.
    processor: The image processor object.
    grid_pinpoints (str): A string representation of a list of possible resolutions.

Returns:
    torch.Tensor: A tensor containing the processed image patches.
\end{DoxyVerb}
 

Definition at line \mbox{\hyperlink{mm__utils_8py_source_l00119}{119}} of file \mbox{\hyperlink{mm__utils_8py_source}{mm\+\_\+utils.\+py}}.


\begin{DoxyCode}{0}
\DoxyCodeLine{00119\ \textcolor{keyword}{def\ }process\_anyres\_image(image,\ processor,\ grid\_pinpoints):}
\DoxyCodeLine{00120\ \ \ \ \ \textcolor{stringliteral}{"{}"{}"{}}}
\DoxyCodeLine{00121\ \textcolor{stringliteral}{\ \ \ \ Process\ an\ image\ with\ variable\ resolutions.}}
\DoxyCodeLine{00122\ \textcolor{stringliteral}{}}
\DoxyCodeLine{00123\ \textcolor{stringliteral}{\ \ \ \ Args:}}
\DoxyCodeLine{00124\ \textcolor{stringliteral}{\ \ \ \ \ \ \ \ image\ (PIL.Image.Image):\ The\ input\ image\ to\ be\ processed.}}
\DoxyCodeLine{00125\ \textcolor{stringliteral}{\ \ \ \ \ \ \ \ processor:\ The\ image\ processor\ object.}}
\DoxyCodeLine{00126\ \textcolor{stringliteral}{\ \ \ \ \ \ \ \ grid\_pinpoints\ (str):\ A\ string\ representation\ of\ a\ list\ of\ possible\ resolutions.}}
\DoxyCodeLine{00127\ \textcolor{stringliteral}{}}
\DoxyCodeLine{00128\ \textcolor{stringliteral}{\ \ \ \ Returns:}}
\DoxyCodeLine{00129\ \textcolor{stringliteral}{\ \ \ \ \ \ \ \ torch.Tensor:\ A\ tensor\ containing\ the\ processed\ image\ patches.}}
\DoxyCodeLine{00130\ \textcolor{stringliteral}{\ \ \ \ "{}"{}"{}}}
\DoxyCodeLine{00131\ \ \ \ \ \textcolor{keywordflow}{if}\ type(grid\_pinpoints)\ \textcolor{keywordflow}{is}\ list:}
\DoxyCodeLine{00132\ \ \ \ \ \ \ \ \ possible\_resolutions\ =\ grid\_pinpoints}
\DoxyCodeLine{00133\ \ \ \ \ \textcolor{keywordflow}{else}:}
\DoxyCodeLine{00134\ \ \ \ \ \ \ \ \ possible\_resolutions\ =\ ast.literal\_eval(grid\_pinpoints)}
\DoxyCodeLine{00135\ \ \ \ \ best\_resolution\ =\ select\_best\_resolution(image.size,\ possible\_resolutions)}
\DoxyCodeLine{00136\ \ \ \ \ image\_padded\ =\ resize\_and\_pad\_image(image,\ best\_resolution)}
\DoxyCodeLine{00137\ }
\DoxyCodeLine{00138\ \ \ \ \ patches\ =\ divide\_to\_patches(image\_padded,\ processor.crop\_size[\textcolor{stringliteral}{'height'}])}
\DoxyCodeLine{00139\ }
\DoxyCodeLine{00140\ \ \ \ \ image\_original\_resize\ =\ image.resize((processor.size[\textcolor{stringliteral}{'shortest\_edge'}],\ processor.size[\textcolor{stringliteral}{'shortest\_edge'}]))}
\DoxyCodeLine{00141\ }
\DoxyCodeLine{00142\ \ \ \ \ image\_patches\ =\ [image\_original\_resize]\ +\ patches}
\DoxyCodeLine{00143\ \ \ \ \ image\_patches\ =\ [processor.preprocess(image\_patch,\ return\_tensors=\textcolor{stringliteral}{'pt'})[\textcolor{stringliteral}{'pixel\_values'}][0]}
\DoxyCodeLine{00144\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ image\_patch\ \textcolor{keywordflow}{in}\ image\_patches]}
\DoxyCodeLine{00145\ \ \ \ \ \textcolor{keywordflow}{return}\ torch.stack(image\_patches,\ dim=0)}
\DoxyCodeLine{00146\ }
\DoxyCodeLine{00147\ }

\end{DoxyCode}
Here is the call graph for this function\+:
% FIG 3
Here is the caller graph for this function\+:
% FIG 4
\Hypertarget{namespacellava_1_1mm__utils_aa18f4829bc6b5580349eff790660999c}\index{llava.mm\_utils@{llava.mm\_utils}!process\_images@{process\_images}}
\index{process\_images@{process\_images}!llava.mm\_utils@{llava.mm\_utils}}
\doxysubsubsection{\texorpdfstring{process\_images()}{process\_images()}}
{\footnotesize\ttfamily \label{namespacellava_1_1mm__utils_aa18f4829bc6b5580349eff790660999c} 
llava.\+mm\+\_\+utils.\+process\+\_\+images (\begin{DoxyParamCaption}\item[{}]{images}{, }\item[{}]{image\+\_\+processor}{, }\item[{}]{model\+\_\+cfg}{}\end{DoxyParamCaption})}



Definition at line \mbox{\hyperlink{mm__utils_8py_source_l00166}{166}} of file \mbox{\hyperlink{mm__utils_8py_source}{mm\+\_\+utils.\+py}}.


\begin{DoxyCode}{0}
\DoxyCodeLine{00166\ \textcolor{keyword}{def\ }process\_images(images,\ image\_processor,\ model\_cfg):}
\DoxyCodeLine{00167\ \ \ \ \ image\_aspect\_ratio\ =\ getattr(model\_cfg,\ \textcolor{stringliteral}{"{}image\_aspect\_ratio"{}},\ \textcolor{keywordtype}{None})}
\DoxyCodeLine{00168\ \ \ \ \ new\_images\ =\ []}
\DoxyCodeLine{00169\ \ \ \ \ \textcolor{keywordflow}{if}\ image\_aspect\_ratio\ ==\ \textcolor{stringliteral}{'pad'}:}
\DoxyCodeLine{00170\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ image\ \textcolor{keywordflow}{in}\ images:}
\DoxyCodeLine{00171\ \ \ \ \ \ \ \ \ \ \ \ \ image\ =\ expand2square(image,\ tuple(int(x*255)\ \textcolor{keywordflow}{for}\ x\ \textcolor{keywordflow}{in}\ image\_processor.image\_mean))}
\DoxyCodeLine{00172\ \ \ \ \ \ \ \ \ \ \ \ \ image\ =\ image\_processor.preprocess(image,\ return\_tensors=\textcolor{stringliteral}{'pt'})[\textcolor{stringliteral}{'pixel\_values'}][0]}
\DoxyCodeLine{00173\ \ \ \ \ \ \ \ \ \ \ \ \ new\_images.append(image)}
\DoxyCodeLine{00174\ \ \ \ \ \textcolor{keywordflow}{elif}\ image\_aspect\_ratio\ ==\ \textcolor{stringliteral}{"{}anyres"{}}:}
\DoxyCodeLine{00175\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ image\ \textcolor{keywordflow}{in}\ images:}
\DoxyCodeLine{00176\ \ \ \ \ \ \ \ \ \ \ \ \ image\ =\ process\_anyres\_image(image,\ image\_processor,\ model\_cfg.image\_grid\_pinpoints)}
\DoxyCodeLine{00177\ \ \ \ \ \ \ \ \ \ \ \ \ new\_images.append(image)}
\DoxyCodeLine{00178\ \ \ \ \ \textcolor{keywordflow}{else}:}
\DoxyCodeLine{00179\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ image\_processor(images,\ return\_tensors=\textcolor{stringliteral}{'pt'})[\textcolor{stringliteral}{'pixel\_values'}]}
\DoxyCodeLine{00180\ \ \ \ \ \textcolor{keywordflow}{if}\ all(x.shape\ ==\ new\_images[0].shape\ \textcolor{keywordflow}{for}\ x\ \textcolor{keywordflow}{in}\ new\_images):}
\DoxyCodeLine{00181\ \ \ \ \ \ \ \ \ new\_images\ =\ torch.stack(new\_images,\ dim=0)}
\DoxyCodeLine{00182\ \ \ \ \ \textcolor{keywordflow}{return}\ new\_images}
\DoxyCodeLine{00183\ }
\DoxyCodeLine{00184\ }

\end{DoxyCode}
Here is the call graph for this function\+:
% FIG 5
\Hypertarget{namespacellava_1_1mm__utils_a40cefe125ab588aa0efee388f7b7108f}\index{llava.mm\_utils@{llava.mm\_utils}!resize\_and\_pad\_image@{resize\_and\_pad\_image}}
\index{resize\_and\_pad\_image@{resize\_and\_pad\_image}!llava.mm\_utils@{llava.mm\_utils}}
\doxysubsubsection{\texorpdfstring{resize\_and\_pad\_image()}{resize\_and\_pad\_image()}}
{\footnotesize\ttfamily \label{namespacellava_1_1mm__utils_a40cefe125ab588aa0efee388f7b7108f} 
llava.\+mm\+\_\+utils.\+resize\+\_\+and\+\_\+pad\+\_\+image (\begin{DoxyParamCaption}\item[{}]{image}{, }\item[{}]{target\+\_\+resolution}{}\end{DoxyParamCaption})}

\begin{DoxyVerb}Resize and pad an image to a target resolution while maintaining aspect ratio.

Args:
    image (PIL.Image.Image): The input image.
    target_resolution (tuple): The target resolution (width, height) of the image.

Returns:
    PIL.Image.Image: The resized and padded image.
\end{DoxyVerb}
 

Definition at line \mbox{\hyperlink{mm__utils_8py_source_l00042}{42}} of file \mbox{\hyperlink{mm__utils_8py_source}{mm\+\_\+utils.\+py}}.


\begin{DoxyCode}{0}
\DoxyCodeLine{00042\ \textcolor{keyword}{def\ }resize\_and\_pad\_image(image,\ target\_resolution):}
\DoxyCodeLine{00043\ \ \ \ \ \textcolor{stringliteral}{"{}"{}"{}}}
\DoxyCodeLine{00044\ \textcolor{stringliteral}{\ \ \ \ Resize\ and\ pad\ an\ image\ to\ a\ target\ resolution\ while\ maintaining\ aspect\ ratio.}}
\DoxyCodeLine{00045\ \textcolor{stringliteral}{}}
\DoxyCodeLine{00046\ \textcolor{stringliteral}{\ \ \ \ Args:}}
\DoxyCodeLine{00047\ \textcolor{stringliteral}{\ \ \ \ \ \ \ \ image\ (PIL.Image.Image):\ The\ input\ image.}}
\DoxyCodeLine{00048\ \textcolor{stringliteral}{\ \ \ \ \ \ \ \ target\_resolution\ (tuple):\ The\ target\ resolution\ (width,\ height)\ of\ the\ image.}}
\DoxyCodeLine{00049\ \textcolor{stringliteral}{}}
\DoxyCodeLine{00050\ \textcolor{stringliteral}{\ \ \ \ Returns:}}
\DoxyCodeLine{00051\ \textcolor{stringliteral}{\ \ \ \ \ \ \ \ PIL.Image.Image:\ The\ resized\ and\ padded\ image.}}
\DoxyCodeLine{00052\ \textcolor{stringliteral}{\ \ \ \ "{}"{}"{}}}
\DoxyCodeLine{00053\ \ \ \ \ original\_width,\ original\_height\ =\ image.size}
\DoxyCodeLine{00054\ \ \ \ \ target\_width,\ target\_height\ =\ target\_resolution}
\DoxyCodeLine{00055\ }
\DoxyCodeLine{00056\ \ \ \ \ scale\_w\ =\ target\_width\ /\ original\_width}
\DoxyCodeLine{00057\ \ \ \ \ scale\_h\ =\ target\_height\ /\ original\_height}
\DoxyCodeLine{00058\ }
\DoxyCodeLine{00059\ \ \ \ \ \textcolor{keywordflow}{if}\ scale\_w\ <\ scale\_h:}
\DoxyCodeLine{00060\ \ \ \ \ \ \ \ \ new\_width\ =\ target\_width}
\DoxyCodeLine{00061\ \ \ \ \ \ \ \ \ new\_height\ =\ min(math.ceil(original\_height\ *\ scale\_w),\ target\_height)}
\DoxyCodeLine{00062\ \ \ \ \ \textcolor{keywordflow}{else}:}
\DoxyCodeLine{00063\ \ \ \ \ \ \ \ \ new\_height\ =\ target\_height}
\DoxyCodeLine{00064\ \ \ \ \ \ \ \ \ new\_width\ =\ min(math.ceil(original\_width\ *\ scale\_h),\ target\_width)}
\DoxyCodeLine{00065\ }
\DoxyCodeLine{00066\ \ \ \ \ \textcolor{comment}{\#\ Resize\ the\ image}}
\DoxyCodeLine{00067\ \ \ \ \ resized\_image\ =\ image.resize((new\_width,\ new\_height))}
\DoxyCodeLine{00068\ }
\DoxyCodeLine{00069\ \ \ \ \ new\_image\ =\ Image.new(\textcolor{stringliteral}{'RGB'},\ (target\_width,\ target\_height),\ (0,\ 0,\ 0))}
\DoxyCodeLine{00070\ \ \ \ \ paste\_x\ =\ (target\_width\ -\/\ new\_width)\ //\ 2}
\DoxyCodeLine{00071\ \ \ \ \ paste\_y\ =\ (target\_height\ -\/\ new\_height)\ //\ 2}
\DoxyCodeLine{00072\ \ \ \ \ new\_image.paste(resized\_image,\ (paste\_x,\ paste\_y))}
\DoxyCodeLine{00073\ }
\DoxyCodeLine{00074\ \ \ \ \ \textcolor{keywordflow}{return}\ new\_image}
\DoxyCodeLine{00075\ }
\DoxyCodeLine{00076\ }

\end{DoxyCode}
Here is the caller graph for this function\+:
% FIG 6
\Hypertarget{namespacellava_1_1mm__utils_a4ca4286048f7be2f9e5f0b93e30b7672}\index{llava.mm\_utils@{llava.mm\_utils}!select\_best\_resolution@{select\_best\_resolution}}
\index{select\_best\_resolution@{select\_best\_resolution}!llava.mm\_utils@{llava.mm\_utils}}
\doxysubsubsection{\texorpdfstring{select\_best\_resolution()}{select\_best\_resolution()}}
{\footnotesize\ttfamily \label{namespacellava_1_1mm__utils_a4ca4286048f7be2f9e5f0b93e30b7672} 
llava.\+mm\+\_\+utils.\+select\+\_\+best\+\_\+resolution (\begin{DoxyParamCaption}\item[{}]{original\+\_\+size}{, }\item[{}]{possible\+\_\+resolutions}{}\end{DoxyParamCaption})}

\begin{DoxyVerb}Selects the best resolution from a list of possible resolutions based on the original size.

Args:
    original_size (tuple): The original size of the image in the format (width, height).
    possible_resolutions (list): A list of possible resolutions in the format [(width1, height1), (width2, height2), ...].

Returns:
    tuple: The best fit resolution in the format (width, height).
\end{DoxyVerb}
 

Definition at line \mbox{\hyperlink{mm__utils_8py_source_l00012}{12}} of file \mbox{\hyperlink{mm__utils_8py_source}{mm\+\_\+utils.\+py}}.


\begin{DoxyCode}{0}
\DoxyCodeLine{00012\ \textcolor{keyword}{def\ }select\_best\_resolution(original\_size,\ possible\_resolutions):}
\DoxyCodeLine{00013\ \ \ \ \ \textcolor{stringliteral}{"{}"{}"{}}}
\DoxyCodeLine{00014\ \textcolor{stringliteral}{\ \ \ \ Selects\ the\ best\ resolution\ from\ a\ list\ of\ possible\ resolutions\ based\ on\ the\ original\ size.}}
\DoxyCodeLine{00015\ \textcolor{stringliteral}{}}
\DoxyCodeLine{00016\ \textcolor{stringliteral}{\ \ \ \ Args:}}
\DoxyCodeLine{00017\ \textcolor{stringliteral}{\ \ \ \ \ \ \ \ original\_size\ (tuple):\ The\ original\ size\ of\ the\ image\ in\ the\ format\ (width,\ height).}}
\DoxyCodeLine{00018\ \textcolor{stringliteral}{\ \ \ \ \ \ \ \ possible\_resolutions\ (list):\ A\ list\ of\ possible\ resolutions\ in\ the\ format\ [(width1,\ height1),\ (width2,\ height2),\ ...].}}
\DoxyCodeLine{00019\ \textcolor{stringliteral}{}}
\DoxyCodeLine{00020\ \textcolor{stringliteral}{\ \ \ \ Returns:}}
\DoxyCodeLine{00021\ \textcolor{stringliteral}{\ \ \ \ \ \ \ \ tuple:\ The\ best\ fit\ resolution\ in\ the\ format\ (width,\ height).}}
\DoxyCodeLine{00022\ \textcolor{stringliteral}{\ \ \ \ "{}"{}"{}}}
\DoxyCodeLine{00023\ \ \ \ \ original\_width,\ original\_height\ =\ original\_size}
\DoxyCodeLine{00024\ \ \ \ \ best\_fit\ =\ \textcolor{keywordtype}{None}}
\DoxyCodeLine{00025\ \ \ \ \ max\_effective\_resolution\ =\ 0}
\DoxyCodeLine{00026\ \ \ \ \ min\_wasted\_resolution\ =\ float(\textcolor{stringliteral}{'inf'})}
\DoxyCodeLine{00027\ }
\DoxyCodeLine{00028\ \ \ \ \ \textcolor{keywordflow}{for}\ width,\ height\ \textcolor{keywordflow}{in}\ possible\_resolutions:}
\DoxyCodeLine{00029\ \ \ \ \ \ \ \ \ scale\ =\ min(width\ /\ original\_width,\ height\ /\ original\_height)}
\DoxyCodeLine{00030\ \ \ \ \ \ \ \ \ downscaled\_width,\ downscaled\_height\ =\ int(original\_width\ *\ scale),\ int(original\_height\ *\ scale)}
\DoxyCodeLine{00031\ \ \ \ \ \ \ \ \ effective\_resolution\ =\ min(downscaled\_width\ *\ downscaled\_height,\ original\_width\ *\ original\_height)}
\DoxyCodeLine{00032\ \ \ \ \ \ \ \ \ wasted\_resolution\ =\ (width\ *\ height)\ -\/\ effective\_resolution}
\DoxyCodeLine{00033\ }
\DoxyCodeLine{00034\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ effective\_resolution\ >\ max\_effective\_resolution\ \textcolor{keywordflow}{or}\ (effective\_resolution\ ==\ max\_effective\_resolution\ \textcolor{keywordflow}{and}\ wasted\_resolution\ <\ min\_wasted\_resolution):}
\DoxyCodeLine{00035\ \ \ \ \ \ \ \ \ \ \ \ \ max\_effective\_resolution\ =\ effective\_resolution}
\DoxyCodeLine{00036\ \ \ \ \ \ \ \ \ \ \ \ \ min\_wasted\_resolution\ =\ wasted\_resolution}
\DoxyCodeLine{00037\ \ \ \ \ \ \ \ \ \ \ \ \ best\_fit\ =\ (width,\ height)}
\DoxyCodeLine{00038\ }
\DoxyCodeLine{00039\ \ \ \ \ \textcolor{keywordflow}{return}\ best\_fit}
\DoxyCodeLine{00040\ }
\DoxyCodeLine{00041\ }

\end{DoxyCode}
Here is the caller graph for this function\+:
% FIG 7
\Hypertarget{namespacellava_1_1mm__utils_a26f403c48d039c2e34ca945efcab7437}\index{llava.mm\_utils@{llava.mm\_utils}!tokenizer\_image\_token@{tokenizer\_image\_token}}
\index{tokenizer\_image\_token@{tokenizer\_image\_token}!llava.mm\_utils@{llava.mm\_utils}}
\doxysubsubsection{\texorpdfstring{tokenizer\_image\_token()}{tokenizer\_image\_token()}}
{\footnotesize\ttfamily \label{namespacellava_1_1mm__utils_a26f403c48d039c2e34ca945efcab7437} 
llava.\+mm\+\_\+utils.\+tokenizer\+\_\+image\+\_\+token (\begin{DoxyParamCaption}\item[{}]{prompt}{, }\item[{}]{tokenizer}{, }\item[{}]{image\+\_\+token\+\_\+index}{ = {\ttfamily IMAGE\+\_\+TOKEN\+\_\+INDEX}, }\item[{}]{return\+\_\+tensors}{ = {\ttfamily None}}\end{DoxyParamCaption})}



Definition at line \mbox{\hyperlink{mm__utils_8py_source_l00185}{185}} of file \mbox{\hyperlink{mm__utils_8py_source}{mm\+\_\+utils.\+py}}.


\begin{DoxyCode}{0}
\DoxyCodeLine{00185\ \textcolor{keyword}{def\ }tokenizer\_image\_token(prompt,\ tokenizer,\ image\_token\_index=IMAGE\_TOKEN\_INDEX,\ return\_tensors=None):}
\DoxyCodeLine{00186\ \ \ \ \ prompt\_chunks\ =\ [tokenizer(chunk).input\_ids\ \textcolor{keywordflow}{for}\ chunk\ \textcolor{keywordflow}{in}\ prompt.split(\textcolor{stringliteral}{'<image>'})]}
\DoxyCodeLine{00187\ }
\DoxyCodeLine{00188\ \ \ \ \ \textcolor{keyword}{def\ }insert\_separator(X,\ sep):}
\DoxyCodeLine{00189\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ [ele\ \textcolor{keywordflow}{for}\ sublist\ \textcolor{keywordflow}{in}\ zip(X,\ [sep]*len(X))\ \textcolor{keywordflow}{for}\ ele\ \textcolor{keywordflow}{in}\ sublist][:-\/1]}
\DoxyCodeLine{00190\ }
\DoxyCodeLine{00191\ \ \ \ \ input\_ids\ =\ []}
\DoxyCodeLine{00192\ \ \ \ \ offset\ =\ 0}
\DoxyCodeLine{00193\ \ \ \ \ \textcolor{keywordflow}{if}\ len(prompt\_chunks)\ >\ 0\ \textcolor{keywordflow}{and}\ len(prompt\_chunks[0])\ >\ 0\ \textcolor{keywordflow}{and}\ prompt\_chunks[0][0]\ ==\ tokenizer.bos\_token\_id:}
\DoxyCodeLine{00194\ \ \ \ \ \ \ \ \ offset\ =\ 1}
\DoxyCodeLine{00195\ \ \ \ \ \ \ \ \ input\_ids.append(prompt\_chunks[0][0])}
\DoxyCodeLine{00196\ }
\DoxyCodeLine{00197\ \ \ \ \ \textcolor{keywordflow}{for}\ x\ \textcolor{keywordflow}{in}\ insert\_separator(prompt\_chunks,\ [image\_token\_index]\ *\ (offset\ +\ 1)):}
\DoxyCodeLine{00198\ \ \ \ \ \ \ \ \ input\_ids.extend(x[offset:])}
\DoxyCodeLine{00199\ }
\DoxyCodeLine{00200\ \ \ \ \ \textcolor{keywordflow}{if}\ return\_tensors\ \textcolor{keywordflow}{is}\ \textcolor{keywordflow}{not}\ \textcolor{keywordtype}{None}:}
\DoxyCodeLine{00201\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ return\_tensors\ ==\ \textcolor{stringliteral}{'pt'}:}
\DoxyCodeLine{00202\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ torch.tensor(input\_ids,\ dtype=torch.long)}
\DoxyCodeLine{00203\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{raise}\ ValueError(f\textcolor{stringliteral}{'Unsupported\ tensor\ type:\ \{return\_tensors\}'})}
\DoxyCodeLine{00204\ \ \ \ \ \textcolor{keywordflow}{return}\ input\_ids}
\DoxyCodeLine{00205\ }
\DoxyCodeLine{00206\ }

\end{DoxyCode}
