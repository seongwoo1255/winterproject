\doxysection{llava\+\_\+trainer Namespace Reference}
\hypertarget{namespacellava__trainer}{}\label{namespacellava__trainer}\index{llava\_trainer@{llava\_trainer}}
\doxysubsubsection*{Classes}
\begin{DoxyCompactItemize}
\item 
class \mbox{\hyperlink{classllava__trainer_1_1_length_grouped_sampler}{Length\+Grouped\+Sampler}}
\item 
class \mbox{\hyperlink{classllava__trainer_1_1_l_la_v_a_trainer}{LLa\+VATrainer}}
\end{DoxyCompactItemize}
\doxysubsubsection*{Functions}
\begin{DoxyCompactItemize}
\item 
\mbox{\hyperlink{namespacellava__trainer_a405d35ef013abb6d95ad5222ba621bd4}{maybe\+\_\+zero\+\_\+3}} (param, ignore\+\_\+status=False, name=None)
\item 
\mbox{\hyperlink{namespacellava__trainer_a71c649326f5e647cdda5f26ac69a43c4}{get\+\_\+mm\+\_\+adapter\+\_\+state\+\_\+maybe\+\_\+zero\+\_\+3}} (named\+\_\+params, keys\+\_\+to\+\_\+match)
\item 
\mbox{\hyperlink{namespacellava__trainer_a1524761aac5c79da4af7cd2136812c67}{split\+\_\+to\+\_\+even\+\_\+chunks}} (indices, lengths, num\+\_\+chunks)
\item 
\mbox{\hyperlink{namespacellava__trainer_ad3603ff08041fbde924b106e25c29cfe}{get\+\_\+modality\+\_\+length\+\_\+grouped\+\_\+indices}} (lengths, batch\+\_\+size, world\+\_\+size, generator=None)
\item 
\mbox{\hyperlink{namespacellava__trainer_acef7e7581bb01a06f71582fedc7ecbd4}{get\+\_\+length\+\_\+grouped\+\_\+indices}} (lengths, batch\+\_\+size, world\+\_\+size, generator=None, merge=True)
\end{DoxyCompactItemize}


\doxysubsection{Function Documentation}
\Hypertarget{namespacellava__trainer_acef7e7581bb01a06f71582fedc7ecbd4}\index{llava\_trainer@{llava\_trainer}!get\_length\_grouped\_indices@{get\_length\_grouped\_indices}}
\index{get\_length\_grouped\_indices@{get\_length\_grouped\_indices}!llava\_trainer@{llava\_trainer}}
\doxysubsubsection{\texorpdfstring{get\_length\_grouped\_indices()}{get\_length\_grouped\_indices()}}
{\footnotesize\ttfamily \label{namespacellava__trainer_acef7e7581bb01a06f71582fedc7ecbd4} 
llava\+\_\+trainer.\+get\+\_\+length\+\_\+grouped\+\_\+indices (\begin{DoxyParamCaption}\item[{}]{lengths}{, }\item[{}]{batch\+\_\+size}{, }\item[{}]{world\+\_\+size}{, }\item[{}]{generator}{ = {\ttfamily None}, }\item[{}]{merge}{ = {\ttfamily True}}\end{DoxyParamCaption})}



Definition at line \mbox{\hyperlink{llava__trainer_8py_source_l00088}{88}} of file \mbox{\hyperlink{llava__trainer_8py_source}{llava\+\_\+trainer.\+py}}.


\begin{DoxyCode}{0}
\DoxyCodeLine{00088\ \textcolor{keyword}{def\ }get\_length\_grouped\_indices(lengths,\ batch\_size,\ world\_size,\ generator=None,\ merge=True):}
\DoxyCodeLine{00089\ \ \ \ \ \textcolor{comment}{\#\ We\ need\ to\ use\ torch\ for\ the\ random\ part\ as\ a\ distributed\ sampler\ will\ set\ the\ random\ seed\ for\ torch.}}
\DoxyCodeLine{00090\ \ \ \ \ indices\ =\ torch.randperm(len(lengths),\ generator=generator)}
\DoxyCodeLine{00091\ \ \ \ \ megabatch\_size\ =\ world\_size\ *\ batch\_size}
\DoxyCodeLine{00092\ \ \ \ \ megabatches\ =\ [indices[i\ :\ i\ +\ megabatch\_size].tolist()\ \textcolor{keywordflow}{for}\ i\ \textcolor{keywordflow}{in}\ range(0,\ len(lengths),\ megabatch\_size)]}
\DoxyCodeLine{00093\ \ \ \ \ megabatches\ =\ [sorted(megabatch,\ key=\textcolor{keyword}{lambda}\ i:\ lengths[i],\ reverse=\textcolor{keyword}{True})\ \textcolor{keywordflow}{for}\ megabatch\ \textcolor{keywordflow}{in}\ megabatches]}
\DoxyCodeLine{00094\ \ \ \ \ megabatches\ =\ [split\_to\_even\_chunks(megabatch,\ lengths,\ world\_size)\ \textcolor{keywordflow}{for}\ megabatch\ \textcolor{keywordflow}{in}\ megabatches]}
\DoxyCodeLine{00095\ }
\DoxyCodeLine{00096\ \ \ \ \ \textcolor{keywordflow}{return}\ [i\ \textcolor{keywordflow}{for}\ megabatch\ \textcolor{keywordflow}{in}\ megabatches\ \textcolor{keywordflow}{for}\ batch\ \textcolor{keywordflow}{in}\ megabatch\ \textcolor{keywordflow}{for}\ i\ \textcolor{keywordflow}{in}\ batch]}
\DoxyCodeLine{00097\ }
\DoxyCodeLine{00098\ }

\end{DoxyCode}
Here is the call graph for this function\+:
% FIG 0
Here is the caller graph for this function\+:
% FIG 1
\Hypertarget{namespacellava__trainer_a71c649326f5e647cdda5f26ac69a43c4}\index{llava\_trainer@{llava\_trainer}!get\_mm\_adapter\_state\_maybe\_zero\_3@{get\_mm\_adapter\_state\_maybe\_zero\_3}}
\index{get\_mm\_adapter\_state\_maybe\_zero\_3@{get\_mm\_adapter\_state\_maybe\_zero\_3}!llava\_trainer@{llava\_trainer}}
\doxysubsubsection{\texorpdfstring{get\_mm\_adapter\_state\_maybe\_zero\_3()}{get\_mm\_adapter\_state\_maybe\_zero\_3()}}
{\footnotesize\ttfamily \label{namespacellava__trainer_a71c649326f5e647cdda5f26ac69a43c4} 
llava\+\_\+trainer.\+get\+\_\+mm\+\_\+adapter\+\_\+state\+\_\+maybe\+\_\+zero\+\_\+3 (\begin{DoxyParamCaption}\item[{}]{named\+\_\+params}{, }\item[{}]{keys\+\_\+to\+\_\+match}{}\end{DoxyParamCaption})}



Definition at line \mbox{\hyperlink{llava__trainer_8py_source_l00032}{32}} of file \mbox{\hyperlink{llava__trainer_8py_source}{llava\+\_\+trainer.\+py}}.


\begin{DoxyCode}{0}
\DoxyCodeLine{00032\ \textcolor{keyword}{def\ }get\_mm\_adapter\_state\_maybe\_zero\_3(named\_params,\ keys\_to\_match):}
\DoxyCodeLine{00033\ \ \ \ \ to\_return\ =\ \{k:\ t\ \textcolor{keywordflow}{for}\ k,\ t\ \textcolor{keywordflow}{in}\ named\_params\ \textcolor{keywordflow}{if}\ any(key\_match\ \textcolor{keywordflow}{in}\ k\ \textcolor{keywordflow}{for}\ key\_match\ \textcolor{keywordflow}{in}\ keys\_to\_match)\}}
\DoxyCodeLine{00034\ \ \ \ \ to\_return\ =\ \{k:\ maybe\_zero\_3(v,\ ignore\_status=\textcolor{keyword}{True},\ name=k).cpu()\ \textcolor{keywordflow}{for}\ k,\ v\ \textcolor{keywordflow}{in}\ to\_return.items()\}}
\DoxyCodeLine{00035\ \ \ \ \ \textcolor{keywordflow}{return}\ to\_return}
\DoxyCodeLine{00036\ }
\DoxyCodeLine{00037\ }

\end{DoxyCode}
Here is the call graph for this function\+:
% FIG 2
\Hypertarget{namespacellava__trainer_ad3603ff08041fbde924b106e25c29cfe}\index{llava\_trainer@{llava\_trainer}!get\_modality\_length\_grouped\_indices@{get\_modality\_length\_grouped\_indices}}
\index{get\_modality\_length\_grouped\_indices@{get\_modality\_length\_grouped\_indices}!llava\_trainer@{llava\_trainer}}
\doxysubsubsection{\texorpdfstring{get\_modality\_length\_grouped\_indices()}{get\_modality\_length\_grouped\_indices()}}
{\footnotesize\ttfamily \label{namespacellava__trainer_ad3603ff08041fbde924b106e25c29cfe} 
llava\+\_\+trainer.\+get\+\_\+modality\+\_\+length\+\_\+grouped\+\_\+indices (\begin{DoxyParamCaption}\item[{}]{lengths}{, }\item[{}]{batch\+\_\+size}{, }\item[{}]{world\+\_\+size}{, }\item[{}]{generator}{ = {\ttfamily None}}\end{DoxyParamCaption})}



Definition at line \mbox{\hyperlink{llava__trainer_8py_source_l00060}{60}} of file \mbox{\hyperlink{llava__trainer_8py_source}{llava\+\_\+trainer.\+py}}.


\begin{DoxyCode}{0}
\DoxyCodeLine{00060\ \textcolor{keyword}{def\ }get\_modality\_length\_grouped\_indices(lengths,\ batch\_size,\ world\_size,\ generator=None):}
\DoxyCodeLine{00061\ \ \ \ \ \textcolor{comment}{\#\ We\ need\ to\ use\ torch\ for\ the\ random\ part\ as\ a\ distributed\ sampler\ will\ set\ the\ random\ seed\ for\ torch.}}
\DoxyCodeLine{00062\ \ \ \ \ \textcolor{keyword}{assert}\ all(l\ !=\ 0\ \textcolor{keywordflow}{for}\ l\ \textcolor{keywordflow}{in}\ lengths),\ \textcolor{stringliteral}{"{}Should\ not\ have\ zero\ length."{}}}
\DoxyCodeLine{00063\ \ \ \ \ \textcolor{keywordflow}{if}\ all(l\ >\ 0\ \textcolor{keywordflow}{for}\ l\ \textcolor{keywordflow}{in}\ lengths)\ \textcolor{keywordflow}{or}\ all(l\ <\ 0\ \textcolor{keywordflow}{for}\ l\ \textcolor{keywordflow}{in}\ lengths):}
\DoxyCodeLine{00064\ \ \ \ \ \ \ \ \ \textcolor{comment}{\#\ all\ samples\ are\ in\ the\ same\ modality}}
\DoxyCodeLine{00065\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ get\_length\_grouped\_indices(lengths,\ batch\_size,\ world\_size,\ generator=generator)}
\DoxyCodeLine{00066\ \ \ \ \ mm\_indices,\ mm\_lengths\ =\ zip(*[(i,\ l)\ \textcolor{keywordflow}{for}\ i,\ l\ \textcolor{keywordflow}{in}\ enumerate(lengths)\ \textcolor{keywordflow}{if}\ l\ >\ 0])}
\DoxyCodeLine{00067\ \ \ \ \ lang\_indices,\ lang\_lengths\ =\ zip(*[(i,\ -\/l)\ \textcolor{keywordflow}{for}\ i,\ l\ \textcolor{keywordflow}{in}\ enumerate(lengths)\ \textcolor{keywordflow}{if}\ l\ <\ 0])}
\DoxyCodeLine{00068\ }
\DoxyCodeLine{00069\ \ \ \ \ mm\_shuffle\ =\ [mm\_indices[i]\ \textcolor{keywordflow}{for}\ i\ \textcolor{keywordflow}{in}\ get\_length\_grouped\_indices(mm\_lengths,\ batch\_size,\ world\_size,\ generator=\textcolor{keywordtype}{None})]}
\DoxyCodeLine{00070\ \ \ \ \ lang\_shuffle\ =\ [lang\_indices[i]\ \textcolor{keywordflow}{for}\ i\ \textcolor{keywordflow}{in}\ get\_length\_grouped\_indices(lang\_lengths,\ batch\_size,\ world\_size,\ generator=\textcolor{keywordtype}{None})]}
\DoxyCodeLine{00071\ \ \ \ \ megabatch\_size\ =\ world\_size\ *\ batch\_size}
\DoxyCodeLine{00072\ \ \ \ \ mm\_megabatches\ =\ [mm\_shuffle[i\ :\ i\ +\ megabatch\_size]\ \textcolor{keywordflow}{for}\ i\ \textcolor{keywordflow}{in}\ range(0,\ len(mm\_shuffle),\ megabatch\_size)]}
\DoxyCodeLine{00073\ \ \ \ \ lang\_megabatches\ =\ [lang\_shuffle[i\ :\ i\ +\ megabatch\_size]\ \textcolor{keywordflow}{for}\ i\ \textcolor{keywordflow}{in}\ range(0,\ len(lang\_shuffle),\ megabatch\_size)]}
\DoxyCodeLine{00074\ }
\DoxyCodeLine{00075\ \ \ \ \ last\_mm\ =\ mm\_megabatches[-\/1]}
\DoxyCodeLine{00076\ \ \ \ \ last\_lang\ =\ lang\_megabatches[-\/1]}
\DoxyCodeLine{00077\ \ \ \ \ additional\_batch\ =\ last\_mm\ +\ last\_lang}
\DoxyCodeLine{00078\ \ \ \ \ megabatches\ =\ mm\_megabatches[:-\/1]\ +\ lang\_megabatches[:-\/1]}
\DoxyCodeLine{00079\ \ \ \ \ megabatch\_indices\ =\ torch.randperm(len(megabatches),\ generator=generator)}
\DoxyCodeLine{00080\ \ \ \ \ megabatches\ =\ [megabatches[i]\ \textcolor{keywordflow}{for}\ i\ \textcolor{keywordflow}{in}\ megabatch\_indices]}
\DoxyCodeLine{00081\ }
\DoxyCodeLine{00082\ \ \ \ \ \textcolor{keywordflow}{if}\ len(additional\_batch)\ >\ 0:}
\DoxyCodeLine{00083\ \ \ \ \ \ \ \ \ megabatches.append(sorted(additional\_batch))}
\DoxyCodeLine{00084\ }
\DoxyCodeLine{00085\ \ \ \ \ \textcolor{keywordflow}{return}\ [i\ \textcolor{keywordflow}{for}\ megabatch\ \textcolor{keywordflow}{in}\ megabatches\ \textcolor{keywordflow}{for}\ i\ \textcolor{keywordflow}{in}\ megabatch]}
\DoxyCodeLine{00086\ }
\DoxyCodeLine{00087\ }

\end{DoxyCode}
Here is the call graph for this function\+:
% FIG 3
Here is the caller graph for this function\+:
% FIG 4
\Hypertarget{namespacellava__trainer_a405d35ef013abb6d95ad5222ba621bd4}\index{llava\_trainer@{llava\_trainer}!maybe\_zero\_3@{maybe\_zero\_3}}
\index{maybe\_zero\_3@{maybe\_zero\_3}!llava\_trainer@{llava\_trainer}}
\doxysubsubsection{\texorpdfstring{maybe\_zero\_3()}{maybe\_zero\_3()}}
{\footnotesize\ttfamily \label{namespacellava__trainer_a405d35ef013abb6d95ad5222ba621bd4} 
llava\+\_\+trainer.\+maybe\+\_\+zero\+\_\+3 (\begin{DoxyParamCaption}\item[{}]{param}{, }\item[{}]{ignore\+\_\+status}{ = {\ttfamily False}, }\item[{}]{name}{ = {\ttfamily None}}\end{DoxyParamCaption})}



Definition at line \mbox{\hyperlink{llava__trainer_8py_source_l00018}{18}} of file \mbox{\hyperlink{llava__trainer_8py_source}{llava\+\_\+trainer.\+py}}.


\begin{DoxyCode}{0}
\DoxyCodeLine{00018\ \textcolor{keyword}{def\ }maybe\_zero\_3(param,\ ignore\_status=False,\ name=None):}
\DoxyCodeLine{00019\ \ \ \ \ \textcolor{keyword}{from}\ deepspeed\ \textcolor{keyword}{import}\ zero}
\DoxyCodeLine{00020\ \ \ \ \ \textcolor{keyword}{from}\ deepspeed.runtime.zero.partition\_parameters\ \textcolor{keyword}{import}\ ZeroParamStatus}
\DoxyCodeLine{00021\ \ \ \ \ \textcolor{keywordflow}{if}\ hasattr(param,\ \textcolor{stringliteral}{"{}ds\_id"{}}):}
\DoxyCodeLine{00022\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ param.ds\_status\ ==\ ZeroParamStatus.NOT\_AVAILABLE:}
\DoxyCodeLine{00023\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ \textcolor{keywordflow}{not}\ ignore\_status:}
\DoxyCodeLine{00024\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ print(name,\ \textcolor{stringliteral}{'no\ ignore\ status'})}
\DoxyCodeLine{00025\ \ \ \ \ \ \ \ \ \textcolor{keyword}{with}\ zero.GatheredParameters([param]):}
\DoxyCodeLine{00026\ \ \ \ \ \ \ \ \ \ \ \ \ param\ =\ param.data.detach().cpu().clone()}
\DoxyCodeLine{00027\ \ \ \ \ \textcolor{keywordflow}{else}:}
\DoxyCodeLine{00028\ \ \ \ \ \ \ \ \ param\ =\ param.detach().cpu().clone()}
\DoxyCodeLine{00029\ \ \ \ \ \textcolor{keywordflow}{return}\ param}
\DoxyCodeLine{00030\ }
\DoxyCodeLine{00031\ }

\end{DoxyCode}
Here is the caller graph for this function\+:
% FIG 5
\Hypertarget{namespacellava__trainer_a1524761aac5c79da4af7cd2136812c67}\index{llava\_trainer@{llava\_trainer}!split\_to\_even\_chunks@{split\_to\_even\_chunks}}
\index{split\_to\_even\_chunks@{split\_to\_even\_chunks}!llava\_trainer@{llava\_trainer}}
\doxysubsubsection{\texorpdfstring{split\_to\_even\_chunks()}{split\_to\_even\_chunks()}}
{\footnotesize\ttfamily \label{namespacellava__trainer_a1524761aac5c79da4af7cd2136812c67} 
llava\+\_\+trainer.\+split\+\_\+to\+\_\+even\+\_\+chunks (\begin{DoxyParamCaption}\item[{}]{indices}{, }\item[{}]{lengths}{, }\item[{}]{num\+\_\+chunks}{}\end{DoxyParamCaption})}

\begin{DoxyVerb}Split a list of indices into `chunks` chunks of roughly equal lengths.
\end{DoxyVerb}
 

Definition at line \mbox{\hyperlink{llava__trainer_8py_source_l00038}{38}} of file \mbox{\hyperlink{llava__trainer_8py_source}{llava\+\_\+trainer.\+py}}.


\begin{DoxyCode}{0}
\DoxyCodeLine{00038\ \textcolor{keyword}{def\ }split\_to\_even\_chunks(indices,\ lengths,\ num\_chunks):}
\DoxyCodeLine{00039\ \ \ \ \ \textcolor{stringliteral}{"{}"{}"{}}}
\DoxyCodeLine{00040\ \textcolor{stringliteral}{\ \ \ \ Split\ a\ list\ of\ indices\ into\ \`{}chunks\`{}\ chunks\ of\ roughly\ equal\ lengths.}}
\DoxyCodeLine{00041\ \textcolor{stringliteral}{\ \ \ \ "{}"{}"{}}}
\DoxyCodeLine{00042\ }
\DoxyCodeLine{00043\ \ \ \ \ \textcolor{keywordflow}{if}\ len(indices)\ \%\ num\_chunks\ !=\ 0:}
\DoxyCodeLine{00044\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ [indices[i::num\_chunks]\ \textcolor{keywordflow}{for}\ i\ \textcolor{keywordflow}{in}\ range(num\_chunks)]}
\DoxyCodeLine{00045\ }
\DoxyCodeLine{00046\ \ \ \ \ num\_indices\_per\_chunk\ =\ len(indices)\ //\ num\_chunks}
\DoxyCodeLine{00047\ }
\DoxyCodeLine{00048\ \ \ \ \ chunks\ =\ [[]\ \textcolor{keywordflow}{for}\ \_\ \textcolor{keywordflow}{in}\ range(num\_chunks)]}
\DoxyCodeLine{00049\ \ \ \ \ chunks\_lengths\ =\ [0\ \textcolor{keywordflow}{for}\ \_\ \textcolor{keywordflow}{in}\ range(num\_chunks)]}
\DoxyCodeLine{00050\ \ \ \ \ \textcolor{keywordflow}{for}\ index\ \textcolor{keywordflow}{in}\ indices:}
\DoxyCodeLine{00051\ \ \ \ \ \ \ \ \ shortest\_chunk\ =\ chunks\_lengths.index(min(chunks\_lengths))}
\DoxyCodeLine{00052\ \ \ \ \ \ \ \ \ chunks[shortest\_chunk].append(index)}
\DoxyCodeLine{00053\ \ \ \ \ \ \ \ \ chunks\_lengths[shortest\_chunk]\ +=\ lengths[index]}
\DoxyCodeLine{00054\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ len(chunks[shortest\_chunk])\ ==\ num\_indices\_per\_chunk:}
\DoxyCodeLine{00055\ \ \ \ \ \ \ \ \ \ \ \ \ chunks\_lengths[shortest\_chunk]\ =\ float(\textcolor{stringliteral}{"{}inf"{}})}
\DoxyCodeLine{00056\ }
\DoxyCodeLine{00057\ \ \ \ \ \textcolor{keywordflow}{return}\ chunks}
\DoxyCodeLine{00058\ }
\DoxyCodeLine{00059\ }

\end{DoxyCode}
Here is the caller graph for this function\+:
% FIG 6
