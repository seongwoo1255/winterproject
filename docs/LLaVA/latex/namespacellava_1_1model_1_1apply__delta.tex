\doxysection{llava.\+model.\+apply\+\_\+delta Namespace Reference}
\hypertarget{namespacellava_1_1model_1_1apply__delta}{}\label{namespacellava_1_1model_1_1apply__delta}\index{llava.model.apply\_delta@{llava.model.apply\_delta}}
\doxysubsubsection*{Functions}
\begin{DoxyCompactItemize}
\item 
\mbox{\hyperlink{namespacellava_1_1model_1_1apply__delta_a002d7df04ac25bcf1d9fd4b1c429a17e}{apply\+\_\+delta}} (base\+\_\+model\+\_\+path, target\+\_\+model\+\_\+path, delta\+\_\+path)
\begin{DoxyCompactList}\small\item\em Delta를 기존 모델에 적용하여 새로운 모델을 생성하는 함수 \end{DoxyCompactList}\end{DoxyCompactItemize}
\doxysubsubsection*{Variables}
\begin{DoxyCompactItemize}
\item 
\mbox{\hyperlink{namespacellava_1_1model_1_1apply__delta_a9a1ce1f75ee1d38fe64467def1c7e885}{parser}} = argparse.\+Argument\+Parser()
\item 
\mbox{\hyperlink{namespacellava_1_1model_1_1apply__delta_a186c670d72b9afbba6b77c2ddc1e6d8b}{type}}
\item 
\mbox{\hyperlink{namespacellava_1_1model_1_1apply__delta_aa7896f479fbbbea00a0778f672ed5707}{str}}
\item 
\mbox{\hyperlink{namespacellava_1_1model_1_1apply__delta_a00db04d3e948afe7196bacb84201a6a9}{required}}
\item 
\mbox{\hyperlink{namespacellava_1_1model_1_1apply__delta_a1ed1f5bab2dc161b4ce2e90e376bd21d}{args}} = parser.\+parse\+\_\+args()
\end{DoxyCompactItemize}


\doxysubsection{Detailed Description}
\begin{DoxyVerb}Usage:
python3 -m fastchat.model.apply_delta --base ~/model_weights/llama-7b --target ~/model_weights/vicuna-7b --delta lmsys/vicuna-7b-delta
\end{DoxyVerb}
 

\doxysubsection{Function Documentation}
\Hypertarget{namespacellava_1_1model_1_1apply__delta_a002d7df04ac25bcf1d9fd4b1c429a17e}\index{llava.model.apply\_delta@{llava.model.apply\_delta}!apply\_delta@{apply\_delta}}
\index{apply\_delta@{apply\_delta}!llava.model.apply\_delta@{llava.model.apply\_delta}}
\doxysubsubsection{\texorpdfstring{apply\_delta()}{apply\_delta()}}
{\footnotesize\ttfamily \label{namespacellava_1_1model_1_1apply__delta_a002d7df04ac25bcf1d9fd4b1c429a17e} 
llava.\+model.\+apply\+\_\+delta.\+apply\+\_\+delta (\begin{DoxyParamCaption}\item[{}]{base\+\_\+model\+\_\+path}{, }\item[{}]{target\+\_\+model\+\_\+path}{, }\item[{}]{delta\+\_\+path}{}\end{DoxyParamCaption})}



Delta를 기존 모델에 적용하여 새로운 모델을 생성하는 함수 

\begin{DoxyAuthor}{Author}
이지희(2021113406)
\end{DoxyAuthor}

\begin{DoxyItemize}
\item Delta는 Base 모델의 파라미터에 더해져 Target 모델이 생성됩니다.
\item Delta 및 Base 모델의 파라미터가 일치하지 않을 경우 예외가 발생합니다.
\end{DoxyItemize}


\begin{DoxyParams}{Parameters}
{\em base\+\_\+model\+\_\+path} & (str) Base 모델의 경로 \\
\hline
{\em target\+\_\+model\+\_\+path} & (str) 생성될 Target 모델의 저장 경로 \\
\hline
{\em delta\+\_\+path} & (str) Delta 모델의 경로 \\
\hline
\end{DoxyParams}

\begin{DoxyExceptions}{Exceptions}
{\em Assertion\+Error} & Delta와 Base 모델 간 매칭되지 않는 파라미터가 있을 경우 발생 \\
\hline
\end{DoxyExceptions}


Definition at line \mbox{\hyperlink{apply__delta_8py_source_l00031}{31}} of file \mbox{\hyperlink{apply__delta_8py_source}{apply\+\_\+delta.\+py}}.


\begin{DoxyCode}{0}
\DoxyCodeLine{00031\ \textcolor{keyword}{def\ }apply\_delta(base\_model\_path,\ target\_model\_path,\ delta\_path):}
\DoxyCodeLine{00032\ \ \ \ \ print(\textcolor{stringliteral}{"{}Loading\ base\ model"{}})}
\DoxyCodeLine{00033\ \ \ \ \ base\ =\ AutoModelForCausalLM.from\_pretrained(}
\DoxyCodeLine{00034\ \ \ \ \ \ \ \ \ base\_model\_path,\ torch\_dtype=torch.float16,\ low\_cpu\_mem\_usage=\textcolor{keyword}{True})}
\DoxyCodeLine{00035\ }
\DoxyCodeLine{00036\ \ \ \ \ print(\textcolor{stringliteral}{"{}Loading\ delta"{}})}
\DoxyCodeLine{00037\ \ \ \ \ delta\ =\ LlavaLlamaForCausalLM.from\_pretrained(delta\_path,\ torch\_dtype=torch.float16,\ low\_cpu\_mem\_usage=\textcolor{keyword}{True})}
\DoxyCodeLine{00038\ \ \ \ \ delta\_tokenizer\ =\ AutoTokenizer.from\_pretrained(delta\_path)}
\DoxyCodeLine{00039\ }
\DoxyCodeLine{00040\ \ \ \ \ print(\textcolor{stringliteral}{"{}Applying\ delta"{}})}
\DoxyCodeLine{00041\ \ \ \ \ \textcolor{keywordflow}{for}\ name,\ param\ \textcolor{keywordflow}{in}\ tqdm(delta.state\_dict().items(),\ desc=\textcolor{stringliteral}{"{}Applying\ delta"{}}):}
\DoxyCodeLine{00042\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ name\ \textcolor{keywordflow}{not}\ \textcolor{keywordflow}{in}\ base.state\_dict():}
\DoxyCodeLine{00043\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{assert}\ name\ \textcolor{keywordflow}{in}\ [\textcolor{stringliteral}{'model.mm\_projector.weight'},\ \textcolor{stringliteral}{'model.mm\_projector.bias'}],\ f\textcolor{stringliteral}{'\{name\}\ not\ in\ base\ model'}}
\DoxyCodeLine{00044\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{continue}}
\DoxyCodeLine{00045\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ param.data.shape\ ==\ base.state\_dict()[name].shape:}
\DoxyCodeLine{00046\ \ \ \ \ \ \ \ \ \ \ \ \ param.data\ +=\ base.state\_dict()[name]}
\DoxyCodeLine{00047\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{else}:}
\DoxyCodeLine{00048\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{assert}\ name\ \textcolor{keywordflow}{in}\ [\textcolor{stringliteral}{'model.embed\_tokens.weight'},\ \textcolor{stringliteral}{'lm\_head.weight'}],\ \(\backslash\)}
\DoxyCodeLine{00049\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ f\textcolor{stringliteral}{'\{name\}\ dimension\ mismatch:\ \{param.data.shape\}\ vs\ \{base.state\_dict()[name].shape\}'}}
\DoxyCodeLine{00050\ \ \ \ \ \ \ \ \ \ \ \ \ bparam\ =\ base.state\_dict()[name]}
\DoxyCodeLine{00051\ \ \ \ \ \ \ \ \ \ \ \ \ param.data[:bparam.shape[0],\ :bparam.shape[1]]\ +=\ bparam}
\DoxyCodeLine{00052\ }
\DoxyCodeLine{00053\ \ \ \ \ print(\textcolor{stringliteral}{"{}Saving\ target\ model"{}})}
\DoxyCodeLine{00054\ \ \ \ \ delta.save\_pretrained(target\_model\_path)}
\DoxyCodeLine{00055\ \ \ \ \ delta\_tokenizer.save\_pretrained(target\_model\_path)}
\DoxyCodeLine{00056\ }
\DoxyCodeLine{00057\ }

\end{DoxyCode}


\doxysubsection{Variable Documentation}
\Hypertarget{namespacellava_1_1model_1_1apply__delta_a1ed1f5bab2dc161b4ce2e90e376bd21d}\index{llava.model.apply\_delta@{llava.model.apply\_delta}!args@{args}}
\index{args@{args}!llava.model.apply\_delta@{llava.model.apply\_delta}}
\doxysubsubsection{\texorpdfstring{args}{args}}
{\footnotesize\ttfamily \label{namespacellava_1_1model_1_1apply__delta_a1ed1f5bab2dc161b4ce2e90e376bd21d} 
llava.\+model.\+apply\+\_\+delta.\+args = parser.\+parse\+\_\+args()}



Definition at line \mbox{\hyperlink{apply__delta_8py_source_l00064}{64}} of file \mbox{\hyperlink{apply__delta_8py_source}{apply\+\_\+delta.\+py}}.

\Hypertarget{namespacellava_1_1model_1_1apply__delta_a9a1ce1f75ee1d38fe64467def1c7e885}\index{llava.model.apply\_delta@{llava.model.apply\_delta}!parser@{parser}}
\index{parser@{parser}!llava.model.apply\_delta@{llava.model.apply\_delta}}
\doxysubsubsection{\texorpdfstring{parser}{parser}}
{\footnotesize\ttfamily \label{namespacellava_1_1model_1_1apply__delta_a9a1ce1f75ee1d38fe64467def1c7e885} 
llava.\+model.\+apply\+\_\+delta.\+parser = argparse.\+Argument\+Parser()}



Definition at line \mbox{\hyperlink{apply__delta_8py_source_l00059}{59}} of file \mbox{\hyperlink{apply__delta_8py_source}{apply\+\_\+delta.\+py}}.

\Hypertarget{namespacellava_1_1model_1_1apply__delta_a00db04d3e948afe7196bacb84201a6a9}\index{llava.model.apply\_delta@{llava.model.apply\_delta}!required@{required}}
\index{required@{required}!llava.model.apply\_delta@{llava.model.apply\_delta}}
\doxysubsubsection{\texorpdfstring{required}{required}}
{\footnotesize\ttfamily \label{namespacellava_1_1model_1_1apply__delta_a00db04d3e948afe7196bacb84201a6a9} 
llava.\+model.\+apply\+\_\+delta.\+required}



Definition at line \mbox{\hyperlink{apply__delta_8py_source_l00060}{60}} of file \mbox{\hyperlink{apply__delta_8py_source}{apply\+\_\+delta.\+py}}.

\Hypertarget{namespacellava_1_1model_1_1apply__delta_aa7896f479fbbbea00a0778f672ed5707}\index{llava.model.apply\_delta@{llava.model.apply\_delta}!str@{str}}
\index{str@{str}!llava.model.apply\_delta@{llava.model.apply\_delta}}
\doxysubsubsection{\texorpdfstring{str}{str}}
{\footnotesize\ttfamily \label{namespacellava_1_1model_1_1apply__delta_aa7896f479fbbbea00a0778f672ed5707} 
llava.\+model.\+apply\+\_\+delta.\+str}



Definition at line \mbox{\hyperlink{apply__delta_8py_source_l00060}{60}} of file \mbox{\hyperlink{apply__delta_8py_source}{apply\+\_\+delta.\+py}}.

\Hypertarget{namespacellava_1_1model_1_1apply__delta_a186c670d72b9afbba6b77c2ddc1e6d8b}\index{llava.model.apply\_delta@{llava.model.apply\_delta}!type@{type}}
\index{type@{type}!llava.model.apply\_delta@{llava.model.apply\_delta}}
\doxysubsubsection{\texorpdfstring{type}{type}}
{\footnotesize\ttfamily \label{namespacellava_1_1model_1_1apply__delta_a186c670d72b9afbba6b77c2ddc1e6d8b} 
llava.\+model.\+apply\+\_\+delta.\+type}



Definition at line \mbox{\hyperlink{apply__delta_8py_source_l00060}{60}} of file \mbox{\hyperlink{apply__delta_8py_source}{apply\+\_\+delta.\+py}}.

