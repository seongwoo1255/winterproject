\doxysection{eval\+\_\+textvqa.\+py}
\hypertarget{eval__textvqa_8py_source}{}\label{eval__textvqa_8py_source}\index{llava/eval/eval\_textvqa.py@{llava/eval/eval\_textvqa.py}}
\mbox{\hyperlink{eval__textvqa_8py}{Go to the documentation of this file.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{\Hypertarget{eval__textvqa_8py_source_l00001}\mbox{\hyperlink{namespaceeval__textvqa}{00001}}\ \textcolor{keyword}{import}\ os}
\DoxyCodeLine{\Hypertarget{eval__textvqa_8py_source_l00002}00002\ \textcolor{keyword}{import}\ argparse}
\DoxyCodeLine{\Hypertarget{eval__textvqa_8py_source_l00003}00003\ \textcolor{keyword}{import}\ json}
\DoxyCodeLine{\Hypertarget{eval__textvqa_8py_source_l00004}00004\ \textcolor{keyword}{import}\ re}
\DoxyCodeLine{\Hypertarget{eval__textvqa_8py_source_l00005}00005\ }
\DoxyCodeLine{\Hypertarget{eval__textvqa_8py_source_l00006}00006\ \textcolor{keyword}{from}\ llava.eval.m4c\_evaluator\ \textcolor{keyword}{import}\ TextVQAAccuracyEvaluator}
\DoxyCodeLine{\Hypertarget{eval__textvqa_8py_source_l00007}00007\ }
\DoxyCodeLine{\Hypertarget{eval__textvqa_8py_source_l00008}00008\ }
\DoxyCodeLine{\Hypertarget{eval__textvqa_8py_source_l00009}\mbox{\hyperlink{namespaceeval__textvqa_a0204ce3dea0a2c5f91817b2c732d2a77}{00009}}\ \textcolor{keyword}{def\ }\mbox{\hyperlink{namespaceeval__textvqa_a0204ce3dea0a2c5f91817b2c732d2a77}{get\_args}}():}
\DoxyCodeLine{\Hypertarget{eval__textvqa_8py_source_l00010}00010\ \ \ \ \ parser\ =\ argparse.ArgumentParser()}
\DoxyCodeLine{\Hypertarget{eval__textvqa_8py_source_l00011}00011\ \ \ \ \ parser.add\_argument(\textcolor{stringliteral}{'-\/-\/annotation-\/file'},\ type=str)}
\DoxyCodeLine{\Hypertarget{eval__textvqa_8py_source_l00012}00012\ \ \ \ \ parser.add\_argument(\textcolor{stringliteral}{'-\/-\/result-\/file'},\ type=str)}
\DoxyCodeLine{\Hypertarget{eval__textvqa_8py_source_l00013}00013\ \ \ \ \ parser.add\_argument(\textcolor{stringliteral}{'-\/-\/result-\/dir'},\ type=str)}
\DoxyCodeLine{\Hypertarget{eval__textvqa_8py_source_l00014}00014\ \ \ \ \ \textcolor{keywordflow}{return}\ parser.parse\_args()}
\DoxyCodeLine{\Hypertarget{eval__textvqa_8py_source_l00015}00015\ }
\DoxyCodeLine{\Hypertarget{eval__textvqa_8py_source_l00016}00016\ }
\DoxyCodeLine{\Hypertarget{eval__textvqa_8py_source_l00017}\mbox{\hyperlink{namespaceeval__textvqa_a1eb86dc2da2dd2b1f6b9d02a6475e54d}{00017}}\ \textcolor{keyword}{def\ }\mbox{\hyperlink{namespaceeval__textvqa_a1eb86dc2da2dd2b1f6b9d02a6475e54d}{prompt\_processor}}(prompt):}
\DoxyCodeLine{\Hypertarget{eval__textvqa_8py_source_l00018}00018\ \ \ \ \ \textcolor{keywordflow}{if}\ prompt.startswith(\textcolor{stringliteral}{'OCR\ tokens:\ '}):}
\DoxyCodeLine{\Hypertarget{eval__textvqa_8py_source_l00019}00019\ \ \ \ \ \ \ \ \ pattern\ =\ \textcolor{stringliteral}{r"{}Question:\ (.*?)\ Short\ answer:"{}}}
\DoxyCodeLine{\Hypertarget{eval__textvqa_8py_source_l00020}00020\ \ \ \ \ \ \ \ \ match\ =\ re.search(pattern,\ prompt,\ re.DOTALL)}
\DoxyCodeLine{\Hypertarget{eval__textvqa_8py_source_l00021}00021\ \ \ \ \ \ \ \ \ question\ =\ match.group(1)}
\DoxyCodeLine{\Hypertarget{eval__textvqa_8py_source_l00022}00022\ \ \ \ \ \textcolor{keywordflow}{elif}\ \textcolor{stringliteral}{'Reference\ OCR\ token:\ '}\ \textcolor{keywordflow}{in}\ prompt\ \textcolor{keywordflow}{and}\ len(prompt.split(\textcolor{stringliteral}{'\(\backslash\)n'}))\ ==\ 3:}
\DoxyCodeLine{\Hypertarget{eval__textvqa_8py_source_l00023}00023\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ prompt.startswith(\textcolor{stringliteral}{'Reference\ OCR\ token:'}):}
\DoxyCodeLine{\Hypertarget{eval__textvqa_8py_source_l00024}00024\ \ \ \ \ \ \ \ \ \ \ \ \ question\ =\ prompt.split(\textcolor{stringliteral}{'\(\backslash\)n'})[1]}
\DoxyCodeLine{\Hypertarget{eval__textvqa_8py_source_l00025}00025\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{else}:}
\DoxyCodeLine{\Hypertarget{eval__textvqa_8py_source_l00026}00026\ \ \ \ \ \ \ \ \ \ \ \ \ question\ =\ prompt.split(\textcolor{stringliteral}{'\(\backslash\)n'})[0]}
\DoxyCodeLine{\Hypertarget{eval__textvqa_8py_source_l00027}00027\ \ \ \ \ \textcolor{keywordflow}{elif}\ len(prompt.split(\textcolor{stringliteral}{'\(\backslash\)n'}))\ ==\ 2:}
\DoxyCodeLine{\Hypertarget{eval__textvqa_8py_source_l00028}00028\ \ \ \ \ \ \ \ \ question\ =\ prompt.split(\textcolor{stringliteral}{'\(\backslash\)n'})[0]}
\DoxyCodeLine{\Hypertarget{eval__textvqa_8py_source_l00029}00029\ \ \ \ \ \textcolor{keywordflow}{else}:}
\DoxyCodeLine{\Hypertarget{eval__textvqa_8py_source_l00030}00030\ \ \ \ \ \ \ \ \ \textcolor{keyword}{assert}\ \textcolor{keyword}{False}}
\DoxyCodeLine{\Hypertarget{eval__textvqa_8py_source_l00031}00031\ }
\DoxyCodeLine{\Hypertarget{eval__textvqa_8py_source_l00032}00032\ \ \ \ \ \textcolor{keywordflow}{return}\ question.lower()}
\DoxyCodeLine{\Hypertarget{eval__textvqa_8py_source_l00033}00033\ }
\DoxyCodeLine{\Hypertarget{eval__textvqa_8py_source_l00034}00034\ }
\DoxyCodeLine{\Hypertarget{eval__textvqa_8py_source_l00035}\mbox{\hyperlink{namespaceeval__textvqa_a646c89dca1e2cf9771d74a8b741edee6}{00035}}\ \textcolor{keyword}{def\ }\mbox{\hyperlink{namespaceeval__textvqa_a646c89dca1e2cf9771d74a8b741edee6}{eval\_single}}(annotation\_file,\ result\_file):}
\DoxyCodeLine{\Hypertarget{eval__textvqa_8py_source_l00036}00036\ \ \ \ \ experiment\_name\ =\ os.path.splitext(os.path.basename(result\_file))[0]}
\DoxyCodeLine{\Hypertarget{eval__textvqa_8py_source_l00037}00037\ \ \ \ \ print(experiment\_name)}
\DoxyCodeLine{\Hypertarget{eval__textvqa_8py_source_l00038}00038\ \ \ \ \ annotations\ =\ json.load(open(annotation\_file))[\textcolor{stringliteral}{'data'}]}
\DoxyCodeLine{\Hypertarget{eval__textvqa_8py_source_l00039}00039\ \ \ \ \ annotations\ =\ \{(annotation[\textcolor{stringliteral}{'image\_id'}],\ annotation[\textcolor{stringliteral}{'question'}].lower()):\ annotation\ \textcolor{keywordflow}{for}\ annotation\ \textcolor{keywordflow}{in}\ annotations\}}
\DoxyCodeLine{\Hypertarget{eval__textvqa_8py_source_l00040}00040\ \ \ \ \ results\ =\ [json.loads(line)\ \textcolor{keywordflow}{for}\ line\ \textcolor{keywordflow}{in}\ open(result\_file)]}
\DoxyCodeLine{\Hypertarget{eval__textvqa_8py_source_l00041}00041\ }
\DoxyCodeLine{\Hypertarget{eval__textvqa_8py_source_l00042}00042\ \ \ \ \ pred\_list\ =\ []}
\DoxyCodeLine{\Hypertarget{eval__textvqa_8py_source_l00043}00043\ \ \ \ \ \textcolor{keywordflow}{for}\ result\ \textcolor{keywordflow}{in}\ results:}
\DoxyCodeLine{\Hypertarget{eval__textvqa_8py_source_l00044}00044\ \ \ \ \ \ \ \ \ annotation\ =\ annotations[(result[\textcolor{stringliteral}{'question\_id'}],\ \mbox{\hyperlink{namespaceeval__textvqa_a1eb86dc2da2dd2b1f6b9d02a6475e54d}{prompt\_processor}}(result[\textcolor{stringliteral}{'prompt'}]))]}
\DoxyCodeLine{\Hypertarget{eval__textvqa_8py_source_l00045}00045\ \ \ \ \ \ \ \ \ pred\_list.append(\{}
\DoxyCodeLine{\Hypertarget{eval__textvqa_8py_source_l00046}00046\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}pred\_answer"{}}:\ result[\textcolor{stringliteral}{'text'}],}
\DoxyCodeLine{\Hypertarget{eval__textvqa_8py_source_l00047}00047\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}gt\_answers"{}}:\ annotation[\textcolor{stringliteral}{'answers'}],}
\DoxyCodeLine{\Hypertarget{eval__textvqa_8py_source_l00048}00048\ \ \ \ \ \ \ \ \ \})}
\DoxyCodeLine{\Hypertarget{eval__textvqa_8py_source_l00049}00049\ }
\DoxyCodeLine{\Hypertarget{eval__textvqa_8py_source_l00050}00050\ \ \ \ \ evaluator\ =\ TextVQAAccuracyEvaluator()}
\DoxyCodeLine{\Hypertarget{eval__textvqa_8py_source_l00051}00051\ \ \ \ \ print(\textcolor{stringliteral}{'Samples:\ \{\}\(\backslash\)nAccuracy:\ \{:.2f\}\%\(\backslash\)n'}.format(len(pred\_list),\ 100.\ *\ evaluator.eval\_pred\_list(pred\_list)))}
\DoxyCodeLine{\Hypertarget{eval__textvqa_8py_source_l00052}00052\ }
\DoxyCodeLine{\Hypertarget{eval__textvqa_8py_source_l00053}00053\ }
\DoxyCodeLine{\Hypertarget{eval__textvqa_8py_source_l00054}00054\ \textcolor{keywordflow}{if}\ \_\_name\_\_\ ==\ \textcolor{stringliteral}{"{}\_\_main\_\_"{}}:}
\DoxyCodeLine{\Hypertarget{eval__textvqa_8py_source_l00055}\mbox{\hyperlink{namespaceeval__textvqa_a201357262adf5767727d04a1a1b77fdf}{00055}}\ \ \ \ \ args\ =\ \mbox{\hyperlink{namespaceeval__textvqa_a0204ce3dea0a2c5f91817b2c732d2a77}{get\_args}}()}
\DoxyCodeLine{\Hypertarget{eval__textvqa_8py_source_l00056}00056\ }
\DoxyCodeLine{\Hypertarget{eval__textvqa_8py_source_l00057}00057\ \ \ \ \ \textcolor{keywordflow}{if}\ args.result\_file\ \textcolor{keywordflow}{is}\ \textcolor{keywordflow}{not}\ \textcolor{keywordtype}{None}:}
\DoxyCodeLine{\Hypertarget{eval__textvqa_8py_source_l00058}00058\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{namespaceeval__textvqa_a646c89dca1e2cf9771d74a8b741edee6}{eval\_single}}(args.annotation\_file,\ args.result\_file)}
\DoxyCodeLine{\Hypertarget{eval__textvqa_8py_source_l00059}00059\ }
\DoxyCodeLine{\Hypertarget{eval__textvqa_8py_source_l00060}00060\ \ \ \ \ \textcolor{keywordflow}{if}\ args.result\_dir\ \textcolor{keywordflow}{is}\ \textcolor{keywordflow}{not}\ \textcolor{keywordtype}{None}:}
\DoxyCodeLine{\Hypertarget{eval__textvqa_8py_source_l00061}00061\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ result\_file\ \textcolor{keywordflow}{in}\ sorted(os.listdir(args.result\_dir)):}
\DoxyCodeLine{\Hypertarget{eval__textvqa_8py_source_l00062}00062\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ \textcolor{keywordflow}{not}\ result\_file.endswith(\textcolor{stringliteral}{'.jsonl'}):}
\DoxyCodeLine{\Hypertarget{eval__textvqa_8py_source_l00063}00063\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ print(f\textcolor{stringliteral}{'Skipping\ \{result\_file\}'})}
\DoxyCodeLine{\Hypertarget{eval__textvqa_8py_source_l00064}00064\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{continue}}
\DoxyCodeLine{\Hypertarget{eval__textvqa_8py_source_l00065}00065\ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{namespaceeval__textvqa_a646c89dca1e2cf9771d74a8b741edee6}{eval\_single}}(args.annotation\_file,\ os.path.join(args.result\_dir,\ result\_file))}

\end{DoxyCode}
