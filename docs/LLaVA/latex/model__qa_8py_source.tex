\doxysection{model\+\_\+qa.\+py}
\hypertarget{model__qa_8py_source}{}\label{model__qa_8py_source}\index{llava/eval/model\_qa.py@{llava/eval/model\_qa.py}}
\mbox{\hyperlink{model__qa_8py}{Go to the documentation of this file.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{\Hypertarget{model__qa_8py_source_l00001}\mbox{\hyperlink{namespacemodel__qa}{00001}}\ \textcolor{keyword}{import}\ argparse}
\DoxyCodeLine{\Hypertarget{model__qa_8py_source_l00002}00002\ \textcolor{keyword}{from}\ transformers\ \textcolor{keyword}{import}\ AutoTokenizer,\ AutoModelForCausalLM,\ StoppingCriteria}
\DoxyCodeLine{\Hypertarget{model__qa_8py_source_l00003}00003\ \textcolor{keyword}{import}\ torch}
\DoxyCodeLine{\Hypertarget{model__qa_8py_source_l00004}00004\ \textcolor{keyword}{import}\ os}
\DoxyCodeLine{\Hypertarget{model__qa_8py_source_l00005}00005\ \textcolor{keyword}{import}\ json}
\DoxyCodeLine{\Hypertarget{model__qa_8py_source_l00006}00006\ \textcolor{keyword}{from}\ tqdm\ \textcolor{keyword}{import}\ tqdm}
\DoxyCodeLine{\Hypertarget{model__qa_8py_source_l00007}00007\ \textcolor{keyword}{import}\ shortuuid}
\DoxyCodeLine{\Hypertarget{model__qa_8py_source_l00008}00008\ }
\DoxyCodeLine{\Hypertarget{model__qa_8py_source_l00009}00009\ \textcolor{keyword}{from}\ \mbox{\hyperlink{namespacellava_1_1conversation}{llava.conversation}}\ \textcolor{keyword}{import}\ default\_conversation}
\DoxyCodeLine{\Hypertarget{model__qa_8py_source_l00010}00010\ \textcolor{keyword}{from}\ \mbox{\hyperlink{namespacellava_1_1utils}{llava.utils}}\ \textcolor{keyword}{import}\ disable\_torch\_init}
\DoxyCodeLine{\Hypertarget{model__qa_8py_source_l00011}00011\ }
\DoxyCodeLine{\Hypertarget{model__qa_8py_source_l00012}00012\ }
\DoxyCodeLine{\Hypertarget{model__qa_8py_source_l00013}00013\ \textcolor{preprocessor}{@torch.inference\_mode()}}
\DoxyCodeLine{\Hypertarget{model__qa_8py_source_l00014}\mbox{\hyperlink{namespacemodel__qa_a52fb0d67f3cdfcb2d0050ef6bdcac241}{00014}}\ \textcolor{keyword}{def\ }\mbox{\hyperlink{namespacemodel__qa_a52fb0d67f3cdfcb2d0050ef6bdcac241}{eval\_model}}(model\_name,\ questions\_file,\ answers\_file):}
\DoxyCodeLine{\Hypertarget{model__qa_8py_source_l00015}00015\ \ \ \ \ \textcolor{comment}{\#\ Model}}
\DoxyCodeLine{\Hypertarget{model__qa_8py_source_l00016}00016\ \ \ \ \ disable\_torch\_init()}
\DoxyCodeLine{\Hypertarget{model__qa_8py_source_l00017}00017\ \ \ \ \ model\_name\ =\ os.path.expanduser(model\_name)}
\DoxyCodeLine{\Hypertarget{model__qa_8py_source_l00018}00018\ \ \ \ \ tokenizer\ =\ AutoTokenizer.from\_pretrained(model\_name,\ use\_fast=\textcolor{keyword}{False})}
\DoxyCodeLine{\Hypertarget{model__qa_8py_source_l00019}00019\ \ \ \ \ model\ =\ AutoModelForCausalLM.from\_pretrained(model\_name,}
\DoxyCodeLine{\Hypertarget{model__qa_8py_source_l00020}00020\ \ \ \ \ \ \ \ \ torch\_dtype=torch.float16).cuda()}
\DoxyCodeLine{\Hypertarget{model__qa_8py_source_l00021}00021\ }
\DoxyCodeLine{\Hypertarget{model__qa_8py_source_l00022}00022\ }
\DoxyCodeLine{\Hypertarget{model__qa_8py_source_l00023}00023\ \ \ \ \ ques\_file\ =\ open(os.path.expanduser(questions\_file),\ \textcolor{stringliteral}{"{}r"{}})}
\DoxyCodeLine{\Hypertarget{model__qa_8py_source_l00024}00024\ \ \ \ \ ans\_file\ =\ open(os.path.expanduser(answers\_file),\ \textcolor{stringliteral}{"{}w"{}})}
\DoxyCodeLine{\Hypertarget{model__qa_8py_source_l00025}00025\ \ \ \ \ \textcolor{keywordflow}{for}\ i,\ line\ \textcolor{keywordflow}{in}\ enumerate(tqdm(ques\_file)):}
\DoxyCodeLine{\Hypertarget{model__qa_8py_source_l00026}00026\ \ \ \ \ \ \ \ \ idx\ =\ json.loads(line)[\textcolor{stringliteral}{"{}question\_id"{}}]}
\DoxyCodeLine{\Hypertarget{model__qa_8py_source_l00027}00027\ \ \ \ \ \ \ \ \ qs\ =\ json.loads(line)[\textcolor{stringliteral}{"{}text"{}}]}
\DoxyCodeLine{\Hypertarget{model__qa_8py_source_l00028}00028\ \ \ \ \ \ \ \ \ cat\ =\ json.loads(line)[\textcolor{stringliteral}{"{}category"{}}]}
\DoxyCodeLine{\Hypertarget{model__qa_8py_source_l00029}00029\ \ \ \ \ \ \ \ \ conv\ =\ default\_conversation.copy()}
\DoxyCodeLine{\Hypertarget{model__qa_8py_source_l00030}00030\ \ \ \ \ \ \ \ \ conv.append\_message(conv.roles[0],\ qs)}
\DoxyCodeLine{\Hypertarget{model__qa_8py_source_l00031}00031\ \ \ \ \ \ \ \ \ prompt\ =\ conv.get\_prompt()}
\DoxyCodeLine{\Hypertarget{model__qa_8py_source_l00032}00032\ \ \ \ \ \ \ \ \ inputs\ =\ tokenizer([prompt])}
\DoxyCodeLine{\Hypertarget{model__qa_8py_source_l00033}00033\ \ \ \ \ \ \ \ \ input\_ids\ =\ torch.as\_tensor(inputs.input\_ids).cuda()}
\DoxyCodeLine{\Hypertarget{model__qa_8py_source_l00034}00034\ \ \ \ \ \ \ \ \ output\_ids\ =\ model.generate(}
\DoxyCodeLine{\Hypertarget{model__qa_8py_source_l00035}00035\ \ \ \ \ \ \ \ \ \ \ \ \ input\_ids,}
\DoxyCodeLine{\Hypertarget{model__qa_8py_source_l00036}00036\ \ \ \ \ \ \ \ \ \ \ \ \ do\_sample=\textcolor{keyword}{True},}
\DoxyCodeLine{\Hypertarget{model__qa_8py_source_l00037}00037\ \ \ \ \ \ \ \ \ \ \ \ \ use\_cache=\textcolor{keyword}{True},}
\DoxyCodeLine{\Hypertarget{model__qa_8py_source_l00038}00038\ \ \ \ \ \ \ \ \ \ \ \ \ temperature=0.7,}
\DoxyCodeLine{\Hypertarget{model__qa_8py_source_l00039}00039\ \ \ \ \ \ \ \ \ \ \ \ \ max\_new\_tokens=1024,)}
\DoxyCodeLine{\Hypertarget{model__qa_8py_source_l00040}00040\ \ \ \ \ \ \ \ \ outputs\ =\ tokenizer.batch\_decode(output\_ids,\ skip\_special\_tokens=\textcolor{keyword}{True})[0]}
\DoxyCodeLine{\Hypertarget{model__qa_8py_source_l00041}00041\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{try}:}
\DoxyCodeLine{\Hypertarget{model__qa_8py_source_l00042}00042\ \ \ \ \ \ \ \ \ \ \ \ \ index\ =\ outputs.index(conv.sep,\ len(prompt))}
\DoxyCodeLine{\Hypertarget{model__qa_8py_source_l00043}00043\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{except}\ ValueError:}
\DoxyCodeLine{\Hypertarget{model__qa_8py_source_l00044}00044\ \ \ \ \ \ \ \ \ \ \ \ \ outputs\ +=\ conv.sep}
\DoxyCodeLine{\Hypertarget{model__qa_8py_source_l00045}00045\ \ \ \ \ \ \ \ \ \ \ \ \ index\ =\ outputs.index(conv.sep,\ len(prompt))}
\DoxyCodeLine{\Hypertarget{model__qa_8py_source_l00046}00046\ }
\DoxyCodeLine{\Hypertarget{model__qa_8py_source_l00047}00047\ \ \ \ \ \ \ \ \ outputs\ =\ outputs[len(prompt)\ +\ len(conv.roles[1])\ +\ 2:index].strip()}
\DoxyCodeLine{\Hypertarget{model__qa_8py_source_l00048}00048\ \ \ \ \ \ \ \ \ ans\_id\ =\ shortuuid.uuid()}
\DoxyCodeLine{\Hypertarget{model__qa_8py_source_l00049}00049\ \ \ \ \ \ \ \ \ ans\_file.write(json.dumps(\{\textcolor{stringliteral}{"{}question\_id"{}}:\ idx,}
\DoxyCodeLine{\Hypertarget{model__qa_8py_source_l00050}00050\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}text"{}}:\ outputs,}
\DoxyCodeLine{\Hypertarget{model__qa_8py_source_l00051}00051\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}answer\_id"{}}:\ ans\_id,}
\DoxyCodeLine{\Hypertarget{model__qa_8py_source_l00052}00052\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}model\_id"{}}:\ model\_name,}
\DoxyCodeLine{\Hypertarget{model__qa_8py_source_l00053}00053\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}metadata"{}}:\ \{\}\})\ +\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}})}
\DoxyCodeLine{\Hypertarget{model__qa_8py_source_l00054}00054\ \ \ \ \ \ \ \ \ ans\_file.flush()}
\DoxyCodeLine{\Hypertarget{model__qa_8py_source_l00055}00055\ \ \ \ \ ans\_file.close()}
\DoxyCodeLine{\Hypertarget{model__qa_8py_source_l00056}00056\ }
\DoxyCodeLine{\Hypertarget{model__qa_8py_source_l00057}00057\ \textcolor{keywordflow}{if}\ \_\_name\_\_\ ==\ \textcolor{stringliteral}{"{}\_\_main\_\_"{}}:}
\DoxyCodeLine{\Hypertarget{model__qa_8py_source_l00058}\mbox{\hyperlink{namespacemodel__qa_a12f4b6b5225f9b110b7328069edae44a}{00058}}\ \ \ \ \ parser\ =\ argparse.ArgumentParser()}
\DoxyCodeLine{\Hypertarget{model__qa_8py_source_l00059}\mbox{\hyperlink{namespacemodel__qa_a671fc033fe335a73e5a713e4b93665f3}{00059}}\ \ \ \ \ parser.add\_argument(\textcolor{stringliteral}{"{}-\/-\/model-\/name"{}},\ type=str,\ default=\textcolor{stringliteral}{"{}facebook/opt-\/350m"{}})}
\DoxyCodeLine{\Hypertarget{model__qa_8py_source_l00060}00060\ \ \ \ \ parser.add\_argument(\textcolor{stringliteral}{"{}-\/-\/question-\/file"{}},\ type=str,\ default=\textcolor{stringliteral}{"{}tables/question.jsonl"{}})}
\DoxyCodeLine{\Hypertarget{model__qa_8py_source_l00061}00061\ \ \ \ \ parser.add\_argument(\textcolor{stringliteral}{"{}-\/-\/answers-\/file"{}},\ type=str,\ default=\textcolor{stringliteral}{"{}answer.jsonl"{}})}
\DoxyCodeLine{\Hypertarget{model__qa_8py_source_l00062}\mbox{\hyperlink{namespacemodel__qa_af63a291b5bf47ab699f943f7d881f84e}{00062}}\ \ \ \ \ args\ =\ parser.parse\_args()}
\DoxyCodeLine{\Hypertarget{model__qa_8py_source_l00063}00063\ }
\DoxyCodeLine{\Hypertarget{model__qa_8py_source_l00064}00064\ \ \ \ \ \mbox{\hyperlink{namespacemodel__qa_a52fb0d67f3cdfcb2d0050ef6bdcac241}{eval\_model}}(args.model\_name,\ args.question\_file,\ args.answers\_file)}

\end{DoxyCode}
