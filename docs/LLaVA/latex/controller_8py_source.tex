\doxysection{controller.\+py}
\hypertarget{controller_8py_source}{}\label{controller_8py_source}\index{llava/serve/controller.py@{llava/serve/controller.py}}
\mbox{\hyperlink{controller_8py}{Go to the documentation of this file.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00001}\mbox{\hyperlink{namespacellava_1_1serve_1_1controller}{00001}}\ \textcolor{stringliteral}{"{}"{}"{}}}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00002}00002\ \textcolor{stringliteral}{A\ controller\ manages\ distributed\ workers.}}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00003}00003\ \textcolor{stringliteral}{It\ sends\ worker\ addresses\ to\ clients.}}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00004}00004\ \textcolor{stringliteral}{"{}"{}"{}}}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00005}00005\ \textcolor{keyword}{import}\ argparse}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00006}00006\ \textcolor{keyword}{import}\ asyncio}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00007}00007\ \textcolor{keyword}{import}\ dataclasses}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00008}00008\ \textcolor{keyword}{from}\ enum\ \textcolor{keyword}{import}\ Enum,\ auto}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00009}00009\ \textcolor{keyword}{import}\ json}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00010}00010\ \textcolor{keyword}{import}\ logging}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00011}00011\ \textcolor{keyword}{import}\ time}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00012}00012\ \textcolor{keyword}{from}\ typing\ \textcolor{keyword}{import}\ List,\ Union}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00013}00013\ \textcolor{keyword}{import}\ threading}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00014}00014\ }
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00015}00015\ \textcolor{keyword}{from}\ fastapi\ \textcolor{keyword}{import}\ FastAPI,\ Request}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00016}00016\ \textcolor{keyword}{from}\ fastapi.responses\ \textcolor{keyword}{import}\ StreamingResponse}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00017}00017\ \textcolor{keyword}{import}\ numpy\ \textcolor{keyword}{as}\ np}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00018}00018\ \textcolor{keyword}{import}\ requests}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00019}00019\ \textcolor{keyword}{import}\ uvicorn}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00020}00020\ }
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00021}00021\ \textcolor{keyword}{from}\ \mbox{\hyperlink{namespacellava_1_1constants}{llava.constants}}\ \textcolor{keyword}{import}\ CONTROLLER\_HEART\_BEAT\_EXPIRATION}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00022}00022\ \textcolor{keyword}{from}\ \mbox{\hyperlink{namespacellava_1_1utils}{llava.utils}}\ \textcolor{keyword}{import}\ build\_logger,\ server\_error\_msg}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00023}00023\ }
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00024}00024\ }
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00025}\mbox{\hyperlink{namespacellava_1_1serve_1_1controller_a777ac03a4e2fa2f6d57e19e2c22c14a9}{00025}}\ logger\ =\ build\_logger(\textcolor{stringliteral}{"{}controller"{}},\ \textcolor{stringliteral}{"{}controller.log"{}})}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00026}00026\ }
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00027}00027\ }
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00028}\mbox{\hyperlink{classllava_1_1serve_1_1controller_1_1_dispatch_method}{00028}}\ \textcolor{keyword}{class\ }\mbox{\hyperlink{classllava_1_1serve_1_1controller_1_1_dispatch_method}{DispatchMethod}}(Enum):}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00029}\mbox{\hyperlink{classllava_1_1serve_1_1controller_1_1_dispatch_method_a6e58ac4f2457b5f2318c35b628b5212b}{00029}}\ \ \ \ \ LOTTERY\ =\ auto()}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00030}\mbox{\hyperlink{classllava_1_1serve_1_1controller_1_1_dispatch_method_ab03d25c3ae21d44a489eb6cc15e0c0b6}{00030}}\ \ \ \ \ SHORTEST\_QUEUE\ =\ auto()}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00031}00031\ }
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00032}00032\ \ \ \ \ \textcolor{preprocessor}{@classmethod}}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00033}\mbox{\hyperlink{classllava_1_1serve_1_1controller_1_1_dispatch_method_a84fb7ab3c70b8944f1685e996894ee2a}{00033}}\ \ \ \ \ \textcolor{keyword}{def\ }\mbox{\hyperlink{classllava_1_1serve_1_1controller_1_1_dispatch_method_a84fb7ab3c70b8944f1685e996894ee2a}{from\_str}}(cls,\ name):}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00034}00034\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ name\ ==\ \textcolor{stringliteral}{"{}lottery"{}}:}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00035}00035\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ cls.\mbox{\hyperlink{classllava_1_1serve_1_1controller_1_1_dispatch_method_a6e58ac4f2457b5f2318c35b628b5212b}{LOTTERY}}}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00036}00036\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{elif}\ name\ ==\ \textcolor{stringliteral}{"{}shortest\_queue"{}}:}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00037}00037\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ cls.\mbox{\hyperlink{classllava_1_1serve_1_1controller_1_1_dispatch_method_ab03d25c3ae21d44a489eb6cc15e0c0b6}{SHORTEST\_QUEUE}}}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00038}00038\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{else}:}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00039}00039\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{raise}\ ValueError(f\textcolor{stringliteral}{"{}Invalid\ dispatch\ method"{}})}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00040}00040\ }
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00041}00041\ }
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00042}00042\ \textcolor{preprocessor}{@dataclasses.dataclass}}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00043}\mbox{\hyperlink{classllava_1_1serve_1_1controller_1_1_worker_info}{00043}}\ \textcolor{keyword}{class\ }\mbox{\hyperlink{classllava_1_1serve_1_1controller_1_1_worker_info}{WorkerInfo}}:}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00044}\mbox{\hyperlink{classllava_1_1serve_1_1controller_1_1_worker_info_a0bfe698b799f8bbc7c89836ce53ea5b1}{00044}}\ \ \ \ \ model\_names:\ List[str]}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00045}00045\ \ \ \ \ speed:\ int}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00046}00046\ \ \ \ \ queue\_length:\ int}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00047}00047\ \ \ \ \ check\_heart\_beat:\ bool}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00048}00048\ \ \ \ \ last\_heart\_beat:\ str}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00049}00049\ }
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00050}00050\ }
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00051}\mbox{\hyperlink{namespacellava_1_1serve_1_1controller_a22cb56fe6a282b97161587efdd56750a}{00051}}\ \textcolor{keyword}{def\ }\mbox{\hyperlink{namespacellava_1_1serve_1_1controller_a22cb56fe6a282b97161587efdd56750a}{heart\_beat\_controller}}(controller):}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00052}00052\ \ \ \ \ \textcolor{keywordflow}{while}\ \textcolor{keyword}{True}:}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00053}00053\ \ \ \ \ \ \ \ \ time.sleep(CONTROLLER\_HEART\_BEAT\_EXPIRATION)}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00054}00054\ \ \ \ \ \ \ \ \ controller.remove\_stable\_workers\_by\_expiration()}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00055}00055\ }
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00056}00056\ }
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00057}\mbox{\hyperlink{classllava_1_1serve_1_1controller_1_1_controller}{00057}}\ \textcolor{keyword}{class\ }\mbox{\hyperlink{classllava_1_1serve_1_1controller_1_1_controller}{Controller}}:}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00058}\mbox{\hyperlink{classllava_1_1serve_1_1controller_1_1_controller_aa4d4375f31155bc421054b6e08a64b6b}{00058}}\ \ \ \ \ \textcolor{keyword}{def\ }\mbox{\hyperlink{classllava_1_1serve_1_1controller_1_1_controller_aa4d4375f31155bc421054b6e08a64b6b}{\_\_init\_\_}}(self,\ dispatch\_method:\ str):}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00059}00059\ \ \ \ \ \ \ \ \ \textcolor{comment}{\#\ Dict[str\ -\/>\ WorkerInfo]}}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00060}\mbox{\hyperlink{classllava_1_1serve_1_1controller_1_1_controller_aee05cb42d96aeb0f24e6333454a1f666}{00060}}\ \ \ \ \ \ \ \ \ self.\mbox{\hyperlink{classllava_1_1serve_1_1controller_1_1_controller_aee05cb42d96aeb0f24e6333454a1f666}{worker\_info}}\ =\ \{\}}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00061}\mbox{\hyperlink{classllava_1_1serve_1_1controller_1_1_controller_a3d8eb3a9d07f3958e8dc9cfc92625550}{00061}}\ \ \ \ \ \ \ \ \ self.\mbox{\hyperlink{classllava_1_1serve_1_1controller_1_1_controller_a3d8eb3a9d07f3958e8dc9cfc92625550}{dispatch\_method}}\ =\ DispatchMethod.from\_str(dispatch\_method)}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00062}00062\ }
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00063}\mbox{\hyperlink{classllava_1_1serve_1_1controller_1_1_controller_a68af796eb61cad11060b27e922b6ca36}{00063}}\ \ \ \ \ \ \ \ \ self.\mbox{\hyperlink{classllava_1_1serve_1_1controller_1_1_controller_a68af796eb61cad11060b27e922b6ca36}{heart\_beat\_thread}}\ =\ threading.Thread(}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00064}00064\ \ \ \ \ \ \ \ \ \ \ \ \ target=heart\_beat\_controller,\ args=(self,),\ daemon=\textcolor{keyword}{True})}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00065}00065\ \ \ \ \ \ \ \ \ self.\mbox{\hyperlink{classllava_1_1serve_1_1controller_1_1_controller_a68af796eb61cad11060b27e922b6ca36}{heart\_beat\_thread}}.start()}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00066}00066\ }
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00067}00067\ \ \ \ \ \ \ \ \ logger.info(\textcolor{stringliteral}{"{}Init\ controller"{}})}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00068}00068\ }
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00069}\mbox{\hyperlink{classllava_1_1serve_1_1controller_1_1_controller_a6471c382642def00c412d82bdc473ac3}{00069}}\ \ \ \ \ \textcolor{keyword}{def\ }register\_worker(self,\ worker\_name:\ str,\ check\_heart\_beat:\ bool,}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00070}00070\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ worker\_status:\ dict):}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00071}00071\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ worker\_name\ \textcolor{keywordflow}{not}\ \textcolor{keywordflow}{in}\ self.\mbox{\hyperlink{classllava_1_1serve_1_1controller_1_1_controller_aee05cb42d96aeb0f24e6333454a1f666}{worker\_info}}:}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00072}00072\ \ \ \ \ \ \ \ \ \ \ \ \ logger.info(f\textcolor{stringliteral}{"{}Register\ a\ new\ worker:\ \{worker\_name\}"{}})}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00073}00073\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{else}:}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00074}00074\ \ \ \ \ \ \ \ \ \ \ \ \ logger.info(f\textcolor{stringliteral}{"{}Register\ an\ existing\ worker:\ \{worker\_name\}"{}})}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00075}00075\ }
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00076}00076\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ \textcolor{keywordflow}{not}\ worker\_status:}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00077}00077\ \ \ \ \ \ \ \ \ \ \ \ \ worker\_status\ =\ self.\mbox{\hyperlink{classllava_1_1serve_1_1controller_1_1_controller_af02dbb01db45557de6b6318fe5302616}{get\_worker\_status}}(worker\_name)}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00078}00078\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ \textcolor{keywordflow}{not}\ worker\_status:}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00079}00079\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{False}}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00080}00080\ }
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00081}00081\ \ \ \ \ \ \ \ \ self.\mbox{\hyperlink{classllava_1_1serve_1_1controller_1_1_controller_aee05cb42d96aeb0f24e6333454a1f666}{worker\_info}}[worker\_name]\ =\ \mbox{\hyperlink{classllava_1_1serve_1_1controller_1_1_worker_info}{WorkerInfo}}(}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00082}00082\ \ \ \ \ \ \ \ \ \ \ \ \ worker\_status[\textcolor{stringliteral}{"{}model\_names"{}}],\ worker\_status[\textcolor{stringliteral}{"{}speed"{}}],\ worker\_status[\textcolor{stringliteral}{"{}queue\_length"{}}],}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00083}00083\ \ \ \ \ \ \ \ \ \ \ \ \ check\_heart\_beat,\ time.time())}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00084}00084\ }
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00085}00085\ \ \ \ \ \ \ \ \ logger.info(f\textcolor{stringliteral}{"{}Register\ done:\ \{worker\_name\},\ \{worker\_status\}"{}})}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00086}00086\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{True}}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00087}00087\ }
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00088}\mbox{\hyperlink{classllava_1_1serve_1_1controller_1_1_controller_af02dbb01db45557de6b6318fe5302616}{00088}}\ \ \ \ \ \textcolor{keyword}{def\ }\mbox{\hyperlink{classllava_1_1serve_1_1controller_1_1_controller_af02dbb01db45557de6b6318fe5302616}{get\_worker\_status}}(self,\ worker\_name:\ str):}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00089}00089\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{try}:}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00090}00090\ \ \ \ \ \ \ \ \ \ \ \ \ r\ =\ requests.post(worker\_name\ +\ \textcolor{stringliteral}{"{}/worker\_get\_status"{}},\ timeout=5)}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00091}00091\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{except}\ requests.exceptions.RequestException\ \textcolor{keyword}{as}\ e:}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00092}00092\ \ \ \ \ \ \ \ \ \ \ \ \ logger.error(f\textcolor{stringliteral}{"{}Get\ status\ fails:\ \{worker\_name\},\ \{e\}"{}})}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00093}00093\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keywordtype}{None}}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00094}00094\ }
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00095}00095\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ r.status\_code\ !=\ 200:}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00096}00096\ \ \ \ \ \ \ \ \ \ \ \ \ logger.error(f\textcolor{stringliteral}{"{}Get\ status\ fails:\ \{worker\_name\},\ \{r\}"{}})}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00097}00097\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keywordtype}{None}}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00098}00098\ }
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00099}00099\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ r.json()}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00100}00100\ }
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00101}\mbox{\hyperlink{classllava_1_1serve_1_1controller_1_1_controller_a4eb8b9a3300f8270fb1071422680e88f}{00101}}\ \ \ \ \ \textcolor{keyword}{def\ }\mbox{\hyperlink{classllava_1_1serve_1_1controller_1_1_controller_a4eb8b9a3300f8270fb1071422680e88f}{remove\_worker}}(self,\ worker\_name:\ str):}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00102}00102\ \ \ \ \ \ \ \ \ del\ self.\mbox{\hyperlink{classllava_1_1serve_1_1controller_1_1_controller_aee05cb42d96aeb0f24e6333454a1f666}{worker\_info}}[worker\_name]}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00103}00103\ }
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00104}\mbox{\hyperlink{classllava_1_1serve_1_1controller_1_1_controller_ad1b23f504a4c41c721abe029f539ba07}{00104}}\ \ \ \ \ \textcolor{keyword}{def\ }\mbox{\hyperlink{namespacellava_1_1serve_1_1controller_a6ea76a06ebebb3f2edcbf57f9f83a486}{refresh\_all\_workers}}(self):}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00105}00105\ \ \ \ \ \ \ \ \ old\_info\ =\ dict(self.\mbox{\hyperlink{classllava_1_1serve_1_1controller_1_1_controller_aee05cb42d96aeb0f24e6333454a1f666}{worker\_info}})}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00106}00106\ \ \ \ \ \ \ \ \ self.\mbox{\hyperlink{classllava_1_1serve_1_1controller_1_1_controller_aee05cb42d96aeb0f24e6333454a1f666}{worker\_info}}\ =\ \{\}}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00107}00107\ }
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00108}00108\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ w\_name,\ w\_info\ \textcolor{keywordflow}{in}\ old\_info.items():}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00109}00109\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ \textcolor{keywordflow}{not}\ self.\mbox{\hyperlink{classllava_1_1serve_1_1controller_1_1_controller_a6471c382642def00c412d82bdc473ac3}{register\_worker}}(w\_name,\ w\_info.check\_heart\_beat,\ \textcolor{keywordtype}{None}):}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00110}00110\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ logger.info(f\textcolor{stringliteral}{"{}Remove\ stale\ worker:\ \{w\_name\}"{}})}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00111}00111\ }
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00112}\mbox{\hyperlink{classllava_1_1serve_1_1controller_1_1_controller_a95cb39c88d0bf749d7bcb7518d81ef41}{00112}}\ \ \ \ \ \textcolor{keyword}{def\ }\mbox{\hyperlink{namespacellava_1_1serve_1_1controller_abb2714d45fa6c6f8d0d1f57d7dc72902}{list\_models}}(self):}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00113}00113\ \ \ \ \ \ \ \ \ model\_names\ =\ set()}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00114}00114\ }
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00115}00115\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ w\_name,\ w\_info\ \textcolor{keywordflow}{in}\ self.\mbox{\hyperlink{classllava_1_1serve_1_1controller_1_1_controller_aee05cb42d96aeb0f24e6333454a1f666}{worker\_info}}.items():}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00116}00116\ \ \ \ \ \ \ \ \ \ \ \ \ model\_names.update(w\_info.model\_names)}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00117}00117\ }
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00118}00118\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ list(model\_names)}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00119}00119\ }
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00120}\mbox{\hyperlink{classllava_1_1serve_1_1controller_1_1_controller_aa622ce0c111890f7fdbe460bda6b9955}{00120}}\ \ \ \ \ \textcolor{keyword}{def\ }\mbox{\hyperlink{classllava_1_1serve_1_1controller_1_1_controller_aa622ce0c111890f7fdbe460bda6b9955}{get\_worker\_address}}(self,\ model\_name:\ str):}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00121}00121\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ self.\mbox{\hyperlink{classllava_1_1serve_1_1controller_1_1_controller_a3d8eb3a9d07f3958e8dc9cfc92625550}{dispatch\_method}}\ ==\ DispatchMethod.LOTTERY:}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00122}00122\ \ \ \ \ \ \ \ \ \ \ \ \ worker\_names\ =\ []}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00123}00123\ \ \ \ \ \ \ \ \ \ \ \ \ worker\_speeds\ =\ []}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00124}00124\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ w\_name,\ w\_info\ \textcolor{keywordflow}{in}\ self.\mbox{\hyperlink{classllava_1_1serve_1_1controller_1_1_controller_aee05cb42d96aeb0f24e6333454a1f666}{worker\_info}}.items():}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00125}00125\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ model\_name\ \textcolor{keywordflow}{in}\ w\_info.model\_names:}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00126}00126\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ worker\_names.append(w\_name)}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00127}00127\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ worker\_speeds.append(w\_info.speed)}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00128}00128\ \ \ \ \ \ \ \ \ \ \ \ \ worker\_speeds\ =\ np.array(worker\_speeds,\ dtype=np.float32)}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00129}00129\ \ \ \ \ \ \ \ \ \ \ \ \ norm\ =\ np.sum(worker\_speeds)}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00130}00130\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ norm\ <\ 1e-\/4:}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00131}00131\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{stringliteral}{"{}"{}}}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00132}00132\ \ \ \ \ \ \ \ \ \ \ \ \ worker\_speeds\ =\ worker\_speeds\ /\ norm}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00133}00133\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ \textcolor{keyword}{True}:\ \ \textcolor{comment}{\#\ Directly\ return\ address}}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00134}00134\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ pt\ =\ np.random.choice(np.arange(len(worker\_names)),}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00135}00135\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ p=worker\_speeds)}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00136}00136\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ worker\_name\ =\ worker\_names[pt]}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00137}00137\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ worker\_name}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00138}00138\ }
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00139}00139\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{\#\ Check\ status\ before\ returning}}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00140}00140\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{while}\ \textcolor{keyword}{True}:}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00141}00141\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ pt\ =\ np.random.choice(np.arange(len(worker\_names)),}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00142}00142\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ p=worker\_speeds)}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00143}00143\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ worker\_name\ =\ worker\_names[pt]}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00144}00144\ }
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00145}00145\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ self.\mbox{\hyperlink{classllava_1_1serve_1_1controller_1_1_controller_af02dbb01db45557de6b6318fe5302616}{get\_worker\_status}}(worker\_name):}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00146}00146\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{break}}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00147}00147\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{else}:}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00148}00148\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ self.\mbox{\hyperlink{classllava_1_1serve_1_1controller_1_1_controller_a4eb8b9a3300f8270fb1071422680e88f}{remove\_worker}}(worker\_name)}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00149}00149\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ worker\_speeds[pt]\ =\ 0}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00150}00150\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ norm\ =\ np.sum(worker\_speeds)}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00151}00151\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ norm\ <\ 1e-\/4:}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00152}00152\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{stringliteral}{"{}"{}}}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00153}00153\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ worker\_speeds\ =\ worker\_speeds\ /\ norm}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00154}00154\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{continue}}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00155}00155\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ worker\_name}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00156}00156\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{elif}\ self.\mbox{\hyperlink{classllava_1_1serve_1_1controller_1_1_controller_a3d8eb3a9d07f3958e8dc9cfc92625550}{dispatch\_method}}\ ==\ DispatchMethod.SHORTEST\_QUEUE:}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00157}00157\ \ \ \ \ \ \ \ \ \ \ \ \ worker\_names\ =\ []}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00158}00158\ \ \ \ \ \ \ \ \ \ \ \ \ worker\_qlen\ =\ []}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00159}00159\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ w\_name,\ w\_info\ \textcolor{keywordflow}{in}\ self.\mbox{\hyperlink{classllava_1_1serve_1_1controller_1_1_controller_aee05cb42d96aeb0f24e6333454a1f666}{worker\_info}}.items():}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00160}00160\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ model\_name\ \textcolor{keywordflow}{in}\ w\_info.model\_names:}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00161}00161\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ worker\_names.append(w\_name)}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00162}00162\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ worker\_qlen.append(w\_info.queue\_length\ /\ w\_info.speed)}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00163}00163\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ len(worker\_names)\ ==\ 0:}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00164}00164\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{stringliteral}{"{}"{}}}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00165}00165\ \ \ \ \ \ \ \ \ \ \ \ \ min\_index\ =\ np.argmin(worker\_qlen)}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00166}00166\ \ \ \ \ \ \ \ \ \ \ \ \ w\_name\ =\ worker\_names[min\_index]}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00167}00167\ \ \ \ \ \ \ \ \ \ \ \ \ self.\mbox{\hyperlink{classllava_1_1serve_1_1controller_1_1_controller_aee05cb42d96aeb0f24e6333454a1f666}{worker\_info}}[w\_name].queue\_length\ +=\ 1}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00168}00168\ \ \ \ \ \ \ \ \ \ \ \ \ logger.info(f\textcolor{stringliteral}{"{}names:\ \{worker\_names\},\ queue\_lens:\ \{worker\_qlen\},\ ret:\ \{w\_name\}"{}})}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00169}00169\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ w\_name}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00170}00170\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{else}:}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00171}00171\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{raise}\ ValueError(f\textcolor{stringliteral}{"{}Invalid\ dispatch\ method:\ \{self.dispatch\_method\}"{}})}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00172}00172\ }
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00173}\mbox{\hyperlink{classllava_1_1serve_1_1controller_1_1_controller_a88711f395ef6640bf30e7ea5339d5515}{00173}}\ \ \ \ \ \textcolor{keyword}{def\ }\mbox{\hyperlink{classllava_1_1serve_1_1controller_1_1_controller_a88711f395ef6640bf30e7ea5339d5515}{receive\_heart\_beat}}(self,\ worker\_name:\ str,\ queue\_length:\ int):}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00174}00174\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ worker\_name\ \textcolor{keywordflow}{not}\ \textcolor{keywordflow}{in}\ self.\mbox{\hyperlink{classllava_1_1serve_1_1controller_1_1_controller_aee05cb42d96aeb0f24e6333454a1f666}{worker\_info}}:}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00175}00175\ \ \ \ \ \ \ \ \ \ \ \ \ logger.info(f\textcolor{stringliteral}{"{}Receive\ unknown\ heart\ beat.\ \{worker\_name\}"{}})}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00176}00176\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{False}}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00177}00177\ }
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00178}00178\ \ \ \ \ \ \ \ \ self.\mbox{\hyperlink{classllava_1_1serve_1_1controller_1_1_controller_aee05cb42d96aeb0f24e6333454a1f666}{worker\_info}}[worker\_name].queue\_length\ =\ queue\_length}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00179}00179\ \ \ \ \ \ \ \ \ self.\mbox{\hyperlink{classllava_1_1serve_1_1controller_1_1_controller_aee05cb42d96aeb0f24e6333454a1f666}{worker\_info}}[worker\_name].last\_heart\_beat\ =\ time.time()}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00180}00180\ \ \ \ \ \ \ \ \ logger.info(f\textcolor{stringliteral}{"{}Receive\ heart\ beat.\ \{worker\_name\}"{}})}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00181}00181\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{True}}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00182}00182\ }
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00183}\mbox{\hyperlink{classllava_1_1serve_1_1controller_1_1_controller_aca6579cb53fdc1fef2b0814d2e98bfb6}{00183}}\ \ \ \ \ \textcolor{keyword}{def\ }\mbox{\hyperlink{classllava_1_1serve_1_1controller_1_1_controller_aca6579cb53fdc1fef2b0814d2e98bfb6}{remove\_stable\_workers\_by\_expiration}}(self):}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00184}00184\ \ \ \ \ \ \ \ \ expire\ =\ time.time()\ -\/\ CONTROLLER\_HEART\_BEAT\_EXPIRATION}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00185}00185\ \ \ \ \ \ \ \ \ to\_delete\ =\ []}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00186}00186\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ worker\_name,\ w\_info\ \textcolor{keywordflow}{in}\ self.\mbox{\hyperlink{classllava_1_1serve_1_1controller_1_1_controller_aee05cb42d96aeb0f24e6333454a1f666}{worker\_info}}.items():}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00187}00187\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ w\_info.check\_heart\_beat\ \textcolor{keywordflow}{and}\ w\_info.last\_heart\_beat\ <\ expire:}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00188}00188\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ to\_delete.append(worker\_name)}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00189}00189\ }
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00190}00190\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ worker\_name\ \textcolor{keywordflow}{in}\ to\_delete:}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00191}00191\ \ \ \ \ \ \ \ \ \ \ \ \ self.\mbox{\hyperlink{classllava_1_1serve_1_1controller_1_1_controller_a4eb8b9a3300f8270fb1071422680e88f}{remove\_worker}}(worker\_name)}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00192}00192\ }
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00193}\mbox{\hyperlink{classllava_1_1serve_1_1controller_1_1_controller_a634ce73e2d633f9a19bd291e1cb209b0}{00193}}\ \ \ \ \ \textcolor{keyword}{def\ }\mbox{\hyperlink{classllava_1_1serve_1_1controller_1_1_controller_a634ce73e2d633f9a19bd291e1cb209b0}{worker\_api\_generate\_stream}}(self,\ params):}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00194}00194\ \ \ \ \ \ \ \ \ worker\_addr\ =\ self.\mbox{\hyperlink{classllava_1_1serve_1_1controller_1_1_controller_aa622ce0c111890f7fdbe460bda6b9955}{get\_worker\_address}}(params[\textcolor{stringliteral}{"{}model"{}}])}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00195}00195\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ \textcolor{keywordflow}{not}\ worker\_addr:}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00196}00196\ \ \ \ \ \ \ \ \ \ \ \ \ logger.info(f\textcolor{stringliteral}{"{}no\ worker:\ \{params['model']\}"{}})}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00197}00197\ \ \ \ \ \ \ \ \ \ \ \ \ ret\ =\ \{}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00198}00198\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}text"{}}:\ server\_error\_msg,}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00199}00199\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}error\_code"{}}:\ 2,}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00200}00200\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00201}00201\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{yield}\ json.dumps(ret).encode()\ +\ b\textcolor{stringliteral}{"{}\(\backslash\)0"{}}}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00202}00202\ }
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00203}00203\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{try}:}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00204}00204\ \ \ \ \ \ \ \ \ \ \ \ \ response\ =\ requests.post(worker\_addr\ +\ \textcolor{stringliteral}{"{}/worker\_generate\_stream"{}},}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00205}00205\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ json=params,\ stream=\textcolor{keyword}{True},\ timeout=5)}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00206}00206\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ chunk\ \textcolor{keywordflow}{in}\ response.iter\_lines(decode\_unicode=\textcolor{keyword}{False},\ delimiter=b\textcolor{stringliteral}{"{}\(\backslash\)0"{}}):}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00207}00207\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ chunk:}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00208}00208\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{yield}\ chunk\ +\ b\textcolor{stringliteral}{"{}\(\backslash\)0"{}}}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00209}00209\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{except}\ requests.exceptions.RequestException\ \textcolor{keyword}{as}\ e:}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00210}00210\ \ \ \ \ \ \ \ \ \ \ \ \ logger.info(f\textcolor{stringliteral}{"{}worker\ timeout:\ \{worker\_addr\}"{}})}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00211}00211\ \ \ \ \ \ \ \ \ \ \ \ \ ret\ =\ \{}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00212}00212\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}text"{}}:\ server\_error\_msg,}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00213}00213\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}error\_code"{}}:\ 3,}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00214}00214\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00215}00215\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{yield}\ json.dumps(ret).encode()\ +\ b\textcolor{stringliteral}{"{}\(\backslash\)0"{}}}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00216}00216\ }
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00217}00217\ }
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00218}00218\ \ \ \ \ \textcolor{comment}{\#\ Let\ the\ controller\ act\ as\ a\ worker\ to\ achieve\ hierarchical}}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00219}00219\ \ \ \ \ \textcolor{comment}{\#\ management.\ This\ can\ be\ used\ to\ connect\ isolated\ sub\ networks.}}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00220}\mbox{\hyperlink{classllava_1_1serve_1_1controller_1_1_controller_affd4f032db3ed64e6da06699bb4447de}{00220}}\ \ \ \ \ \textcolor{keyword}{def\ }\mbox{\hyperlink{classllava_1_1serve_1_1controller_1_1_controller_affd4f032db3ed64e6da06699bb4447de}{worker\_api\_get\_status}}(self):}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00221}00221\ \ \ \ \ \ \ \ \ model\_names\ =\ set()}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00222}00222\ \ \ \ \ \ \ \ \ speed\ =\ 0}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00223}00223\ \ \ \ \ \ \ \ \ queue\_length\ =\ 0}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00224}00224\ }
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00225}00225\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ w\_name\ \textcolor{keywordflow}{in}\ self.\mbox{\hyperlink{classllava_1_1serve_1_1controller_1_1_controller_aee05cb42d96aeb0f24e6333454a1f666}{worker\_info}}:}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00226}00226\ \ \ \ \ \ \ \ \ \ \ \ \ worker\_status\ =\ self.\mbox{\hyperlink{classllava_1_1serve_1_1controller_1_1_controller_af02dbb01db45557de6b6318fe5302616}{get\_worker\_status}}(w\_name)}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00227}00227\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ worker\_status\ \textcolor{keywordflow}{is}\ \textcolor{keywordflow}{not}\ \textcolor{keywordtype}{None}:}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00228}00228\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ model\_names.update(worker\_status[\textcolor{stringliteral}{"{}model\_names"{}}])}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00229}00229\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ speed\ +=\ worker\_status[\textcolor{stringliteral}{"{}speed"{}}]}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00230}00230\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ queue\_length\ +=\ worker\_status[\textcolor{stringliteral}{"{}queue\_length"{}}]}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00231}00231\ }
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00232}00232\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \{}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00233}00233\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}model\_names"{}}:\ list(model\_names),}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00234}00234\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}speed"{}}:\ speed,}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00235}00235\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}queue\_length"{}}:\ queue\_length,}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00236}00236\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00237}00237\ }
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00238}00238\ }
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00239}\mbox{\hyperlink{namespacellava_1_1serve_1_1controller_a325568d999ace2e79c0f05715c4b7b32}{00239}}\ app\ =\ FastAPI()}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00240}00240\ }
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00241}00241\ }
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00242}00242\ \textcolor{preprocessor}{@app.post("{}/register\_worker"{})}}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00243}\mbox{\hyperlink{namespacellava_1_1serve_1_1controller_ae78448238bbbb37c20997d7c0930fe60}{00243}}\ \textcolor{keyword}{async\ def\ }register\_worker(request:\ Request):}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00244}00244\ \ \ \ \ data\ =\ await\ request.json()}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00245}00245\ \ \ \ \ controller.register\_worker(}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00246}00246\ \ \ \ \ \ \ \ \ data[\textcolor{stringliteral}{"{}worker\_name"{}}],\ data[\textcolor{stringliteral}{"{}check\_heart\_beat"{}}],}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00247}00247\ \ \ \ \ \ \ \ \ data.get(\textcolor{stringliteral}{"{}worker\_status"{}},\ \textcolor{keywordtype}{None}))}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00248}00248\ }
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00249}00249\ }
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00250}00250\ \textcolor{preprocessor}{@app.post("{}/refresh\_all\_workers"{})}}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00251}\mbox{\hyperlink{namespacellava_1_1serve_1_1controller_a6ea76a06ebebb3f2edcbf57f9f83a486}{00251}}\ \textcolor{keyword}{async\ def\ }\mbox{\hyperlink{namespacellava_1_1serve_1_1controller_a6ea76a06ebebb3f2edcbf57f9f83a486}{refresh\_all\_workers}}():}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00252}00252\ \ \ \ \ models\ =\ controller.refresh\_all\_workers()}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00253}00253\ }
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00254}00254\ }
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00255}00255\ \textcolor{preprocessor}{@app.post("{}/list\_models"{})}}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00256}\mbox{\hyperlink{namespacellava_1_1serve_1_1controller_abb2714d45fa6c6f8d0d1f57d7dc72902}{00256}}\ \textcolor{keyword}{async\ def\ }\mbox{\hyperlink{namespacellava_1_1serve_1_1controller_abb2714d45fa6c6f8d0d1f57d7dc72902}{list\_models}}():}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00257}00257\ \ \ \ \ models\ =\ controller.list\_models()}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00258}00258\ \ \ \ \ \textcolor{keywordflow}{return}\ \{\textcolor{stringliteral}{"{}models"{}}:\ models\}}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00259}00259\ }
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00260}00260\ }
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00261}00261\ \textcolor{preprocessor}{@app.post("{}/get\_worker\_address"{})}}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00262}\mbox{\hyperlink{namespacellava_1_1serve_1_1controller_a3e02aa6314e15c9ed181f8f8b5a22304}{00262}}\ \textcolor{keyword}{async\ def\ }\mbox{\hyperlink{namespacellava_1_1serve_1_1controller_a3e02aa6314e15c9ed181f8f8b5a22304}{get\_worker\_address}}(request:\ Request):}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00263}00263\ \ \ \ \ data\ =\ await\ request.json()}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00264}00264\ \ \ \ \ addr\ =\ controller.get\_worker\_address(data[\textcolor{stringliteral}{"{}model"{}}])}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00265}00265\ \ \ \ \ \textcolor{keywordflow}{return}\ \{\textcolor{stringliteral}{"{}address"{}}:\ addr\}}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00266}00266\ }
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00267}00267\ }
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00268}00268\ \textcolor{preprocessor}{@app.post("{}/receive\_heart\_beat"{})}}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00269}\mbox{\hyperlink{namespacellava_1_1serve_1_1controller_aa9f8b94cf1842b21264bf80c2d13a0a4}{00269}}\ \textcolor{keyword}{async\ def\ }\mbox{\hyperlink{namespacellava_1_1serve_1_1controller_aa9f8b94cf1842b21264bf80c2d13a0a4}{receive\_heart\_beat}}(request:\ Request):}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00270}00270\ \ \ \ \ data\ =\ await\ request.json()}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00271}00271\ \ \ \ \ exist\ =\ controller.receive\_heart\_beat(}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00272}00272\ \ \ \ \ \ \ \ \ data[\textcolor{stringliteral}{"{}worker\_name"{}}],\ data[\textcolor{stringliteral}{"{}queue\_length"{}}])}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00273}00273\ \ \ \ \ \textcolor{keywordflow}{return}\ \{\textcolor{stringliteral}{"{}exist"{}}:\ exist\}}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00274}00274\ }
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00275}00275\ }
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00276}00276\ \textcolor{preprocessor}{@app.post("{}/worker\_generate\_stream"{})}}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00277}\mbox{\hyperlink{namespacellava_1_1serve_1_1controller_ae92ab99cdad3fd93ef86261b0595a144}{00277}}\ \textcolor{keyword}{async\ def\ }\mbox{\hyperlink{namespacellava_1_1serve_1_1controller_ae92ab99cdad3fd93ef86261b0595a144}{worker\_api\_generate\_stream}}(request:\ Request):}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00278}00278\ \ \ \ \ params\ =\ await\ request.json()}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00279}00279\ \ \ \ \ generator\ =\ controller.worker\_api\_generate\_stream(params)}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00280}00280\ \ \ \ \ \textcolor{keywordflow}{return}\ StreamingResponse(generator)}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00281}00281\ }
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00282}00282\ }
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00283}00283\ \textcolor{preprocessor}{@app.post("{}/worker\_get\_status"{})}}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00284}\mbox{\hyperlink{namespacellava_1_1serve_1_1controller_a3b731a22596a47b06d499a744654ea58}{00284}}\ \textcolor{keyword}{async\ def\ }\mbox{\hyperlink{namespacellava_1_1serve_1_1controller_a3b731a22596a47b06d499a744654ea58}{worker\_api\_get\_status}}(request:\ Request):}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00285}00285\ \ \ \ \ \textcolor{keywordflow}{return}\ controller.worker\_api\_get\_status()}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00286}00286\ }
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00287}00287\ }
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00288}00288\ \textcolor{keywordflow}{if}\ \_\_name\_\_\ ==\ \textcolor{stringliteral}{"{}\_\_main\_\_"{}}:}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00289}\mbox{\hyperlink{namespacellava_1_1serve_1_1controller_aee7f3986858a2793c37a04b9106980c7}{00289}}\ \ \ \ \ parser\ =\ argparse.ArgumentParser()}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00290}\mbox{\hyperlink{namespacellava_1_1serve_1_1controller_abd6af291cf4a08b37f1dbd4003906309}{00290}}\ \ \ \ \ parser.add\_argument(\textcolor{stringliteral}{"{}-\/-\/host"{}},\ type=str,\ default=\textcolor{stringliteral}{"{}localhost"{}})}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00291}\mbox{\hyperlink{namespacellava_1_1serve_1_1controller_ac2a4602a2b31141946e71588586436c7}{00291}}\ \ \ \ \ parser.add\_argument(\textcolor{stringliteral}{"{}-\/-\/port"{}},\ type=int,\ default=21001)}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00292}\mbox{\hyperlink{namespacellava_1_1serve_1_1controller_aa8edcd7689c7d9db7003be106d7d1953}{00292}}\ \ \ \ \ parser.add\_argument(\textcolor{stringliteral}{"{}-\/-\/dispatch-\/method"{}},\ type=str,\ choices=[}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00293}00293\ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}lottery"{}},\ \textcolor{stringliteral}{"{}shortest\_queue"{}}],\ default=\textcolor{stringliteral}{"{}shortest\_queue"{}})}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00294}\mbox{\hyperlink{namespacellava_1_1serve_1_1controller_aa515c4ca860dd4e3e18db610fd6cf153}{00294}}\ \ \ \ \ args\ =\ parser.parse\_args()}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00295}00295\ \ \ \ \ logger.info(f\textcolor{stringliteral}{"{}args:\ \{args\}"{}})}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00296}00296\ }
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00297}\mbox{\hyperlink{namespacellava_1_1serve_1_1controller_ac61684ec6dad5426df2b50821613556e}{00297}}\ \ \ \ \ controller\ =\ \mbox{\hyperlink{classllava_1_1serve_1_1controller_1_1_controller}{Controller}}(args.dispatch\_method)}
\DoxyCodeLine{\Hypertarget{controller_8py_source_l00298}\mbox{\hyperlink{namespacellava_1_1serve_1_1controller_ad6ef82d52bdb5b34438cee20dcf274ce}{00298}}\ \ \ \ \ uvicorn.run(app,\ host=args.host,\ port=args.port,\ log\_level=\textcolor{stringliteral}{"{}info"{}})}

\end{DoxyCode}
